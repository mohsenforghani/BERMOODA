<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>بازی - Mohsen Forghani</title>
<style>
  html,body { height:100%; margin:0; padding:0; background:#000; font-family: Tahoma, Verdana, sans-serif; -webkit-user-select:none; -ms-user-select:none; user-select:none; }
  #gameWrap { position:fixed; inset:0; display:flex; flex-direction:column; }
  canvas { display:block; width:100%; height:100%; background:#000; touch-action:none; }
  #overlay { position:absolute; inset:0; pointer-events:none; }
  #ui { position:absolute; inset:0; display:flex; justify-content:center; align-items:flex-end; pointer-events:none; }
  /* start button */
  #startBtn { position:absolute; left:50%; transform:translateX(-50%); bottom:18vh; width:70vw; max-width:600px; padding:18px; font-size:36px; border-radius:12px; background:yellow; color:#000; border:0; box-shadow:0 6px 14px rgba(0,0,0,.4); pointer-events:auto; }
  #scorePanel { position:absolute; right:12px; top:12px; color:#fff; font-size:18px; text-align:right; text-shadow:0 1px 3px rgba(0,0,0,.6); }
  #author { position:absolute; right:12px; bottom:12px; color:#f66; font-size:14px; text-shadow:0 1px 2px rgba(0,0,0,.6); pointer-events:none; }

  /* controls */
  .controls { position:absolute; bottom:10px; width:100%; pointer-events:none; display:flex; justify-content:space-between; padding:0 10px; box-sizing:border-box; }
  .left-controls, .right-controls { pointer-events:auto; display:flex; gap:12px; align-items:center; }
  /* shoot button (left) */
  #shootBtn { width:86px; height:86px; border-radius:50%; background:linear-gradient(180deg,#ff6 0%, #f00 100%); border:6px solid rgba(255,255,255,0.08); font-size:28px; color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.5); }
  /* directional pad (right) */
  .dpad { width:180px; height:140px; display:grid; grid-template-columns:1fr 1fr 1fr; grid-template-rows:1fr 1fr 1fr; gap:6px; }
  .dpad button { border-radius:10px; border:0; background:rgba(255,255,255,0.06); color:#fff; font-size:18px; height:44px; width:44px; box-shadow: inset 0 -2px 0 rgba(0,0,0,.4); }
  .dpad .hidden { visibility:hidden; background:transparent; box-shadow:none; }

  /* small helper for responsive */
  @media (max-width:420px){
    #startBtn { font-size:28px; width:84vw; bottom:16vh; }
    .dpad { width:140px; height:120px; }
    #shootBtn { width:78px; height:78px; }
  }

</style>
</head>
<body>
<div id="gameWrap">
  <canvas id="gameCanvas"></canvas>

  <div id="overlay">
    <div id="scorePanel">Score: <span id="score">0</span><br>Best: <span id="best">0</span></div>
    <div id="author">a Game by Mohsen Forghani</div>

    <button id="startBtn">شروع بازی</button>

    <div class="controls" aria-hidden="false">
      <div class="left-controls">
        <button id="shootBtn">شلیک</button>
      </div>

      <div class="right-controls">
        <div class="dpad" role="group" aria-label="دکمه‌های جهت">
          <div></div><button id="upBtn">▲</button><div></div>
          <button id="leftBtn">◀</button><button class="hidden"></button><button id="rightBtn">▶</button>
          <div></div><button id="downBtn">▼</button><div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* === تنظیمات و متغیرها (ترجمه از VB.NET) === */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W = window.innerWidth;
let H = window.innerHeight;
function resize() {
  W = window.innerWidth;
  H = window.innerHeight;
  canvas.width = W;
  canvas.height = H;
}
resize();
window.addEventListener('resize', resize);

/* تصاویر و صدا */
const airplaneImage = new Image();
airplaneImage.src = 'airplane.png'; // قرار بدید کنار index.html
const shootSound = new Audio('shelik.wav'); // قرار بدید کنار index.html

/* هواپیما */
let airplaneWidth = 80;
let airplaneHeight = 80;
let airplaneX = W/2 - airplaneWidth/2;
let airplaneY = H - airplaneHeight - 10;

/* گلوله‌ها */
let bullets = []; // هر گلوله: {x,y,w,h}
let bulletSpeed = 8;
let minintervalshooting = 10; // حداقل اینتروال در ms

/* دشمنان (دایره) */
class Circle { constructor(x,y){ this.x = x; this.y = y; } }
let circles = [];
let circleRadius = 10;
let circleSpeedY = 1;

/* ذرات */
class Particle { constructor(x,y,sx,sy){ this.x=x; this.y=y; this.sx=sx; this.sy=sy; this.life=50; } }
let particles = [];

/* دایره نارنجی */
let orangesize = 10;
let maxsize = 5000;
let orangeCircle = { x: W, y: Math.random()*(H-200)+100, w: orangesize, h: orangesize };
let orangeCircleSpeed = 20;
let isvisibleNarenji = true;

/* امتیاز و رکورد */
let score = 0;
let bestScore = 0;
let bestPlayer = 'ناشناخته';
let isNameEntered = false;

/* وضعیت بازی */
let isShooting = false;
let isGameOver = false;
let shootInterval = 10; // میلی‌ثانیه — معادل shootTimer.Interval
let lastShootTime = 0;

/* UI refs */
const startBtn = document.getElementById('startBtn');
const scoreSpan = document.getElementById('score');
const bestSpan = document.getElementById('best');

/* کنترل‌های لمسی */
const shootBtn = document.getElementById('shootBtn');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const upBtn = document.getElementById('upBtn');
const downBtn = document.getElementById('downBtn');
let controlState = { left:false, right:false, up:false, down:false };

/* بازیابی بهترین رکورد از localStorage */
function loadBest() {
  const data = JSON.parse(localStorage.getItem('mg_scores') || '[]');
  if (data.length>0) {
    let best = data.reduce((a,b)=> a.score>b.score?a:b, data[0]);
    bestScore = best.score;
    bestPlayer = best.name || 'ناشناخته';
  } else {
    bestScore = 0; bestPlayer = 'ناشناخته';
  }
  bestSpan.textContent = bestScore;
}
loadBest();

/* ذخیره امتیاز */
function saveScoreToStorage(name, sc) {
  const arr = JSON.parse(localStorage.getItem('mg_scores') || '[]');
  arr.push({ name: name||'ناشناخته', score: sc, date: new Date().toISOString() });
  localStorage.setItem('mg_scores', JSON.stringify(arr));
  loadBest();
}

/* Reset game */
function ResetGame(){
  isGameOver = false;
  score = 0;
  bullets = [];
  circles = [];
  particles = [];
  shootInterval = 10;
  airplaneX = W/2 - airplaneWidth/2;
  airplaneY = H - airplaneHeight - 10;
  loadBest();
  startBtn.style.display = 'none';
  // position orange on right
  orangesize = 10;
  orangeCircle = { x: W, y: Math.random()*(H-200)+100, w: orangesize, h: orangesize };
}

/* Mouse / Touch movement for airplane (desktop) */
let pointerActive = false;
canvas.addEventListener('mousemove', (e)=>{
  if (!isGameOver && !isMobileTouchActive) {
    airplaneX = e.clientX - airplaneWidth/2;
    airplaneY = e.clientY - airplaneHeight/2;
  }
});

/* Touch controls for moving airplane by drag on canvas */
let isMobileTouchActive = false;
canvas.addEventListener('touchstart', (ev)=>{
  isMobileTouchActive = true;
  const t = ev.touches[0];
  airplaneX = t.clientX - airplaneWidth/2;
  airplaneY = t.clientY - airplaneHeight/2;
  ev.preventDefault();
});
canvas.addEventListener('touchmove', (ev)=>{
  const t = ev.touches[0];
  airplaneX = t.clientX - airplaneWidth/2;
  airplaneY = t.clientY - airplaneHeight/2;
  ev.preventDefault();
});
canvas.addEventListener('touchend', (ev)=>{
  setTimeout(()=> isMobileTouchActive = false, 20);
});

/* Start / Restart */
startBtn.addEventListener('click', ()=> {
  ResetGame();
  startLoop();
});

/* Shoot button handlers */
let shootBtnPressed = false;
function startShooting() { isShooting = true; shootBtnPressed = true; }
function stopShooting() { isShooting = false; shootBtnPressed = false; }
shootBtn.addEventListener('touchstart', (e)=>{ startShooting(); e.preventDefault(); });
shootBtn.addEventListener('touchend', (e)=>{ stopShooting(); e.preventDefault(); });
shootBtn.addEventListener('mousedown', (e)=>{ startShooting(); e.preventDefault(); });
shootBtn.addEventListener('mouseup', (e)=>{ stopShooting(); e.preventDefault(); });

/* Directional buttons */
function dirDown(id){ controlState[id]=true; }
function dirUp(id){ controlState[id]=false; }

leftBtn.addEventListener('touchstart', ()=>dirDown('left')); leftBtn.addEventListener('touchend', ()=>dirUp('left'));
rightBtn.addEventListener('touchstart', ()=>dirDown('right')); rightBtn.addEventListener('touchend', ()=>dirUp('right'));
upBtn.addEventListener('touchstart', ()=>dirDown('up')); upBtn.addEventListener('touchend', ()=>dirUp('up'));
downBtn.addEventListener('touchstart', ()=>dirDown('down')); downBtn.addEventListener('touchend', ()=>dirUp('down'));
leftBtn.addEventListener('mousedown', ()=>dirDown('left')); leftBtn.addEventListener('mouseup', ()=>dirUp('left'));
rightBtn.addEventListener('mousedown', ()=>dirDown('right')); rightBtn.addEventListener('mouseup', ()=>dirUp('right'));
upBtn.addEventListener('mousedown', ()=>dirDown('up')); upBtn.addEventListener('mouseup', ()=>dirUp('up'));
downBtn.addEventListener('mousedown', ()=>dirDown('down')); downBtn.addEventListener('mouseup', ()=>dirUp('down'));

/* Keyboard support */
window.addEventListener('keydown', (e)=>{
  if (e.key === 'ArrowLeft') controlState.left = true;
  if (e.key === 'ArrowRight') controlState.right = true;
  if (e.key === 'ArrowUp') controlState.up = true;
  if (e.key === 'ArrowDown') controlState.down = true;
  if (e.key === ' ' || e.key === 'z') isShooting = true;
});
window.addEventListener('keyup', (e)=>{
  if (e.key === 'ArrowLeft') controlState.left = false;
  if (e.key === 'ArrowRight') controlState.right = false;
  if (e.key === 'ArrowUp') controlState.up = false;
  if (e.key === 'ArrowDown') controlState.down = false;
  if (e.key === ' ' || e.key === 'z') isShooting = false;
});

/* Helper random int */
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

/* ShootBullet (معادل VB.NET) */
function ShootBulletNow(){
  // replicate VB thresholds; use airplaneX, airplaneY, airplaneWidth
  const cx = Math.round(airplaneX + airplaneWidth/2);
  if (score >= 0 && score <= 10000) {
    bullets.push({ x: cx, y: airplaneY, w:3, h:6 });
    circleSpeedY = 1;
  } else if (score > 10000 && score <= 20000) {
    bullets.push({ x: cx - 40, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx + 40, y: airplaneY + 50, w:2, h:5 });
    circleSpeedY = 2;
  } else if (score > 20000 && score <= 30000) {
    bullets.push({ x: cx - 40, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx, y: airplaneY, w:3, h:7 });
    bullets.push({ x: cx + 40, y: airplaneY + 50, w:2, h:5 });
    circleSpeedY = 3;
  } else if (score > 30000 && score <= 40000) {
    bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 });
    bullets.push({ x: cx, y: airplaneY, w:3, h:7 });
    bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 });
    circleSpeedY = 4;
  } else if (score > 40000 && score <= 50000) {
    bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 });
    bullets.push({ x: cx, y: airplaneY, w:3, h:7 });
    bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 });
    bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 });
    circleSpeedY = 5;
  } else if (score > 50000 && score <= 60000) { circleSpeedY = 6; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 60000 && score <= 70000) { circleSpeedY = 7; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 70000 && score <= 80000) { circleSpeedY = 8; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 80000 && score <= 90000) { circleSpeedY = 9; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 90000 && score <= 100000) { circleSpeedY = 10; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 100000 && score <= 120000) { circleSpeedY = 13; bullets.push({ x: cx - 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx - 60, y: airplaneY + 50, w:3, h:7 }); bullets.push({ x: cx, y: airplaneY, w:3, h:7 }); bullets.push({ x: cx + 30, y: airplaneY + 50, w:2, h:5 }); bullets.push({ x: cx + 60, y: airplaneY + 50, w:3, h:7 }); }
  else if (score > 120000 && score <= 140000) { circleSpeedY = 17; bullets.push(
