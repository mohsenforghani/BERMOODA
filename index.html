<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bermooda - Mohsen Forghani</title>
<style>
  html,body {
    margin: 0;
    display: flex;
    padding: 0;
    overflow: hidden;
    background: black;
    touch-action: none;
    justify-content: center; /* وسط افقی */
    align-items: center;     /* وسط عمودی */
  }


  /* صفحه لودینگ */
  #loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, #000, #111);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    z-index: 1000;
    transform: translateY(-80px); /* بالا بردن کل محتوا 80px */
  }

  #loadingText {
    font-size: 22px;
    margin-bottom: 15px;
  }

  #progressBar {
    width: 60%;
    height: 12px;
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
    background: #222;
  }

  #progressFill {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00ff88, #00ffff);
    border-radius: 8px;
    transition: width 0.2s ease;
  }

#logoText {
  font-size: 50px;
  font-weight: bold;
  color: #00ffcc;
  margin-bottom: 40px;
  font-family: 'Arial Black', sans-serif;
  text-shadow:
    0 0 5px #00ffcc,
    0 0 10px #00ffcc,
    0 0 20px #00ffff,
    0 0 30px #00ffff;
  animation: glow 1.5s ease-in-out infinite alternate;
}

#subLogoText {
  font-size: 15px;
  color: #00ffcc;
  font-family: 'Arial', sans-serif;
  text-shadow: 0 0 3px #00ffcc, 0 0 5px #00ffff;
  margin-bottom: 30px; /* فاصله از BERMOODA */
 // animation: glow 1.5s ease-in-out infinite alternate;
}

@keyframes glow {
  0% {
    text-shadow:
      0 0 5px #00ffcc,
      0 0 10px #00ffcc,
      0 0 20px #00ffff,
      0 0 30px #00ffff;
    transform: scale(1);
  }
  100% {
    text-shadow:
      0 0 10px #00ffcc,
      0 0 20px #00ffcc,
      0 0 40px #00ffff,
      0 0 60px #00ffff;
    transform: scale(1.2);
  }
}



#startBtn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;           /* تقریباً کل عرض صفحه */
  font-size: 30px;
  padding: 20px 0;
  background: black;
  color: #00ffcc;
  border: 2px solid #00ffcc;
  border-radius: 15px;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
  text-shadow:
    0 0 5px #00ffcc,
    0 0 10px #00ffcc,
    0 0 20px #00ffff,
    0 0 30px #00ffff;
  animation: glow 1.5s ease-in-out infinite alternate;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  z-index: 10;
}

#startBtn:hover {
  transform: translate(-50%, -50%) scale(1.05);
  box-shadow: 0 0 20px #00ffcc, 0 0 40px #00ffff;
}

  #creatorName {
    position: absolute;
    bottom: 10px;
    right: 10px;
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    font-style: italic;
    pointer-events: none;
    z-index: 10;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    font-family: Arial, sans-serif;
  }

  /* 🎮 جوی‌استیک */
  #joystick {
    position: absolute;
    bottom: 30px;
    right: 20px;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.1);
    border: 3px solid rgba(255,255,255,0.4);
    border-radius: 50%;
  }

  #stick {
    position: absolute;
    width: 30px;
    height:30px;
    background: orange;
    border-radius: 50%;
    top: 25px;
    left: 25px;
    transition: 0.05s;
  }

  #shoot {
    position: absolute;
    bottom: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    color: white;
    font-size: 25px;
    text-align: center;
    line-height: 50px;
    user-select: none;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<button id="startBtn">شروع بازی</button>
<div id="creatorName">Created by Mohsen Forghani</div>
<button id="missileBtn" style="position:absolute; bottom:90px; left:20px; width:60px; height:40px; background:gray; color:white; border-radius:10px; font-weight:bold;" disabled>🚀</button>


<!-- 🎮 کنترل‌ها -->
<div id="joystick">
  <div id="stick"></div>
</div>
<div id="shoot">🔥</div>

 <div id="loadingScreen">
<div id="logoText">BERMOODA</div>
<div id="subLogoText">A GAME BY MOHSEN</div>
    <div id="loadingText">Loading...</div>
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
  </div>


<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let airplane = { x: canvas.width / 2, y: canvas.height - 120, w: 80, h: 80 };
let bullets = [];
let enemies = [];
let score = 0;
let gameRunning = false;
let dx = 0, dy = 0; 
let explosionRunning = false;
let fuel = 100; // مقدار سوخت بین 0 تا 100
let lastFuelSpawn = Date.now();
let fuels = [];
let lastShotTime = 0;
const shootDelay = 110; // هر 110میلی‌ثانیه یک گلوله
let explosions = []; // انفجارها
let lastTime = performance.now();
// در ابتدای فایل
let refueling = false; // آیا سوختگیری در حال انجام است؟
let refuelRate = 0.2; // میزان سوخت در هر فریم هنگام سوختگیری
const explosionImg = new Image();
explosionImg.src = "explosion.png"; // مسیر تصویر انفجار
let enemyBullets = [];
let bulletSpeed = 10; // مقدار اولیه
const noFlyZoneHeight = 100; // ارتفاع ناحیه غیرقابل استفاده پایین صفحه
const missileImages = [
  "mooshak.png",
  "mooshak2.png",
  //"mooshak3.png",
  //"mooshak4.png"
].map(src => {
  const img = new Image();
  img.src = src;
  return img;
});


let missiles = 0; // تعداد موشک‌ها
let activeMissiles = []; // لیست موشک‌های فعال در حال حرکت
let missileBtn = document.getElementById("missileBtn");
// ✅ لیست تمام تصاویر
const imageSources = [
  "airplane.png",
  "explosion.png",
  "fuel.png",
  "mooshak.png", 
"mooshak2.png", 
  "plane1.png", "plane2.png", "plane3.png", "plane4.png",
  "plane6.png", "plane8.png", "plane10.png", "plane12.png",
  "cloud1.png", "cloud2.png", "cloud3.png"
];

let loadedImages = {};
let loadedCount = 0;
const totalImages = imageSources.length;
const loadingText = document.getElementById("loadingText");
const progressFill = document.getElementById("progressFill");
const loadingScreen = document.getElementById("loadingScreen");



let keys = {
  left: false,
  right: false,
  up: false,
  down: false,
  space: false
};


const airplaneImg = new Image();
airplaneImg.src = "airplane.png"; 
// ✈️ تصاویر دشمن‌ها
const enemyImages = [
  "plane1.png",
  "plane2.png",
  "plane3.png",
  "plane4.png",
  "plane6.png",
  "plane8.png",
  "plane10.png",
  "plane12.png",
].map(src => {
  const img = new Image();
  img.src = src;
  return img;
});



let shootInterval = null;
const shootBtn = document.getElementById("shoot");







  // 🎨 پس‌زمینه متحرک آسمان
let clouds = [];
const cloudImages = ["cloud1.png", "cloud2.png", "cloud3.png"].map(src => {
  const img = new Image();
  img.src = src;
  return img;
});

// ساخت چند ابر با موقعیت تصادفی
for (let i = 0; i < 6; i++) {
  clouds.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    speed: 0.2 + Math.random() * 0.5,
    img: cloudImages[Math.floor(Math.random() * cloudImages.length)],
    size: 60 + Math.random() * 100
  });
}



function preloadImages(callback) {
  imageSources.forEach(src => {
    const img = new Image();
    img.onload = () => {
      loadedImages[src] = img;
      loadedCount++;
      const percent = Math.floor((loadedCount / totalImages) * 100);
      progressFill.style.width = percent + "%";
      loadingText.innerText = `Loading  ${percent} %`;
      if (loadedCount === totalImages) {
        setTimeout(() => {
          callback();
        }, 400); // کمی تاخیر برای دیدن پر شدن نوار
      }
    };
    img.onerror = () => {
      console.warn("خطا در لود تصویر:", src);
      loadedCount++;
      if (loadedCount === totalImages) callback();
    };
    img.src = src;
  });
}

// ✅ وقتی همه تصاویر لود شدن:
preloadImages(() => {
  //loadingText.innerText = "ماموریت ...نابودی ناوگان هوایی اسرائیل!";
  progressFill.style.width = "100%";

  setTimeout(() => {
    loadingScreen.style.opacity = 0;
    loadingScreen.style.transition = "opacity 0.8s ease";
    setTimeout(() => {
      loadingScreen.remove();
      startBtn.style.display = "block";
    }, 800);
  }, 700);
});

startBtn.onclick = () => {
  startBtn.style.display = "none";
  startGame();
};





// این بخش رو در ابتدای تابع gameLoop قرار بده:
function drawBackground() {
  // آسمان گرادیانی
  const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  grad.addColorStop(0, "#4da6ff"); // آبی روشن بالا
  grad.addColorStop(1, "#003366"); // آبی تیره پایین
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // حرکت و رسم ابرها
  clouds.forEach(c => {
    c.y += c.speed;
    if (c.y > canvas.height + 100) {
      c.y = -100;
      c.x = Math.random() * canvas.width;
    }
    ctx.globalAlpha = 0.5; // شفافیت ابر
    ctx.drawImage(c.img, c.x, c.y, c.size, c.size * 0.6);
    ctx.globalAlpha = 1;
  });
}


document.addEventListener("keydown", (e) => {
  if (!gameRunning) return;
  switch (e.code) {
    case "ArrowLeft": keys.left = true; break;
    case "ArrowRight": keys.right = true; break;
    case "ArrowUp": keys.up = true; break;
    case "ArrowDown": keys.down = true; break;
    case "Space": keys.space = true; break;
  }
});

document.addEventListener("keyup", (e) => {
  switch (e.code) {
    case "ArrowLeft": keys.left = false; break;
    case "ArrowRight": keys.right = false; break;
    case "ArrowUp": keys.up = false; break;
    case "ArrowDown": keys.down = false; break;
    case "Space": keys.space = false; break;
  }
});





  
// === حلقه بازی ===
function gameLoop() {
  if (!gameRunning) return;
  

const now = performance.now();
  const delta = (now - lastTime) / 16.67; // نسبت به 60fps استاندارد
  lastTime = now;


  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  airplane.x += dx * 4;
  airplane.y += dy * 4;
  airplane.x = Math.max(0, Math.min(canvas.width - airplane.w, airplane.x));
  airplane.y = Math.max(0, Math.min(canvas.height - airplane.h, airplane.y));

  ctx.drawImage(airplaneImg, airplane.x, airplane.y, airplane.w, airplane.h);


// 🔫 رسم گلوله‌ها
bullets.forEach((b, i) => {
  if (score > 200) bulletSpeed = 12;
if (score > 400) bulletSpeed = 15;
if (score > 800) bulletSpeed = 18;

b.y -= bulletSpeed;
  ctx.fillStyle = "yellow";
  ctx.fillRect(b.x - 2, b.y, 3, 7);
  if (b.y < 0) bullets.splice(i, 1);
});





for (let i = activeMissiles.length - 1; i >= 0; i--) {
  let m = activeMissiles[i];

  // ذخیره موقعیت قبلی برای محاسبه زاویه
  m.prevX = m.x;
  m.prevY = m.y;

  // حرکت عمودی و سینوسی
  m.y -= m.speed;
  m.angle += 0.05;
  m.x = m.baseX + Math.sin(m.angle) * m.amplitude; 

  // زاویه موشک نسبت به مسیر حرکت
  let dx = m.x - m.prevX;
  let dy = m.y - m.prevY;
  let rotation = Math.atan2(dy, dx) - Math.PI/2;

  // رسم موشک با چرخش
  ctx.save();
  ctx.translate(m.x + m.w/2, m.y + m.h/2);
  ctx.rotate(rotation);
  ctx.drawImage(m.img, -m.w/2, -m.h/2, m.w, m.h);
  ctx.restore();

  // بررسی برخورد موشک با تمام دشمنان
  for (let j = enemies.length - 1; j >= 0; j--) {
    let e = enemies[j];
    if (
      m.x + m.w/2 > e.x - e.w/2 &&
      m.x - m.w/2 < e.x + e.w/2 &&
      m.y + m.h/2 > e.y - e.h/2 &&
      m.y - m.h/2 < e.y + e.h/2
    ) {
      // انفجار موشک
      createExplosion(m.x + m.w/2, m.y + m.h/2, m.w, m.h);

      // انفجار دشمن
      createExplosion(e.x, e.y, e.w, e.h);

      // حذف دشمن و موشک
      enemies.splice(j, 1);
      activeMissiles.splice(i, 1);

      // حذف تمام تیرهای دشمن
      enemyBullets = [];

      break; // خروج از حلقه دشمنان
    }
  }

  // اگر موشک نزدیک بالای صفحه شد (100 پیکسل قبل از خروج)
  if (m.y + m.h < 140) {
    // انفجار موشک
    createExplosion(m.x + m.w/2, m.y + m.h/2, 200, 200);

    // انفجار همه دشمنان
    enemies.forEach(e => createExplosion(e.x, e.y, e.w, e.h));

    // حذف تمام دشمنان و تیرهایشان
    enemies = [];
    enemyBullets = [];

    // حذف موشک
    activeMissiles.splice(i, 1);
  }
}







 if (keys.left) airplane.x -= 5;
if (keys.right) airplane.x += 5;
if (keys.up) airplane.y -= 5;
if (keys.down) airplane.y += 5;

// محدود کردن محدوده حرکت
if (airplane.x < 0) airplane.x = 0;
if (airplane.x + airplane.w > canvas.width)
  airplane.x = canvas.width - airplane.w;
if (airplane.y < 0) airplane.y = 0;
if (airplane.y + airplane.h > canvas.height-noFlyZoneHeight)
  airplane.y = canvas.height - airplane.h-noFlyZoneHeight;




if (Math.random() < 0.015) {
  const padding = 30;
  const enemy = {
    x: Math.random() * (canvas.width - 2 * padding) + padding,
    y: -60,
    w: 60,
    h: 60,
    img: enemyImages[Math.floor(Math.random() * enemyImages.length)],
    canShoot: Math.random() < 0.3,
    lastShotTime: 0,
    shotCount: 0,
    spiral: Math.random() < 0.3,   // 🎯 30% احتمال مارپیچی بودن
    angle: 0,                      // زاویه برای حرکت سینوسی
    amplitude: 60,                 // دامنه انحراف چپ و راست
    speed: 1                       // سرعت حرکت عمودی
  };
  enemies.push(enemy);
}





// تولید سوخت هر 20 ثانیه
if (Date.now() - lastFuelSpawn > 20000) {
  fuels.push({
    x: Math.random() * (canvas.width - 80) + 40,
    y: -50,
    w: 25,
    h: 60
  });
  lastFuelSpawn = Date.now();
}


enemies.forEach((e, i) => {
   ctx.drawImage(e.img, e.x - e.w / 2, e.y - e.h / 2, e.w, e.h);
   if (e.spiral) {
  e.y += e.speed * delta;
  e.angle += 0.05 * delta; // سرعت چرخش موج
  e.x += Math.sin(e.angle) * 3 * delta; // حرکت سینوسی به چپ و راست
} else {
  e.y += e.speed;
}
// 🔹 حذف دشمن وقتی 100 پیکسل تا پایین فاصله دارد
  if (e.y > canvas.height - noFlyZoneHeight) {
    enemies.splice(i, 1);
  }

// شلیک دشمن
  if (e.canShoot) {
    const now = Date.now();
    if (now - e.lastShotTime > 1000 && e.shotCount < 3) { // هر 1 ثانیه یک تیر، حداکثر 3 تیر
      enemyShoot(e);
      e.lastShotTime = now;
      e.shotCount++;
    }
    // بعد از اینکه 3 تیر زد، 3 ثانیه صبر کن و دوباره می‌تونه شلیک کنه
    if (e.shotCount >= 3 && now - e.lastShotTime > 3000) {
      e.shotCount = 0;
    }
  }
enemyBullets.forEach((b, i) => {
 b.y += b.vy * delta;
  ctx.fillStyle = "white";
  ctx.fillRect(b.x - 2, b.y, 3, 7);

  // برخورد با هواپیما
  if (
    airplane.x < b.x && airplane.x + airplane.w > b.x &&
    airplane.y < b.y && airplane.y + airplane.h > b.y
  ) {
    explodeAirplane();
    enemyBullets.splice(i, 1);
  }

  // حذف گلوله اگر از پایین صفحه خارج شد
  if (b.y > canvas.height-noFlyZoneHeight) enemyBullets.splice(i, 1);
});




  // بررسی برخورد گلوله‌ها با دشمن
  bullets.forEach((b, j) => {
    if (
      b.x > e.x - e.w/2 &&
      b.x < e.x + e.w/2 &&
      b.y > e.y - e.h/2 &&
      b.y < e.y + e.h/2
    ) {
      createExplosion(e.x, e.y, e.w, e.h); // انفجار ترکیبی
      enemies.splice(i, 1);
      bullets.splice(j, 1);
      score += 10;


// هر 300 امتیاز یک موشک
let newMissiles = Math.floor(score / 50);
if(newMissiles > missiles) {
  missiles = newMissiles;
  updateMissileBtn(); // متن دکمه بروزرسانی شود
}




    }
  });

  // ✅ بررسی برخورد هواپیما با دشمن
  if (
    airplane.x < e.x + e.w / 2 &&
    airplane.x + airplane.w > e.x - e.w / 2 &&
    airplane.y < e.y + e.h / 2 &&
    airplane.y + airplane.h > e.y - e.h / 2
  ) {
 // انفجار هواپیمای دشمن
  createExplosion(e.x, e.y, e.w, e.h);
    explodeAirplane();
    enemies.splice(i, 1);
   // endGame();
  }
});



const fuelImg = new Image();
fuelImg.src = "fuel.png"; // مسیر تصویر پمپ بنزینت

fuels.forEach((f, i) => {
  f.y += 2; // حرکت پایین پمپ

  // رسم تصویر پمپ
  ctx.drawImage(fuelImg, f.x, f.y, f.w, f.h);

  // 🔹 بررسی برخورد هواپیما برای سوختگیری تدریجی
  if (
    airplane.x < f.x + f.w &&
    airplane.x + airplane.w > f.x &&
    airplane.y < f.y + f.h &&
    airplane.y + airplane.h > f.y
  ) {
    // هر فریم سوخت اضافه می‌شود
    fuel += 0.2; // میزان سوختگیری در هر فریم، می‌توان تغییر داد
    if (fuel > 100) fuel = 100;
  }

  // 🔹 بررسی برخورد گلوله با پمپ
  bullets.forEach((b, j) => {
    if (
      b.x > f.x &&
      b.x < f.x + f.w &&
      b.y > f.y &&
      b.y < f.y + f.h
    ) {
      fuels.splice(i, 1); // حذف پمپ
      bullets.splice(j, 1); // حذف گلوله
    }
  });

  // حذف پمپ اگر از پایین خارج شد
  if (f.y > canvas.height) fuels.splice(i, 1);
});




  ctx.fillStyle="white";
  ctx.font="12px Calibri";
  ctx.fillText("Score: "+score, canvas.width-80,20);


fuel -= 0.03; // کاهش تدریجی سوخت
if (fuel < 0) {
  fuel = 0;
  endGame();
}





// نوار سوخت بالای صفحه
let fuelBarWidth = canvas.width * 0.5; // نصف عرض صفحه
let fuelX = (canvas.width - fuelBarWidth) / 2; // وسط صفحه
let fuelY = 15; // فاصله از بالا
let fuelHeight = 8;

// تعیین رنگ بر اساس میزان سوخت
let fuelColor = "lime";
if (fuel < 60) fuelColor = "yellow";
if (fuel < 30) fuelColor = "red";

// زمینه‌ی نوار
ctx.fillStyle = "rgba(255,255,255,0.2)";
ctx.fillRect(fuelX, fuelY, fuelBarWidth, fuelHeight);

// مقدار فعلی سوخت
ctx.fillStyle = fuelColor;
ctx.fillRect(fuelX, fuelY, (fuel / 100) * fuelBarWidth, fuelHeight);

// قاب دور نوار
ctx.strokeStyle = "white";
ctx.lineWidth = 1;
ctx.strokeRect(fuelX, fuelY, fuelBarWidth, fuelHeight);



// 🔫 کنترل شلیک Space در حلقه بازی
if (keys.space) {
  const now = Date.now();
  if (now - lastShotTime > shootDelay) {
    shoot();
    lastShotTime = now;
  }
}
  

for (let i = explosions.length - 1; i >= 0; i--) {
  const ex = explosions[i];

  const scale = 1 + (1 - ex.alpha);
  const w = ex.w * scale;
  const h = ex.h * scale;
  const x = ex.x - (w - ex.w)/2;
  const y = ex.y - (h - ex.h)/2;

  ctx.globalAlpha = ex.alpha;
  ctx.drawImage(explosionImg, x, y, w, h);

  ex.particles.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.w, p.h);
    p.x += p.vx;
    p.y += p.vy;
    p.vx *= 0.9;
    p.vy *= 0.9;
  });

  ctx.globalAlpha = 1;

  ex.alpha -= ex.fadeRate;
  if (ex.alpha <= 0) {
    explosions.splice(i, 1);
    if (ex.callback) ex.callback(); // 🔹 اینجا بازی تمام می‌شه بعد از پایان انفجار
  }
}


  requestAnimationFrame(gameLoop);
}

// === کنترل‌ها ===
function shoot() {
  if(!gameRunning) return;
  bullets.push({x:airplane.x+airplane.w/2,y:airplane.y});
}

function enemyShoot(enemy) {
  enemyBullets.push({
    x: enemy.x,
    y: enemy.y + enemy.h / 2,
    vx: 0,
    vy: 2
  });
}

function updateMissileBtn() {
  missileBtn.innerText = `🚀 ${missiles}`;
  missileBtn.disabled = missiles <= 0;
}

function launchMissile() {
  if (missiles <= 0 || !gameRunning) return;
  missiles--;
  updateMissileBtn();
  enemyBullets = [];

// 🎯 انتخاب تصادفی بین مدل‌های مختلف موشک
const missileImage = missileImages[Math.floor(Math.random() * missileImages.length)];


  activeMissiles.push({
    x: airplane.x + airplane.w / 2 - 10,
    y: airplane.y - 10,
    w: 20,
    h: 70,
    speed: 4,
    angle: 0,
    amplitude: 50,
    prevX: airplane.x + airplane.w / 2 - 10,
    prevY: airplane.y - 10,
    baseX: airplane.x + airplane.w / 2 - 10,
    img: missileImage // ✅ ذخیره تصویر تصادفی
  });
}








function startGame() {
  if (explosionRunning) return; // جلوگیری از شروع بازی قبل از پایان انفجار
  score = 0;
  fuel = 100;
  bulletSpeed = 10;
  airplane.x = canvas.width / 2 - 40;
  airplane.y = canvas.height - 120;
  enemies = [];
  bullets = [];
  fuels = []; // پاک کردن سوخت‌های باقی‌مانده
  enemyBullets = []; // ✅ پاک کردن تمام تیرهای دشمن
  lastFuelSpawn = Date.now(); // ریست تایمر تولید سوخت
  missiles = 0;              // ← تعداد موشک‌ها صفر
  updateMissileBtn();        // ← بروزرسانی دکمه
  gameRunning = true;
  document.getElementById("startBtn").style.display = "none";
  requestAnimationFrame(gameLoop);
}

function endGame() {
  gameRunning = false;

  // پاک کردن صفحه قبل از نمایش متن
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ذخیره وضعیت قبلی
  ctx.save();

  // تنظیم متن وسط صفحه
  ctx.fillStyle = "white";
  ctx.font = "40px Times New Roman";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("Game Over", canvas.width / 2, canvas.height / 2.6);

  // بازیابی تنظیمات قبلی (در صورت نیاز)
  ctx.restore();
  explosionRunning = false; 
  // دکمه شروع بعد از 3 ثانیه فعال شود
  const startBtn = document.getElementById("startBtn");
  startBtn.style.display = "none";
  setTimeout(() => {
    startBtn.style.display = "block";
  }, 300);
}




function createExplosion(x, y, w=70, h=70) {
  const particles = [];
  const numParticles = 20; // تعداد ذرات
  for (let i = 0; i < numParticles; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 8,
      vy: (Math.random() - 0.5) * 8,
      w: Math.random() * 6 + 2,
      h: Math.random() * 6 + 2,
      color: ["orange","red","yellow","gray"][Math.floor(Math.random()*4)]
    });
  }

  explosions.push({
    x: x - w/2,
    y: y - h/2,
    w: w,
    h: h,
    alpha: 1,
    fadeRate: 0.03,
    particles: particles
  });

  if (navigator.vibrate) navigator.vibrate(50); // ویبره کوتاه
}





function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas(); // اجرا در ابتدا


function explodeAirplane() {
  if (explosionRunning) return; // جلوگیری از انفجار دوباره
  explosionRunning = true;
  if (navigator.vibrate) navigator.vibrate(200);

  const x = airplane.x + airplane.w/2;
  const y = airplane.y + airplane.h/2;
  const w = airplane.w;
  const h = airplane.h;

  const particles = [];
  const numParticles = 60;
  for (let i = 0; i < numParticles; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 12,
      vy: (Math.random() - 0.5) * 12,
      w: Math.random() * 8 + 2,
      h: Math.random() * 8 + 2,
      color: ["orange","red","yellow","gray"][Math.floor(Math.random()*4)]
    });
  }

  explosions.push({
    x: x - w/2,
    y: y - h/2,
    w: w,
    h: h,
    alpha: 1,
    fadeRate: 0.03,
    particles: particles,
    callback: endGame // 🔹 بعد از انفجار کامل بازی تمام شود
  });

  // پنهان کردن هواپیما هنگام انفجار
  airplane.x = -1000;
  airplane.y = -1000;
}








// === جوی‌استیک لمسی ===
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let touchId = null;

joystick.addEventListener("touchstart", e=>{
  if(touchId!==null) return;
  const touch=[...e.touches].find(t=>{
    const rect=joystick.getBoundingClientRect();
    return t.clientX>=rect.left && t.clientX<=rect.right &&
           t.clientY>=rect.top && t.clientY<=rect.bottom;
  });
  if(touch) touchId=touch.identifier;
});

joystick.addEventListener("touchmove", e=>{
  if(touchId===null) return;
  let touch=[...e.touches].find(t=>t.identifier===touchId);
  if(!touch) return;
  let rect=joystick.getBoundingClientRect();
  let centerX=rect.left+rect.width/2;
  let centerY=rect.top+rect.height/2;
  let tx=touch.clientX-centerX;
  let ty=touch.clientY-centerY;
  const maxDist=40;
  const distance=Math.sqrt(tx*tx+ty*ty);
  if(distance>maxDist){
    tx=tx*maxDist/distance;
    ty=ty*maxDist/distance;
  }
  stick.style.transform=`translate(${tx}px,${ty}px)`;
  dx=tx/maxDist;
  dy=ty/maxDist;
});

joystick.addEventListener("touchend", e=>{
  const remaining=[...e.touches];
  if(!remaining.find(t=>t.identifier===touchId)){
    stick.style.transform="translate(0,0)";
    dx=0; dy=0; touchId=null;
  }
});

// === شلیک نگه داشتن ===
shootBtn.addEventListener("touchstart", e=>{
  if(!gameRunning) return;
  shoot(); 
  shootInterval=setInterval(shoot,110);
});
shootBtn.addEventListener("touchend", e=>{
  clearInterval(shootInterval);
});



// === دکمه‌ها ===
function addTouchAndClick(id, handler){
  const el=document.getElementById(id);
  el.addEventListener("click",handler);
  el.addEventListener("touchstart",e=>{e.preventDefault(); handler();});
}

addTouchAndClick("startBtn",startGame);
addTouchAndClick("shoot",shoot);
addTouchAndClick("missileBtn", launchMissile);
window.addEventListener("resize",()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
});
</script>

</body>
</html>











