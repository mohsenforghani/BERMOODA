<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Bermooda - Mohsen Forghani</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
    height: 100%;
    touch-action: none;
    user-select: none;
   -webkit-user-select: none;
  }

  canvas {
    z-index: -1;
    display: block;
    background: black;
  }

#controlPanel {
  position: fixed;
  bottom: 0;
  width: 101%;
  height: 140px; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø¨Ø§Ù„Ø§ ØªØ§ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ */
  border-radius: 30px;
  pointer-events: none;
  z-index: 0;
  background: transparent;
  box-sizing: border-box;
  border: 3px solid transparent;
  background-clip: padding-box; /* ØªØ§ Ø­Ø§Ø´ÛŒÙ‡ Ø§Ø² Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¬Ø¯Ø§ Ø¨Ø§Ø´Ø¯ */
  display: none;
}

#controlPanel::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 20px;
  border: 3px solid;
  border-color: rgba(128,128,128,1);
  background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0));
  pointer-events: none;
}

#playernameDisplay {
  position: fixed;
  font-size: 12px;
  z-index: 10;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  pointer-events: none;
  top: 2%;
  left: 10px;
  color: black;

}

#gameTitle {
  position: fixed;
  bottom: 2%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 15px;
  font-weight: normal;
  color: #00ffcc;
  font-family: 'Arial Black', sans-serif;
  z-index: 1000;   
}

  /* ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
  #loadingScreen {
    position: fixed;
    inset: 0;
    background: linear-gradient(180deg, #000, #111);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    z-index: 1000;
  }

  #loadingText {
    font-size: 11px;
    margin-top: 18px;
    text-align: center; /* ÙˆØ³Ø·â€ŒÚ†ÛŒÙ† */
  }

  #progressBar {
    width: 60%;
    height: 25px;
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
    background: #222;
  }

  #progressFill {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00ff88, #00ffff);
    border-radius: 8px;
    transition: width 0.2s ease;

  }

#logoText {
  font-size: 50px;
  font-weight: normal;
  color: #00ffcc;
  margin-bottom: 40px;
  font-family: 'Arial Black', sans-serif;
  text-shadow:
    0 0 2px #00ffcc,
    0 0 4px #00ffcc,
    0 0 6px #00ffff,
    0 0 10px #00ffff;
  animation: glow 1.5s ease-in-out infinite alternate;
}

#subLogoText {
  font-size: 15px;
  color: #00ffcc;
  font-family: 'Arial', sans-serif;
  text-shadow: 0 0 3px #00ffcc, 0 0 5px #00ffff;
  margin-bottom: 30px; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² BERMOODA */

}

@keyframes glow {
  0% {
    text-shadow:
      0 0 5px #00ffcc,
      0 0 10px #00ffcc,
      0 0 20px #00ffff,
      0 0 30px #00ffff;
    transform: scale(1);
  }
  100% {
    text-shadow:
      0 0 5px #00ffcc,
      0 0 10px #00ffcc,
      0 0 20px #00ffff,
      0 0 30px #00ffff;
    transform: scale(1.1);
  }
}


  #startBtn {
  position: fixed;
  width: 300px;     /* Ø¹Ø±Ø¶ ÛŒÚ©Ø³Ø§Ù† */
  height: 40px;
  bottom: 30%; 
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00c3ff, #0072ff);
  color: white;
  white-space: nowrap;
  border: none;
  border-radius: 25px;
  font-size: 20px;
  font-family: 'Calibri', sans-serif;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 114, 255, 0.6);
  transition: all 0.3s ease;
  display: none; /* Ø§ÙˆÙ„ Ø¨Ø§Ø²ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯ */
  z-index: 999;
}


  #scoreBtn {
  position: fixed;
  width: 300px;     /* Ø¹Ø±Ø¶ ÛŒÚ©Ø³Ø§Ù† */
  height: 40px;
  bottom: 20%; 
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00c3ff, #0072ff);
  color: white;
  white-space: nowrap;
  border: none;
  border-radius: 25px;
  font-size: 20px;
  font-family: 'Calibri', sans-serif;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 114, 255, 0.6);
  transition: all 0.3s ease;
  display: none; /* Ø§ÙˆÙ„ Ø¨Ø§Ø²ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯ */
  z-index: 999;
}
 #exitBtn {
  position: fixed;
  width: 300px;     /* Ø¹Ø±Ø¶ ÛŒÚ©Ø³Ø§Ù† */
  height: 40px;
  bottom: 10%; 
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00c3ff, #0072ff);
  color: white;
  white-space: nowrap;
  border: none;
  border-radius: 25px;
  font-size: 20px;
  font-family: 'Calibri', sans-serif;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 114, 255, 0.6);
  transition: all 0.3s ease;
  display: none; /* Ø§ÙˆÙ„ Ø¨Ø§Ø²ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯ */
  z-index: 999;
}
 #continueBtn {
  position: fixed;
  width: 300px;     /* Ø¹Ø±Ø¶ ÛŒÚ©Ø³Ø§Ù† */
  height: 40px;
  bottom: 20%; 
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00c3ff, #0072ff);
  color: white;
  white-space: nowrap;
  border: none;
  border-radius: 25px;
  font-size: 20px;
  font-family: 'Calibri', sans-serif;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 20px rgba(0, 114, 255, 0.6);
  transition: all 0.3s ease;
  display: none; /* Ø§ÙˆÙ„ Ø¨Ø§Ø²ÛŒ Ù…Ø®ÙÛŒ Ø¨Ø§Ø´Ø¯ */
  z-index: 999;
 }
#startBtn:hover {
  background: linear-gradient(135deg, #33ccff, #0066ff);
  transform: translateX(-50%) scale(1.08);
  box-shadow: 0 0 25px rgba(0, 114, 255, 0.9);
}

#startBtn:active {
  transform: translateX(-50%) scale(0.95);
}

#scoreBtn:hover {
  background: linear-gradient(135deg, #33ccff, #0066ff);
  transform: translateX(-50%) scale(1.08);
  box-shadow: 0 0 25px rgba(0, 114, 255, 0.9);
}

#scoreBtn:active {
  transform: translateX(-50%) scale(0.95);
}
#continueBtn:hover {
  background: linear-gradient(135deg, #33ccff, #0066ff);
  transform: translateX(-50%) scale(1.08);
  box-shadow: 0 0 25px rgba(0, 114, 255, 0.9);
}

#continueBtn:active {
  transform: translateX(-50%) scale(0.95);
}
  
#exitBtn:hover {
  background: linear-gradient(135deg, #33ccff, #0066ff);
  transform: translateX(-50%) scale(1.08);
  box-shadow: 0 0 25px rgba(0, 114, 255, 0.9);
}

#exitBtn:active {
  transform: translateX(-50%) scale(0.95);
}




  #creatorName {
    position: fixed;
    bottom: 12px;
    right: 15px;
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    font-style: italic;
    pointer-events: none;
    z-index: 10;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    font-family: Arial, sans-serif;
  }


/* Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ© */
#joystick {
  position: fixed;
  bottom: 30px;
  right: 20px;
  width: 80px;
  height: 80px;
  background: rgba(255,255,255,0.08);
  border: 3px solid rgba(255,255,255,0.4);
  border-radius: 50%;
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Ø®Ø·ÙˆØ· Ø¬Ù‡Øªâ€ŒÙ†Ù…Ø§ */
#joystick::before,
#joystick::after {
  content: "";
  z-index: 1100
  position: absolute;
  background: rgba(255,255,255,0.3);
  pointer-events: none;
}
#joystick::before {
  content: "";
  position: absolute;
  width: 2px;
  height: 100%;
  background: rgba(255,255,255,0.25);
  left: 50%;
  top: 0;
  transform: translateX(-50%);
}

#joystick::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 2px;
  background: rgba(255,255,255,0.25);
  top: 50%;
  left: 0;
  transform: translateY(-50%);
}


/* Ù†Ù‚Ø§Ø· Ú†Ù‡Ø§Ø± Ø¬Ù‡Øª */
#joystick span {
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(255,255,255,0.8);
  border-radius: 50%;
  pointer-events: none;
}
#joystick span.up    { top: 5px; left: 50%; transform: translateX(-50%); }
#joystick span.down  { bottom: 5px; left: 50%; transform: translateX(-50%); }
#joystick span.left  { left: 5px; top: 50%; transform: translateY(-50%); }
#joystick span.right { right: 5px; top: 50%; transform: translateY(-50%); }

/* Ø®ÙˆØ¯ Ø§Ø³ØªÛŒÚ© (Ø¯Ø§ÛŒØ±Ù‡ Ø¯Ø§Ø®Ù„ÛŒ Ù…ØªØ­Ø±Ú©) */
#stick {
position: absolute;
    width: 30px;
    height:30px;
    background: orange;
    border-radius: 50%;
    top: 25px;
    left: 25px;
    transition: 0.05s;
    display = "none"
    z-index: 1200;
  pointer-events: none;
}



    


#scoreContainer {
  position: fixed;
  display: none;
  top: 10px;
  right: 15px;
  color: #00ffcc;
  font-family: 'Arial Black', sans-serif;
  text-shadow: 0 0 6px #00ffff, 0 0 10px #00ffff;
  font-size: 18px;
  text-align: right;
  user-select: none; /* ØªØ§ Ù‚Ø§Ø¨Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø¨Ø§Ø´Ø¯ */
}

#scoreLabel {
  font-size: 14px;
  opacity: 0.8;
}

#scoreValue {
  font-size: 22px;
  font-weight: bold;
}

#pauseBtn {
  position: fixed;
  bottom: 60px;
  right: 110px;
  width: 40px;
  height: 40px;
  z-index: 2000;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.4);
  background: radial-gradient(circle at center, #0ff, #00f);
  color: #001122; /* ØªÛŒØ±Ù‡â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± */
  font-weight: bold;
  font-size: 16px;
  justify-content: center; /* Ø§ÙÙ‚ÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² */
  align-items: center; /* Ø¹Ù…ÙˆØ¯ÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² */
  cursor: pointer;
  box-shadow: 0 0 15px #0ff, 0 0 30px #0ff inset;
  transition: all 0.2s ease;
  text-shadow: 0 0 8px #0ff, 0 0 15px #0ff; /* Ø¬Ù„ÙˆÙ‡ Ù†Ø¦ÙˆÙ†ÛŒ Ù†ÙˆØ´ØªÙ‡ */
}


#chatOverlay, 
#chatComposer, 
#chatList, 
#chatInputRow, 
#chatInput, 
#chatSendBtn {
  max-width: 100%;
  box-sizing: border-box;
  overflow-x: hidden;
}



#pauseBtn:hover {
  box-shadow: 0 0 25px #0ff, 0 0 50px #0ff inset;
  text-shadow: 0 0 10px #0ff, 0 0 25px #0ff, 0 0 40px #00f;
}

/* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ */
#airplaneArcContainer {
  display: none;
  position: fixed;
  top: 100px; /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ */
  left: 0;
  width: 100%;
  height: 300px; /* Ø§Ø±ØªÙØ§Ø¹ Ú©Ø§Ù†ØªÛŒÙ†Ø± */
  overflow: hidden;
  z-index: 9999;
  touch-action: pan-x;
  user-select: none;
}

/* Ø¢Ø±Ú© */
#airplaneArc {
  position: relative;
  width: 100%;
  height: 100%;
}

/* Ù‡Ø± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ */
#airplaneArc .plane {
  position: absolute;
  bottom: 0;
  left: 0;
  transform-origin: bottom center;
  transition: transform 0.1s ease;
  cursor: pointer;
}

/* ØªØµÙˆÛŒØ± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ */
#airplaneArc .plane img {
  width: 80px;
  height: auto;
  border-radius: 10px;
  user-select: none;
  -webkit-user-drag: none;
  transition: transform 0.1s ease;
}

/* Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø´Ø¯Ù† Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ ÙˆØ³Ø· */
#airplaneArc .plane.center img {
  transform: scale(1.5);
  box-shadow: 0 0 20px 5px yellow;
}

/* Ù†Ø§Ù… Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ø²ÛŒØ± ØªØµÙˆÛŒØ± */
#airplaneArc .plane p {
  color: white;
  font-size: 12px;
  margin-top: 5px;
  text-align: center;
  text-shadow: 0 0 3px black;
}

#airplaneArc .plane.center p {
  color: yellow;
  font-size: 16px;
  font-weight: bold;
}








#shoot {
    position: fixed;
    bottom: 30px;
    left: 20px;
    width: 80px;
    height: 80px;
    display: none;
    z-index: 20000;
   transition: transform 0.08s ease;
    border-radius: 50%;
    overflow: hidden;
    cursor: pointer;
    user-select: none;

    /* ØªÙ… Ø¢ØªØ´ÛŒ Ùˆ Ù‡ÛŒØ¬Ø§Ù†ÛŒ */
    background: radial-gradient(circle at 30% 30%,
        rgba(255,120,70,0.9),
        rgba(200,0,0,0.9),
        rgba(120,0,0,0.85)
    );
    box-shadow:
        0 0 22px rgba(255,50,20,0.9),
        0 0 50px rgba(255,0,0,0.55),
        0 0 80px rgba(255,90,40,0.35);

    /* Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ + Ø¨Ù„ÙˆØ± */
    backdrop-filter: blur(6px) saturate(180%);
    -webkit-backdrop-filter: blur(6px) saturate(180%);

    /* Ù„Ø±Ø²Ø´ Ø®ÙÛŒÙ Ù‡ÛŒØ¬Ø§Ù†ÛŒ */
    animation: shootPulse 1.8s infinite ease-in-out;
    transition: transform .15s ease, box-shadow .15s ease;
}

/* Ù¾Ø§Ù„Ø³ Ù†ÙˆØ± */
@keyframes shootPulse {
    0%   { transform: scale(1);   box-shadow: 0 0 20px rgba(255,80,40,0.9); }
    50%  { transform: scale(1.06); box-shadow: 0 0 40px rgba(255,40,0,1); }
    100% { transform: scale(1);   box-shadow: 0 0 20px rgba(255,80,40,0.9); }
}

/* Ø§ÙÚ©Øª Ù‡Ù†Ú¯Ø§Ù… Ù‡Ø§ÙˆØ± */
#shoot:hover {
    transform: scale(1.12);
    box-shadow:
        0 0 35px rgba(255,120,50,1),
        0 0 80px rgba(255,0,0,0.8);
}

/* Ø§ÙÚ©Øª Ú©Ù„ÛŒÚ© Ø§Ù†ÙØ¬Ø§Ø±ÛŒ */
#shoot:active {
    transform: scale(0.92);
    box-shadow:
        0 0 60px rgba(255,200,100,1),
        0 0 100px rgba(255,60,0,1);
}

/* ØªØµÙˆÛŒØ± Ø¯Ø§Ø®Ù„ÛŒ (Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ) */
#shoot .shoot-img {
    position: absolute;
    inset: 8px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    z-index: 3;
    pointer-events: none;

    transition: transform .12s ease, filter .12s ease;
}

/* ØªÚ©Ø§Ù† Ùˆ Ø¯Ø±Ø®Ø´Ø´ ØªØµÙˆÛŒØ± Ù‡Ù†Ú¯Ø§Ù… Ù‡Ø§ÙˆØ± */
#shoot:hover .shoot-img {
    transform: scale(1.12) rotate(3deg);
    filter: brightness(1.15) contrast(1.2);
}

/* Ø§ÙÚ©Øª Shockwave */
#shoot .shockwave {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 10px;
    height: 10px;
    background: rgba(255,160,40,0.6);
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(0);
    z-index: 1;
    animation: shockwave 0.45s ease-out forwards;
}
@keyframes shockwave {
    to {
        transform: translate(-50%, -50%) scale(6);
        opacity: 0;
    }
}







/* Ù„Ø±Ø²Ø´ Ø´Ø¯ÛŒØ¯ Ø§Ø³Ù„Ø­Ù‡ */
#shoot.recoil {
    animation: gunRecoil 0.15s cubic-bezier(.3,.9,.3,1);
}

/* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù„Ú¯Ø¯ Ø§Ø³Ù„Ø­Ù‡ */
@keyframes gunRecoil {
    0%   { transform: translate(0, 0) scale(1); }
    20%  { transform: translate(-3px, -6px) scale(0.92) rotate(-3deg); }
    40%  { transform: translate(4px, -3px) rotate(2deg); }
    60%  { transform: translate(-3px, 2px) rotate(-1deg); }
    80%  { transform: translate(2px, -1px) rotate(1deg); }
    100% { transform: translate(0, 0) rotate(0deg) scale(1); }
}



/* Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† Ø¨Ù‡ CSS Ù…ÙˆØ¬ÙˆØ¯Øª â€” ripple Ù„Ø§Ø²Ù… Ø¨ÙˆØ¯ Ú©Ù‡ ØªÙˆÛŒ CSS Ù‚Ø¨Ù„ÛŒ Ù†Ø¨ÙˆØ¯ */
#shoot .ripple{
  position: absolute;
  border-radius: 50%;
  transform: scale(0);
  animation: ripple 600ms linear;
  pointer-events: none;
  background: rgba(255,255,255,0.22);
  z-index: 2;
}
@keyframes ripple {
  to { transform: scale(3); opacity: 0; }
}






#missileBtn {
  position: fixed;
  display : none;
  bottom: 60px;        /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ */
  left: 110px;      /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ú†Ù¾ ØµÙØ­Ù‡ */
  width: 40px;         /* Ø¹Ø±Ø¶ Ø¯Ú©Ù…Ù‡ */
  height: 40px;        /* Ø§Ø±ØªÙØ§Ø¹ Ø¯Ú©Ù…Ù‡ */
  background: radial-gradient(circle at center, #0ff, #00f);    /* Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ */
  color: #001122;        /* Ø±Ù†Ú¯ Ù…ØªÙ† */
  border: 3px solid rgba(255,255,255,0.4);
  z-index: 2000;
  border-radius: 50%;
  font-weight: bold;
  font-size: 16px;
  justify-content: center; /* Ø§ÙÙ‚ÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² */
  align-items: center; /* Ø¹Ù…ÙˆØ¯ÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² */
  cursor: pointer;
  box-shadow: 0 0 15px #0ff, 0 0 30px #0ff inset;
  transition: all 0.2s ease;
  text-shadow: 0 0 8px #0ff, 0 0 15px #0ff; /* Ø¬Ù„ÙˆÙ‡ Ù†Ø¦ÙˆÙ†ÛŒ Ù†ÙˆØ´ØªÙ‡ */
}


#missileBtn:disabled {
  opacity: 1;       /* Ø´ÙØ§ÙÛŒØª Ú©Ù…ØªØ± */
  cursor: not-allowed; /* Ù†Ø´Ø§Ù†Ú¯Ø± ØºÛŒØ± ÙØ¹Ø§Ù„ */
}

#bestPlayer {
  position: fixed;
  font-size: 12px;
  z-index: 10;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  pointer-events: none;
  top: calc(3% + 15px); /* ÛŒØ¹Ù†ÛŒ Û²Û° Ù¾ÛŒÚ©Ø³Ù„ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† */
  left: 10px;
  color: black;
}


#playernameDisplay,
#bestPlayer {
  display: none;
}


#game-container {
  position: relative;
}

@keyframes blinkHelp {
  0%, 50%, 100% { opacity: 1; }
  25%, 75% { opacity: 0; }
}
.help-img {
  animation: blinkHelp 1.5s infinite;
}


/* ---- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú†Øª Ù…Ø¯Ù„ ÙˆØ§ØªØ³Ø§Ù¾ - Ø­Ø¨Ø§Ø¨ÛŒ ---- */
.chat-messages, {
  box-sizing: border-box;
  font-family: Tahoma, "Segoe UI", sans-serif;
  color: #fff;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ÛŒÚ© Ø³Ø·Ø± Ù¾ÛŒØ§Ù… */
.chat-row {
  display: flex;
  width: 100%;
  align-items: flex-end;
}

/* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù† (local sender) => Ø³Ù…Øª Ø±Ø§Ø³ØªØŒ Ø­Ø¨Ø§Ø¨ Ø³Ø¨Ø² */
.chat-row.me {
  justify-content: flex-end;
}
.chat-row.me .bubble {
  background: linear-gradient(180deg,#22c55e,#16a34a); /* Ø³Ø¨Ø² */
  color: #002200;
  align-self: flex-end;
  border-radius: 16px 16px 4px 16px;
  max-width: 78%;
  padding: 8px 12px;
  word-wrap: break-word;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

/* Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± => Ø³Ù…Øª Ú†Ù¾ØŒ Ø­Ø¨Ø§Ø¨ ØµÙˆØ±ØªÛŒ */
.chat-row.other {
  justify-content: flex-start;
}
.chat-row.other .bubble {
  background: linear-gradient(180deg,#ffb6c1,#ff8da6); /* ØµÙˆØ±ØªÛŒ */
  color: #180018;
  align-self: flex-start;
  border-radius: 16px 16px 16px 4px;
  max-width: 78%;
  padding: 8px 12px;
  word-wrap: break-word;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

/* Ù…ØªÙ† Ùˆ Ø²Ù…Ø§Ù† Ø¯Ø§Ø®Ù„ Ø­Ø¨Ø§Ø¨ */
.bubble .text {
  display:block;
  white-space:pre-wrap;
  line-height:1.35;
  font-size:14px;
}
.bubble .time {
  display:block;
  font-size:11px;
  opacity:0.8;
  margin-top:6px;
  text-align: right;
  direction: ltr; /* Ø²Ù…Ø§Ù† Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ LTR */
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ avatar ÛŒØ§ Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) */
.chat-row .meta {
  font-size:12px;
  color:rgba(255,255,255,0.6);
  margin: 0 8px;
  align-self:flex-end;
}

/* Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ú©ÙˆÚ†Ú©â€ŒØªØ± */
.chat-messages::-webkit-scrollbar, #chatList::-webkit-scrollbar {
  width:8px;
}
.chat-messages::-webkit-scrollbar-thumb, #chatList::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
}






/* ÙˆÙ‚ØªÛŒ Ø­Ø¨Ø§Ø¨ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³ØªØŒ Ù†ÙˆØ´ØªØ§Ø± Ø®Ø·â€ŒØ®ÙˆØ± Ø¨Ø§Ø´Ø¯ */
.bubble { word-break: break-word; }

/* Ø¯Ø± Ø­Ø§Ù„Øª Ù…ÙˆØ¨Ø§ÛŒÙ„ Ú©ÙˆÚ†Ú©â€ŒØªØ± */
@media (max-width:420px) {
  .chat-row.me .bubble, .chat-row.other .bubble { font-size:13px; padding:8px 10px; }
}

#gameBackground {
  position: fixed;
  inset: 0;
  background-size: cover;
  background-position: center;
  opacity: 0;
  transition: opacity 0.5s ease-in-out;
  z-index: 0;   /* â† Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ 0 Ø¨Ø§Ø´Ø¯ */
}

#gameBackground.fadeOutBg {
  opacity: 0 !important;
}





/* Ù¾Ù†Ø¬Ø±Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ú†Øª - ØªÙ…Ø§Ù… ØµÙØ­Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ */
#chatOverlay {
  position: fixed;
  inset: 0;                 /* Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† width/height Ùˆ top/left */
  background: rgba(0,0,0,0.8);
  z-index: 20000;

  display: none;            /* Ø¯Ø± Ø´Ø±ÙˆØ¹ Ù…Ø®ÙÛŒ */
  flex-direction: column;
  overflow: hidden;         /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡ */
  box-sizing: border-box;
}

#chatComposer {
  position: absolute;
  inset: 0;                 /* Ú©Ù„ ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯ */
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.85);
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

#chatSendBtn {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: #ffb700;
  color: #000;
  font-weight: bold;
  cursor: pointer;
}



#chatInput {
  flex: 1;
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  outline: none;
  box-sizing: border-box;
  background: #ffffff;
}


/* Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
#chatList {
  flex: 1;
  overflow-y: auto;
  width: 100%;
  padding: 12px;
  box-sizing: border-box;
  margin: 0;
}




</style>
</head>
<body>


<canvas id="gameCanvas"></canvas>
<button id="startBtn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
<div id="bestPlayer">Best Player: ---</div>







<button id="scoreBtn">Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ùˆ Ù†ÙØ±Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
<button id="continueBtn">Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ</button>
<button id="exitBtn">Ø®Ø±ÙˆØ¬</button>
<div id="creatorName">Created by Mohsen Forghani</div>
<button id="missileBtn" disabled>ğŸš€</button>
<div id="gameTitle">BERMOODA</div>
<div id="controlPanel"></div>
<div id="finalScore"></div>
<div id="playernameDisplay"></div>

<button id="pauseBtn" style="display:none;">â¸</button>
<div id="gameBackground"></div>



<!-- Ø¬Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ + overlay Ùˆ composer -->
<div id="chatMessages" class="chat-messages" dir="rtl" aria-live="polite"></div>

<!-- Ù¾Ù†Ø¬Ø±Ù‡â€ŒÛŒ Ú†Øª (overlay) -->
<div id="chatOverlay">
  <!-- Ø²Ù…ÛŒÙ†Ù‡ Ù†ÛŒÙ…Ù‡â€ŒØ´ÙØ§Ù Ø¨Ø±Ø§ÛŒ Ù¾ÙˆØ´Ø´ -->
  <div id="chatBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,0.25);"></div>

  <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ composer -->
<div id="chatComposer" 
     style="
     position:relative; 

     /* --- Ø¹Ø±Ø¶ Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ù†Ø³Ø¨Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ --- */
     width:100vw;
     max-width:100vw;
     height:100vh;
     max-height:100vh;

     /* ---- Ø¨Ú©â€ŒÚ¯Ø±Ø§Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ ØªØµÙˆÛŒØ±ÛŒ Ø¨Ø§ opacity 70% ---- */
     background: rgba(255,255,255,0.7) url('chatBackground1.png');
     background-size: cover;
     background-position: center;

     border:1px solid rgba(0,0,0,0.06);
     color:#17212b;
     border-radius:12px;
     margin:16px;
     display:flex; 
     flex-direction:column; 
     overflow:hidden;
     box-shadow:0 10px 30px rgba(0,0,0,0.12);
">





   <div id="chatHeader" 
     style="padding:10px 12px; background:transparent; 
     display:flex; align-items:center; justify-content:space-between;">
    <div id="chatTitle" 
     style="color:#17212b; font-weight:700; font-size:14px;">Ú†Øª</div>

      <button id="closeChatBtn" aria-label="Ø¨Ø³ØªÙ† Ú†Øª" style="background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer;">âœ•</button>
    </div>

    <!-- Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø§Ø³Ú©Ø±ÙˆÙ„ Ù¾Ø°ÛŒØ±) -->
    <div id="chatList" style="flex:1; overflow-y:auto; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; gap:8px;" ></div>

    <!-- composer Ù¾Ø§ÛŒÛŒÙ† -->
    <div style="padding:8px; border-top:1px solid rgba(255,255,255,0.03); display:flex; gap:8px; align-items:center;">
    <input id="chatInput" type="text" placeholder="Ù¾ÛŒØ§Ù…..." aria-label="Ù¾ÛŒØ§Ù…"
       style="
         flex:1; 
         padding:8px 12px; 
         border-radius:20px; 
         border:1px solid rgba(0,0,0,0.25); 
         background:rgba(0,0,0,0.25);   /* ğŸ”¥ ØªÛŒØ±Ù‡â€ŒØªØ± Ø§Ø² Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª */
         color:#fff; 
         outline:none;
         text-align:right;
         direction:rtl;
       ">
      <button id="chatSendBtn" style="min-width:44px; height:40px; border-radius:50%; border:0; background:#00c853; color:#001; font-weight:700; cursor:pointer;">â†’</button>
    </div>
  </div>
</div>


<!-- ğŸ® Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
<div id="joystick">
  <span class="up"></span>
  <span class="down"></span>
  <span class="left"></span>
  <span class="right"></span>
  <div id="stick"></div>
</div>




<!-- Ù†Ù…ÙˆÙ†Ù‡â€ŒÛŒ HTML (Ø§Ú¯Ø± Ù†Ø¯Ø§Ø±ÛŒØ´) -->
<div id="shoot" role="button" aria-label="shoot">
  <img class="shoot-img" src="path/to/your-image.jpg" alt="">
  <span class="shoot-icon">â—</span>
</div>






 <div id="loadingScreen">
<div id="logoText">BERMOODA</div>
<div id="subLogoText">A GAME BY MOHSEN</div>
    <div id="loadingText">Loading...</div>
    <div id="progressBar">
      <div id="progressFill"></div>
    </div>
  </div>





<!-- ğŸ”¥ Ù†ÙˆØ§Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø´Ù„ÛŒÚ© (Ú¯Ø±Ø§ÙÛŒÚ©ÛŒ + Ù„Ø±Ø²Ø´ Ø§Ø³ØªØ±Ø³) -->
<div id="heatBarContainer" style="
  position: fixed;
  top: 5px;
  left: 50%;
  transform: translateX(-50%);
  width: 35%;
  height: 10px;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.25), rgba(0,0,0,0.5));
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 12px;
  overflow: hidden;
  z-index: 1500;
  box-shadow:
    0 0 10px rgba(0,255,255,0.4),
    inset 0 0 6px rgba(255,255,255,0.2),
    inset 0 0 12px rgba(0,0,0,0.6);
  backdrop-filter: blur(3px);
display: none;
">
  <div id="heatBar" style="
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg,
      #00ff99 0%,
      #aaff00 20%,
      #ffff00 40%,
      #ff8800 60%,
      #ff3300 80%,
      #ff0033 100%
    );
    border-radius: 12px;
    box-shadow:
      0 0 12px rgba(255,255,255,0.5),
      0 0 20px rgba(255,0,0,0.3);
    transition: width 0.15s linear;
    mask-image: repeating-linear-gradient(
      90deg,
      rgba(0,0,0,1) 0,
      rgba(0,0,0,1) 6px,
      rgba(0,0,0,0) 8px
    );
    animation: heatPulse 1.8s infinite linear;
  "></div>
</div>

<style>
@keyframes heatPulse {
  0% { filter: brightness(1) saturate(1); }
  50% { filter: brightness(1.5) saturate(1.4); }
  100% { filter: brightness(1) saturate(1); }
}

@keyframes heatShake {
  0% { transform: translateX(-50%) translateY(0px) rotate(0deg); }
  20% { transform: translateX(-50%) translateY(-1px) rotate(0.5deg); }
  40% { transform: translateX(-50%) translateY(1px) rotate(-0.5deg); }
  60% { transform: translateX(-50%) translateY(-1px) rotate(0.3deg); }
  80% { transform: translateX(-50%) translateY(1px) rotate(-0.3deg); }
  100% { transform: translateX(-50%) translateY(0px) rotate(0deg); }
}

/* Ú©Ù„Ø§Ø³ Ù„Ø±Ø²Ø´ */
.heatShake {
  animation: heatShake 0.15s infinite linear;
}
</style>





<div id="airplaneArcContainer" style="display:none;">
  <h3 id="planeSelectTitle" style="color:white; text-align:center; margin-top:10px;">
    âœˆï¸ Ù„Ø·ÙØ§Ù‹ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
  </h3>

  <div id="airplaneArc">
    <div class="plane" data-plane="30"><img src="plane30.png" alt="ØµØ§Ø¹Ù‚Ù‡"></div>
    <div class="plane" data-plane="31"><img src="plane31.png" alt="Ø¢Ø°Ø±Ø®Ø´"></div>
    <div class="plane" data-plane="32"><img src="plane32.png" alt="Ø¹Ù‚Ø§Ø¨"></div>
    <div class="plane" data-plane="33"><img src="plane33.png" alt="Ø§Ú˜Ø¯Ø±"></div>
    <div class="plane" data-plane="34"><img src="plane34.png" alt="Ø·ÙˆÙØ§Ù†"></div>
    <div class="plane" data-plane="35"><img src="plane35.png" alt="Ù‚Ù‚Ù†ÙˆØ³"></div>
    <div class="plane" data-plane="36"><img src="plane36.png" alt="Ø±Ø¹Ø¯"></div>
    <div class="plane" data-plane="37"><img src="plane37.png" alt="Ø¨Ø±Ù‚"></div>
    <div class="plane" data-plane="38"><img src="plane38.png" alt="ØµØ§Ø¹Ù‚Ù‡ Û²"></div>
  </div>
</div>




<div id="scoreContainer">
  <div id="scoreLabel">Score :</div>
  <div id="scoreValue">0</div>
</div>





<!-- Ù„Ø§ÛŒÙ‡â€ŒÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª -->
<div id="scoreOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  backdrop-filter:blur(3px);
  z-index:9999;
  justify-content:center;
  align-items:center;
  padding:25px;
  overflow:auto;
">
  <div id="scoreBox" style="
    width:90%;
    max-width:600px;

    /* Ø¨Ú©â€ŒÚ¯Ø±Ø§Ù†Ø¯ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ + Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ */
    background:rgba(255,255,255,0.30);
    backdrop-filter:blur(6px);

    border-radius:14px;
    padding:22px;
    border:1px solid rgba(255,255,255,0.18);

    color:#ffffff;
    font-family:Arial, sans-serif;
    box-shadow:0 4px 18px rgba(0,0,0,0.25);
    text-align:center;
  ">
    <h2 style="
      margin-bottom:16px;
      font-size:20px;
      font-weight:700;
      color:#d2ffd2;
    ">
      ğŸ† Ù„ÛŒØ³Øª Ø§Ù…ØªÛŒØ§Ø²Ø§Øª
    </h2>

    <!-- Ù„ÛŒØ³Øª Ø§Ù…ØªÛŒØ§Ø²Ø§Øª -->
    <div id="scoreList" style="
      max-height:70vh; 
      overflow-y:auto; 
      border-radius:10px;
      font-size:15px;
      direction:rtl;
    "></div>

    <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø³ØªÙ† -->
    <button id="closeScoreBtn" style="
      margin-top:18px;
      background:rgba(255,255,255,0.25);
      color:#fff;
      border:none;
      padding:10px 22px;
      border-radius:10px;
      cursor:pointer;
      font-weight:bold;
      font-size:14px;
      transition:0.3s;
    ">
      Ø¨Ø³ØªÙ†
    </button>
  </div>
</div>




<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;






// ===========================
// Ù…Ø±Ø­Ù„Ù‡ Û²: Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ú†Øª
// ===========================

// ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù† ÙØ¹Ù„ÛŒ Ø§Ø³Øª
// Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù¾Ø³ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ initPlayer() Ø¢Ù…Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
window.chatSenderId = null;
window.chatSenderName = null;

// Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ Ú©Ù‡ Ø±ÙˆÛŒ Ù†Ø§Ù…Ø´ Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡ Ùˆ Ù‚Ø±Ø§Ø± Ø§Ø³Øª Ø¨Ù‡ Ø§Ùˆ Ù¾ÛŒØ§Ù… Ø¨Ø¯Ù‡ÛŒÙ…
window.chatReceiverId = null;
window.chatReceiverName = null;

// Ù¾Ø±Ú†Ù… Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª
window.chatWindowOpen = false;






// ğŸ¶ Ø¢Ù‡Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ø§Ø²ÛŒ
let gameMusic = new Audio("sounds/BermoodaSound.mp3"); // Ù…Ø³ÛŒØ± Ø¢Ù‡Ù†Ú¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
gameMusic.loop = true;     // Ø¢Ù‡Ù†Ú¯ ØªÚ©Ø±Ø§Ø±Ø´ÙˆÙ†Ø¯Ù‡
gameMusic.volume = 0.0;    // Ø´Ø±ÙˆØ¹ Ø¨ÛŒâ€ŒØµØ¯Ø§ (Ø¨Ø±Ø§ÛŒ fade in)
let fadeGameMusic = null;



let gameOverMusic = new Audio("sounds/gameOverSound.mp3"); // Ø¢Ù‡Ù†Ú¯ Ø´Ú©Ø³Øª
gameOverMusic.loop = true;
gameOverMusic.volume = 0.0;
let fadeGameOverMusic = null;
gameOverMusic.volume = 0.7; 


//let shootSound = new Audio("sounds/shotSoundAirplane.mp3");
//shootSound.volume = 0.7; 



  

const heartDrops = [];
const HEART_DROP_CHANCE = 0.3; // 0.5 Ø¯Ø±ØµØ¯
const HEART_FALL_SPEED = 2;
const HEART_SIZE = 18;

  function trySpawnHeartDrop(x, y) {
  if (Math.random() <= HEART_DROP_CHANCE) {
    heartDrops.push({
      x: x,
      y: y,
      size: HEART_SIZE,
      speed: HEART_FALL_SPEED,

      // Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
      scale: 1,
      scaleDir: 1,
      floatOffset: Math.random() * Math.PI * 2,
      rotation: Math.random() * 0.5,

      active: true
    });
  }
}

  function updateHeartDrops() {
  for (let i = heartDrops.length - 1; i >= 0; i--) {
    const heart = heartDrops[i];

    heart.y += heart.speed;
    heart.floatOffset += 0.05;
    heart.x += Math.sin(heart.floatOffset) * 0.5;

    heart.scale += 0.01 * heart.scaleDir;
    if (heart.scale > 1.2 || heart.scale < 0.9) {
      heart.scaleDir *= -1;
    }

    heart.rotation += 0.01;

    if (heart.y > canvas.height + heart.size) {
      heartDrops.splice(i, 1);
      continue;
    }

    if (checkHeartCollisionWithPlayer(heart)) {
      increasePlayerLife();
      heartDrops.splice(i, 1);
    }
  }
}



  
  function drawHeartDrops(ctx) {
  for (const heart of heartDrops) {
    ctx.save();

    ctx.translate(heart.x, heart.y);
    ctx.rotate(heart.rotation);
    ctx.scale(heart.scale, heart.scale);

    ctx.font = "24px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â¤ï¸", 0, 0);

    ctx.restore();
  }
}


  function checkHeartCollisionWithPlayer(heart) {
  return (
    heart.x + heart.size/2 > airplane.x &&
    heart.x - heart.size/2 < airplane.x + airplane.width &&
    heart.y + heart.size/2 > airplane.y &&
    heart.y - heart.size/2 < airplane.y + airplane.height
  );
}




function increasePlayerLife() {
  lives++;
}





  

  

// ğŸ¯ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù†ÙˆØ§Ø± Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø´Ù„ÛŒÚ©
let heat = 0; // Ù…ÛŒØ²Ø§Ù† Ú¯Ø±Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ (Û° ØªØ§ Û±Û°Û°)
let overheated = false; // Ø¢ÛŒØ§ ØªÙÙ†Ú¯ Ø¯Ø§Øº Ø´Ø¯Ù‡ØŸ
let heatFillRate = 1.2;   // Ø³Ø±Ø¹Øª Ø§ÙØ²Ø§ÛŒØ´ Ú¯Ø±Ù…Ø§ Ø¯Ø± Ù‡Ø± Ø´Ù„ÛŒÚ© (Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…)
let heatCoolRate = 0.2; // Ø³Ø±Ø¹Øª Ø®Ù†Ú© Ø´Ø¯Ù† Ø¯Ø± Ù‡Ø± ÙØ±ÛŒÙ… (Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…)
let overheatDuration = 3000; // Ø²Ù…Ø§Ù† Ù‚ÙÙ„ Ø´Ù„ÛŒÚ© Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ø§Øº Ø´Ø¯Ù† (Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
let lastOverheatTime = 0;
const heatBar = document.getElementById("heatBar");
if (!heatBar) console.warn('heatBar not found');

const SHEET_WEBAPP = 'https://script.google.com/macros/s/AKfycbzPI5V8LCbQW1aSee0gBpwz-T8YdPXbKFmWeBgU5V_mWJQwqowJRU88yKfEfrJ9EUsg/exec';


let presenceIntervalId = null;
window.alreadySentScore = false;





function startPresence() {
  if (presenceIntervalId) return;
  // Ø§Ø±Ø³Ø§Ù„ ÛŒÚ©Ø¨Ø§Ø± ÙÙˆØ±ÛŒ
  sendPresence(true);

  presenceIntervalId = setInterval(()=> sendPresence(true), 5000); 
}

function stopPresence() {
  if (presenceIntervalId) {
    clearInterval(presenceIntervalId);
    presenceIntervalId = null;
  }
  sendPresence(false);
}

function sendPresence(isOnline) {
  const id = window.playerId || getOrCreatePlayerId();
  const name = window.playerName || (localStorage.getItem('bermooda_playerName') || "Ù†Ø§Ø´Ù†Ø§Ø³");

  const params = new URLSearchParams();
  params.append('action', 'presence');       // unified action
  params.append('playerId', id);
  params.append('name', name);
  params.append('online', isOnline ? '1' : '0');
  params.append('device', navigator.userAgent || 'unknown');
  params.append('lastSeen', new Date().toISOString());

 
  try {
    if (navigator.sendBeacon) {
      
      const blob = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded;charset=UTF-8' });


      const ok = navigator.sendBeacon(SHEET_WEBAPP, blob);
      if (ok) return;
    }
  } catch (e) {
  console.warn("sendBeacon failed:", e);
  }

  try {
    fetch(SHEET_WEBAPP, {
      method: 'POST',
      body: params,
      credentials: 'omit',
      keepalive: true // helpful during unload
    }).catch(e => console.warn("presence fetch failed:", e));
  } catch (e) {
    console.warn("presence final fallback failed:", e);
  }
}







//=======================================ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾ÛŒØ§Ù…Ù‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡===============================

  async function fetchFromServer(params) {
  const res = await fetch(SHEET_WEBAPP, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams(params)
  });
  return await res.json();
}

/* ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ */
async function loadAndShowUnread(playerId) {
  try {
    
    const data = await fetchFromServer({
      action: "getunreadsummary",
      playerId: playerId
    });
    
    if (!data || !data.ok) return;

    renderUnreadPopup(data, playerId);
  } catch(e) {
    console.error(e);
  }
}

function renderUnreadPopup(data, playerId) {
// Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§ØµÙ„Ø§Ù‹ Ù¾Ù†Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ø´ÙˆØ¯
  const totalUnread = Number(data.total || 0);
  const listArr = data.bySender || [];

  if (totalUnread === 0 || listArr.length === 0) {
    return; // Ù‡ÛŒÚ† Ú†ÛŒØ² Ù†Ø³Ø§Ø²ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
  }


  // Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø±Ø¯Ù† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ ÛŒÚ©â€ŒØ¨Ø§Ø±
  if (!document.getElementById('unread-styles')) {
    const css = `
      #unreadPopup { position: fixed; display: flex; justify-content: center;  align-items: flex-start;
     flex-direction: column;  top: 20px; left: 50% ; transform: translateX(-50%); width: 70%; max-height: 65vh; overflow:auto;
                     z-index:10000; direction: rtl; font-family: Tahoma, Arial, sans-serif; }
      .unread-panel { width: 100%; max-width: 480px; background: linear-gradient(180deg, rgba(18,18,20,0.98), rgba(28,28,30,0.95));
                      border-radius:14px; overflow: visible !important; padding:12px; box-shadow: 0 14px 40px rgba(0,0,0,0.6); color:#fff; }
      .unread-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
      .unread-total { font-weight:800; font-size:14px; color:#ffd6a5; text-shadow:0 0 10px rgba(255,180,80,0.28); }
      .unread-close { background:transparent; border:0; color:#ddd; cursor:pointer; font-size:13px; }
      .unread-list { display:flex; flex-direction:column; gap:10px; }
      .unread-item {
        --btn-h: clamp(52px, 7vh, 72px);
        display:flex; align-items:center; justify-content:space-between;
        padding:10px 14px; height:var(--btn-h); box-sizing:border-box;
        border-radius:14px;
        background: linear-gradient(135deg, #ff8a00 0%, #ffb457 100%);
        color:#2b0a00; font-weight:800; cursor:pointer;
        box-shadow:
          0 6px 18px rgba(255,122,0,0.18),
          0 0 28px rgba(255,160,60,0.14),
          0 0 12px rgba(255,190,110,0.06) inset;
        transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 220ms ease, box-shadow 260ms ease;
        user-select:none;
        position: relative;
        z-index: 10;
        overflow: hidden;
      }

      .unread-item .meta { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
      .unread-item .meta .name { font-size:15px; color:#2b0a00; }
      .unread-item .meta .sub { font-size:12px; color: rgba(43,10,0,0.8); font-weight:700; }

      .unread-item .badge {
        background: rgba(255,255,255,0.16);
        padding:6px 10px; border-radius:999px;
        font-size:13px; color:#fff; font-weight:900;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      }

      .unread-item:hover { transform: translateX(6px) scale(1.02); box-shadow: 0 14px 36px rgba(255,140,0,0.28), 0 0 40px rgba(255,165,0,0.16); }
      .unread-item:active { transform: translateX(2px) scale(0.99); }

      /* Ø§ÙÚ©Øª glow Ù†Ø¦ÙˆÙ† Ø§Ø·Ø±Ø§Ù Ø¯Ú©Ù…Ù‡ */
      .unread-item::after {
        content: ''; position:absolute; inset:0; border-radius:14px;
        box-shadow: 0 0 28px rgba(255,140,0,0.25);
        pointer-events:none; opacity:0.9;
      }

      /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø®Ø±ÙˆØ¬ Ø³Ø±ÛŒØ¹ Ø¨Ù‡ Ø³Ù…Øª Ú†Ù¾ */
      .unread-item.sliding {
        transform: translateX(-120vw) rotate(-3deg) !important;
        opacity: 0 !important;
        transition: transform 300ms cubic-bezier(.08,.9,.2,1), opacity 240ms ease;
      }

      /* collapse Ø¨Ø±Ø§ÛŒ Ø¨Ù„Ù†Ø¯ Ø´Ø¯Ù† Ù†Ø±Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± */
      .unread-item.collapsing {
        height: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin: 0 !important;
        transition: height 320ms ease, padding 320ms ease, margin 320ms ease;
      }

      @media (max-width:420px) {
        #unreadPopup { left: 8px; width: calc(100% - 16px); top: 12px; }
        .unread-item { border-radius:12px; --btn-h: 56px; }
      }
    `;
    const st = document.createElement('style');
    st.id = 'unread-styles';
    st.textContent = css;
    document.head.appendChild(st);
  }

  // Ø­Ø°Ù Ø¨Ú©â€ŒØ¯Ø±Ø§Ù¾/Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± Ø¨ÙˆØ¯
  const prevBackdrop = document.getElementById('unreadBackdrop');
  if (prevBackdrop) prevBackdrop.remove();
  const prevBox = document.getElementById('unreadPopup');
  if (prevBox) prevBox.remove();

  // Ø¨Ú©â€ŒØ¯Ø±Ø§Ù¾
  const backdrop = document.createElement('div');
  backdrop.id = 'unreadBackdrop';
  Object.assign(backdrop.style, { position: 'fixed', inset: '0', background: 'rgba(0,0,0,0.12)', zIndex: 9990, pointerEvents: 'auto' });
  backdrop.addEventListener('click', () => { backdrop.remove(); const p = document.getElementById('unreadPopup'); if (p) p.remove(); });
  document.body.appendChild(backdrop);

  // Ù¾Ù†Ø¬Ø±Ù‡
  const box = document.createElement('div');
  box.id = 'unreadPopup';
  box.className = 'unread-panel-wrapper';
  const panel = document.createElement('div');
  panel.className = 'unread-panel';

  // header Ø¨Ø§ Ø´Ù…Ø§Ø±Ø´ Ú©Ù„
  const header = document.createElement('div');
  header.className = 'unread-header';
  const totalCount = Number(data.total || 0);
  const totalEl = document.createElement('div');
  totalEl.className = 'unread-total';
  totalEl.id = 'unreadTotalDisplay';
  totalEl.innerText = `Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡: ${totalCount}`;

  const closeBtn = document.createElement('button');
  closeBtn.className = 'unread-close';
  closeBtn.innerText = 'Ø¨Ø³ØªÙ†';
  closeBtn.addEventListener('click', (ev) => { ev.stopPropagation(); backdrop.remove(); box.remove(); });

  header.appendChild(totalEl);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  // Ù„ÛŒØ³Øª
  const list = document.createElement('div');
  list.className = 'unread-list';

  // helper Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¹Ø¯Ø¯ Ú©Ù„
  function updateTotal() {
    const rem = Array.from(list.querySelectorAll('.unread-item')).reduce((s, el) => {
      const c = Number(el.getAttribute('data-count') || 0);
      return s + (isNaN(c) ? 0 : c);
    }, 0);
    const totalDisplay = document.getElementById('unreadTotalDisplay');
    if (totalDisplay) totalDisplay.innerText = `Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡: ${rem}`;
  }

  // Ø³Ø§Ø®Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ (Ø­ÙØ¸ ØªØ±ØªÛŒØ¨ Ø¯Ø§Ø¯Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± data.bySender)
  (data.bySender || []).forEach(item => {
    const count = (item.count !== undefined) ? Number(item.count) : (item.unread !== undefined ? Number(item.unread) : 0);
    const name = item.senderName || item.senderId || 'Ù†Ø§Ø´Ù†Ø§Ø³';
    const senderId = item.senderId || '';

    const row = document.createElement('div');
    row.className = 'unread-item';
    row.setAttribute('data-sender', senderId);
    row.setAttribute('data-count', String(count));

    // Ù…ØªØ§ (Ù†Ø§Ù… Ùˆ ØªÙˆØ¶ÛŒØ­ Ú©ÙˆÚ†Ú©)
    const meta = document.createElement('div');
    meta.className = 'meta';
    const nameEl = document.createElement('div'); nameEl.className = 'name'; nameEl.innerText = name;
    const subEl = document.createElement('div'); subEl.className = 'sub'; subEl.innerText = `${count} Ù¾ÛŒØ§Ù…`;
    meta.appendChild(nameEl); meta.appendChild(subEl);

    // badge (Ø´Ù…Ø§Ø±Ù‡)
    const badge = document.createElement('div'); badge.className = 'badge'; badge.innerText = String(count);

    // label-cta Ú©ÙˆÚ†Ú© Ø³Ù…Øª Ú†Ù¾
    const cta = document.createElement('div'); cta.style.fontSize = '13px'; cta.style.fontWeight = '800'; cta.innerText = 'Ù…Ø´Ø§Ù‡Ø¯Ù‡ â†’';

    row.appendChild(meta);
    row.appendChild(badge);
    row.appendChild(cta);

    // handler Ú©Ù„ÛŒÚ© â€” Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² playerId ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¹Ø¯Ù… Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª
    row.addEventListener('click', async (ev) => {
      ev.stopPropagation();
      ev.preventDefault();

      // ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú†Øª (Ø§Ø² Ù‡Ù…Ø§Ù† Ø§Ø³Ø§Ù…ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ú©Ø¯ Ø®ÙˆØ¯Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†)
      window.chatReceiverId = senderId;
      window.chatReceiverName = name;

      // Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ window.playerId Ø±Ø§ Ø³Øª Ú©Ø±Ø¯Ù‡ØŒ Ø§Ø² Ù‡Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø› Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ†ØµÙˆØ±Øª Ø§Ø² playerId Ù¾Ø§Ø±Ø§Ù…ØªØ±
      window.chatSenderId = window.chatSenderId || window.playerId || playerId || '';
      window.chatSenderName = window.chatSenderName || window.playerName || (localStorage.getItem('bermooda_playerName') || '');

      // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ¹ UI Ú†Øª (Ø§Ú¯Ø± ØªÙˆ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ´ Ù‡Ø³Øª)
      try {
        const chatOverlay = document.getElementById('chatOverlay');
        const chatComposer = document.getElementById('chatComposer');
        if (chatOverlay) chatOverlay.style.display = 'flex';
        if (chatComposer) chatComposer.style.display = 'flex';
        const chatListEl = document.getElementById('chatList') || document.getElementById('chatMessages');
        if (chatListEl) chatListEl.innerHTML = '';
      } catch(e){ /* Ø¨ÛŒâ€ŒØ³Ø± Ùˆ ØµØ¯Ø§ */ }

      // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª markread Ø¨Ù‡ Ø³Ø±ÙˆØ± (Ø§Ø² playerId Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
      try { fetchFromServer({ action: "markread", myId: playerId, otherId: senderId }).catch(()=>{}); } catch(e){}

      // Ø§Ù†ÛŒÙ…ÛŒØ´Ù†: Ø³Ø±ÛŒØ¹ Ø¨Ù‡ Ú†Ù¾ Ø®Ø§Ø±Ø¬ Ø´ÙˆØ¯
      row.classList.add('sliding');

      // Ø¨Ø¹Ø¯ Ø§Ø² Ø­Ø±Ú©Øª Ø®Ø§Ø±Ø¬ØŒ Ø§Ø±ØªÙØ§Ø¹ collapse Ø´ÙˆØ¯ ØªØ§ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ù†Ø±Ù… Ø¨Ø§Ù„Ø§ Ø¨ÛŒØ§ÛŒÙ†Ø¯
      const slideMs = 320;
      setTimeout(() => {
        // ØªØ¹ÛŒÛŒÙ† Ø§Ø±ØªÙØ§Ø¹ ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ transition Ø¯Ø±Ø³Øª
        const h = row.getBoundingClientRect().height;
        row.style.height = h + 'px';
        row.style.transition = 'height 340ms ease, padding 340ms ease, margin 340ms ease';
        requestAnimationFrame(() => {
          row.classList.add('collapsing');
        });

        // Ø­Ø°Ù Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ø´Ù…Ø§Ø±Ø´
        const onEnd = () => {
          try { row.removeEventListener('transitionend', onEnd); } catch(e){}
          try { row.remove(); updateTotal(); } catch(e){}
        };
        row.addEventListener('transitionend', onEnd);
      }, slideMs);

      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ùˆ Ø±Ù†Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯)
      try { if (typeof fetchChatMessagesAndRender === 'function') await fetchChatMessagesAndRender(); } catch(e){ console.warn(e); }

      // Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ùˆ Ø¨Ú©â€ŒØ¯Ø±Ø§Ù¾ (Ø¯Ù„Ø®ÙˆØ§Ù‡)
      try { backdrop.remove(); } catch(e){}
      try { const p = document.getElementById('unreadPopup'); if (p) p.remove(); } catch(e){}

      // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù„ÛŒØ³Øª Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ú¯ÛŒØ±ÛŒ
      try { if (typeof loadAndShowUnread === 'function') loadAndShowUnread(playerId); } catch(e){}
    });

    list.appendChild(row);
  });

  panel.appendChild(list);
  box.appendChild(panel);
  document.body.appendChild(box);

  // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø´Ù…Ø§Ø±Ø´ Ú©Ù„
  // Ø§Ú¯Ø± Ø¯Ø± data.total Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø¬Ù…Ø¹ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
 let totalElDisplay = document.getElementById('unreadTotalDisplay');

  if (totalElDisplay ) {
    const calc = Array.from(list.querySelectorAll('.unread-item')).reduce((s, el) => s + Number(el.getAttribute('data-count')||0), 0);
    totalElDisplay .innerText = `Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒÙ†Ø´Ø¯Ù‡: ${data.total !== undefined ? data.total : calc}`;
  }
}


//=====================================ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù¾ÛŒØ§Ù…Ù‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡=================================


// === utility: secure uuid (modern) with fallback ===

function getOrCreatePlayerId() {

  // --- helper: cookie ---
  function setCookie(name, value, days = 3650) {
    try {
      const d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      // SameSite=Lax Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø­ØªÙ…Ø§Ù„ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯Ù† Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù…Ø¯Ø±Ù†
      document.cookie = name + "=" + encodeURIComponent(value) + "; expires=" + d.toUTCString() + "; path=/; SameSite=Lax";
    } catch (e) {
      console.warn("setCookie failed:", e);
    }
  }
  function getCookie(name) {
    try {
      const m = document.cookie.match(new RegExp("(^|; )" + name + "=([^;]+)"));
      return m ? decodeURIComponent(m[2]) : null;
    } catch (e) {
      return null;
    }
  }

  // --- helper: localStorage writable test ---
  function isLocalStorageWritable() {
    try {
      const testKey = "__bermooda_test__";
      localStorage.setItem(testKey, "1");
      localStorage.removeItem(testKey);
      return true;
    } catch (e) {
      return false;
    }
  }

  // --- helper: generate uuid ---
  function generateUuid() {
    try {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    } catch (e) {}
    // fallback uuidv4
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // --- helper: write to IndexedDB (fire-and-forget) ---
  function saveToIndexedDB(key, value) {
    try {
      // non-blocking attempt; browsers that don't support IDB will throw and we'll ignore
      const req = indexedDB.open("bermooda_db_v1", 1);
      req.onupgradeneeded = function(e) {
        const db = req.result;
        try { if (!db.objectStoreNames.contains("store")) db.createObjectStore("store"); } catch(e){}
      };
      req.onsuccess = function() {
        try {
          const db = req.result;
          const tx = db.transaction("store", "readwrite");
          tx.objectStore("store").put(value, key);
          tx.oncomplete = function() { db.close(); };
          tx.onerror = function(){ try{ db.close(); }catch(e){} };
        } catch (e) {}
      };
      req.onerror = function(){ /* ignore */ };
    } catch (e) {
      // IndexedDB unavailable or blocked (e.g. some private modes) -> ignore
    }
  }

  // ---------- main (synchronous return) ----------
  try {
    // 1) cached in memory?
    if (window.playerId) return window.playerId;

    // 2) try localStorage (fast, sync)
    try {
      const idLS = (function(){
        try { return localStorage.getItem('bermooda_playerId'); } catch(e) { return null; }
      })();
      if (idLS) {
        // ensure cookie + idb written asynchronously (migration)
        try { setCookie('bermooda_playerId', idLS); } catch(e){}
        try { saveToIndexedDB('playerId', idLS); } catch(e){}
        window.playerId = idLS;
        return idLS;
      }
    } catch (e) {
      // continue to fallback
    }

    // 3) try cookie (sync)
    try {
      const idCookie = getCookie('bermooda_playerId');
      if (idCookie) {
        // try to write back to localStorage if writable (migration)
        try {
          if (isLocalStorageWritable()) {
            try { localStorage.setItem('bermooda_playerId', idCookie); } catch(e) {}
          }
        } catch(e){}
        try { saveToIndexedDB('playerId', idCookie); } catch(e){}
        window.playerId = idCookie;
        return idCookie;
      }
    } catch (e) {
      // ignore
    }

    // 4) NOTHING found -> create new id
    const newId = generateUuid();
    window.playerId = newId;

    // try write to localStorage (best effort)
    try {
      if (isLocalStorageWritable()) {
        try { localStorage.setItem('bermooda_playerId', newId); }
        catch(e) { console.warn("localStorage.setItem failed while storing playerId:", e); }
      } else {
        // localStorage not writable â€” still try set (some browsers may accept but not persist)
        try { localStorage.setItem('bermooda_playerId', newId); } catch(e){}
      }
    } catch (e) {
      // ignore
    }

    // always set cookie (high probability to persist on iOS Safari)
    try { setCookie('bermooda_playerId', newId); } catch(e){}

    // asynchronously save to IndexedDB (if possible)
    try { saveToIndexedDB('playerId', newId); } catch(e){}

    // return synchronously
    return newId;

  } catch (err) {
    // ultimate fallback: generate a short fallback id and return
    try {
      const fallback = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : ('f-' + Date.now().toString(36) + Math.random().toString(36).slice(2,8));
      window.playerId = fallback;
      try { setCookie('bermooda_playerId', fallback); } catch(e){}
      try { saveToIndexedDB('playerId', fallback); } catch(e){}
      return fallback;
    } catch (e) {
      // last resort
      const last = 'x' + Date.now().toString(36);
      window.playerId = last;
      return last;
    }
  }
}



// === init player name and id ===



function initPlayer(onReady) {
  
  function ensurePlayerId() {
    if (typeof getOrCreatePlayerId === 'function') {
      return getOrCreatePlayerId();
    }
    // fallback Ø³Ø§Ø¯Ù‡
    try {
      let id = localStorage.getItem('bermooda_playerId');
      if (!id) {
        if (window.crypto && crypto.randomUUID) id = crypto.randomUUID();
        else id = 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
        try { localStorage.setItem('bermooda_playerId', id); } catch(e){}
      }
      window.playerId = id;
      return id;
    } catch (e) {
      const fallback = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
      window.playerId = fallback;
      return fallback;
    }
  }

  // helper: cleanup modal & style
  function removeModal(modal, styleEl) {
    try { if (modal && modal.parentNode) modal.parentNode.removeChild(modal); } catch(e){}
    try { if (styleEl && styleEl.parentNode) styleEl.parentNode.removeChild(styleEl); } catch(e){}
  }

  // create modal (only once per call) and return handlers
  function buildModal() {
    // css
    const css = `
      #nameModal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
                   background:rgba(0,0,0,0.5); z-index:99999; }
      #nameModal .card { background:#0d1117; color:#fff; padding:18px; border-radius:8px; width:360px; box-shadow:0 8px 30px rgba(0,0,0,0.6); font-family:system-ui, sans-serif; }
      #nameModal h3 { margin:0 0 8px 0; font-size:16px; }
      #nameModal p { margin:0 0 12px 0; font-size:14px; color:#ddd; }
      #nameModal .row { display:flex; gap:8px; margin-top:10px; }
      #nameModal button { flex:1; padding:8px 10px; border-radius:6px; border: none; cursor:pointer; font-weight:600; }
      #nameModal .btn-accept { background:#00c853; color:#000; }
      #nameModal .btn-other { background:#444; color:#fff; }
      #nameModal .input-row { display:flex; gap:8px; margin-top:12px; }
      #nameModal input[type="text"] { flex:1; padding:8px; border-radius:6px; border:1px solid #333; background:#0b1220; color:#fff; }
      #nameModal .btn-ok { background:#2196f3; color:#fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
      #nameModal .error { color:#ff6b6b; font-size:13px; margin-top:8px; display:none; }
    `;
    const styleEl = document.createElement('style');
    styleEl.textContent = css;
    document.head.appendChild(styleEl);

    const modal = document.createElement('div');
    modal.id = 'nameModal';
    modal.innerHTML = `
      <div class="card" role="dialog" aria-modal="true">
        <div id="stage-confirm">
          <h3 id="confirmTitle"></h3>
          <p id="confirmText"></p>
          <div class="row">
            <button class="btn-accept">Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù…</button>
            <button class="btn-other">Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±</button>
          </div>
        </div>

       <div id="stage-input" style="display:none; text-align:center;">
  <h3>Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h3>

  <div class="input-row" style="display:flex; flex-direction:column; align-items:center; gap:12px;">
    <input id="nameInput" type="text" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" style="width: 200px; padding: 8px; font-size:16px;">
    <button class="btn-ok" style="width:120px; padding:8px; font-size:16px;">ØªØ£ÛŒÛŒØ¯</button>
  </div>

  <div class="error" id="nameError" style="margin-top:10px; color:red; display:none;">
    Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Â«Ù†Ø§Ø´Ù†Ø§Ø³Â» Ø¨Ø§Ø´Ø¯)
  </div>
</div>
    `;
    document.body.appendChild(modal);

    // elements
    const btnAccept = modal.querySelector('.btn-accept');
    const btnOther = modal.querySelector('.btn-other');
    const stageConfirm = modal.querySelector('#stage-confirm');
    const stageInput = modal.querySelector('#stage-input');
    const input = modal.querySelector('#nameInput');
    const btnOk = modal.querySelector('.btn-ok');
    const err = modal.querySelector('#nameError');
    const title = modal.querySelector('#confirmTitle');
    const text = modal.querySelector('#confirmText');

    // helpers to show states
    function showConfirm(storedName) {
      title.innerText = `${storedName} Ø¹Ø²ÛŒØ²ØŒ`;
      text.innerText = `Ø¢ÛŒØ§ Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ÛŒØ§ Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŸ`;
      stageConfirm.style.display = '';
      stageInput.style.display = 'none';
      err.style.display = 'none';
      input.value = '';
    }
    function showInput() {
      stageConfirm.style.display = 'none';
      stageInput.style.display = '';
      err.style.display = 'none';
      input.value = '';
      setTimeout(()=> input.focus(), 50);
    }

    return {
      modal, styleEl,
      showConfirm, showInput,
      onAccept: (fn) => btnAccept.addEventListener('click', fn),
      onOther: (fn) => btnOther.addEventListener('click', fn),
      onOk: (fn) => btnOk.addEventListener('click', fn),
      getInputValue: () => input.value,
      showError: (t) => { err.innerText = t || 'Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Â«Ù†Ø§Ø´Ù†Ø§Ø³Â» Ø¨Ø§Ø´Ø¯)'; err.style.display = 'block'; },
      close: () => removeModal(modal, styleEl)
    };
  }

  // main flow
  try {
    const stored = (localStorage.getItem('bermooda_playerName') || '').trim();
    const ui = buildModal();

    // accept with stored name
    ui.onAccept(() => {
      const storedNow = (localStorage.getItem('bermooda_playerName') || '').trim();
      if (storedNow) {
        ui.close();
        // set name and continue
        window.playerName = storedNow;
        try { localStorage.setItem('bermooda_playerName', window.playerName); } catch(e){}
        ensurePlayerId();
        // update display if exists
        const dn = document.getElementById('playernameDisplay'); if (dn) dn.innerText = 'Player : ' + window.playerName;
        // notify server
      
        if (typeof onReady === 'function') onReady();
      } else {
        // no stored name unexpectedly -> show input
        ui.showInput();
      }
    });

    // choose other name -> show input
    ui.onOther(() => {
      ui.showInput();
    });

    // confirm new name
    ui.onOk(() => {
      const v = String(ui.getInputValue() || '').trim();
      if (!v || v === '' || v.toLowerCase() === 'Ù†Ø§Ø´Ù†Ø§Ø³') {
        ui.showError('Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Â«Ù†Ø§Ø´Ù†Ø§Ø³Â» Ø¨Ø§Ø´Ø¯)');
        return;
      }
      // valid name
      localStorage.setItem('bermooda_playerName', v);
      ui.close();
      window.playerName = v;
      ensurePlayerId();
      const dn = document.getElementById('playernameDisplay'); if (dn) dn.innerText = 'Player : ' + window.playerName;
     
      if (typeof onReady === 'function') onReady();
    });

    // initial show
    if (stored) ui.showConfirm(stored);
    else ui.showInput();

  } catch (err) {
    console.error("initPlayer modal failed:", err);
    // fallback: force prompt loop (non-modal)
    let name = '';
    const stored2 = (localStorage.getItem('bermooda_playerName') || '').trim();
    if (stored2) {
      if (confirm(stored2 + " Ø¹Ø²ÛŒØ²ØŒ Ø¢ÛŒØ§ Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŸ")) name = stored2;
    }
    while (!name) {
      const v = prompt("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ :") || '';
      const t = v.trim();
      if (t && t.toLowerCase() !== 'Ù†Ø§Ø´Ù†Ø§Ø³') { name = t; break; }
      alert("Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    }
    window.playerName = name;
    try { localStorage.setItem('bermooda_playerName', name); } catch(e){}
    ensurePlayerId();
  
    if (typeof onReady === 'function') onReady();
  }
}





async function checkUnreadMessages(playerId) {
    const res = await fetch(SHEET_WEBAPP, {
        method: "POST",
        body: new URLSearchParams({
            action: "unreadcount",
            playerId: playerId
        })
    });

    const data = await res.json();
    if (data.ok) {
        return data.unread;
    }
    return 0;
}

async function markMessagesAsRead(myId, otherId) {
    const res = await fetch(SHEET_WEBAPP, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
            action: "markread",
            myId: myId,       // Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ø³Ø±ÙˆØ±
            otherId: otherId
        })
    });

    const data = await res.json();
    
    return data.ok === true;
}



//----------------------------------------------------------------------------------------------------------------------------------------------------

let _offlineSent = false;      // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
let hiddenTimer = null;
const HIDDEN_CLOSE_MS = 8000;  // Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ ØªØ§ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ØªØ¨ Ù…Ø®ÙÛŒ Ø´Ø¯ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø²Ù†

function forceOffline() {
  if (_offlineSent) return;
  _offlineSent = true;

  try {
    stopPlaying();
    stopPresence(); // ØªØ§Ø¨Ø¹ Ø®ÙˆØ¯Øª Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú©Ù†

    // Ø§Ø±Ø³Ø§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ sendBeacon Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯
    const id = window.playerId || getOrCreatePlayerId();
    const name = window.playerName || (localStorage.getItem('bermooda_playerName') || "Ù†Ø§Ø´Ù†Ø§Ø³");

    const params = new URLSearchParams();
    params.append('action', 'presence');
    params.append('playerId', id);
    params.append('name', name);
    params.append('online', '0');
    params.append('device', navigator.userAgent || 'unknown');
    params.append('lastSeen', new Date().toISOString());

    const blob = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded' });

    if (navigator.sendBeacon) {
      navigator.sendBeacon(SHEET_WEBAPP, blob);
      return;
    }

    // fallback Ø¨Ø§ fetch keepalive
    fetch(SHEET_WEBAPP, { method: 'POST', body: params, keepalive: true }).catch(()=>{});

  } catch (e) {
    console.warn("forceOffline failed:", e);
  }
}

// pagehide
window.addEventListener('pagehide', () => {
stopPlaying();
  forceOffline();
}, { passive: true });

// beforeunload
window.addEventListener('beforeunload', () => {
stopPlaying();
  forceOffline();
}, { passive: true });

// visibilitychange
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
stopPlaying();
    if (hiddenTimer) clearTimeout(hiddenTimer);
    hiddenTimer = setTimeout(() => {
      forceOffline();
    }, HIDDEN_CLOSE_MS);
  } else {
    if (hiddenTimer) { clearTimeout(hiddenTimer); hiddenTimer = null; }
    // ÙˆÙ‚ØªÛŒ Ø¨Ø±Ú¯Ø´Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ùˆ
   markPlaying();
    sendPresence(true);
  }
}, { passive: true });

// blur
window.addEventListener('blur', () => {
  setTimeout(() => {
    if (document.hidden || document.visibilityState === 'hidden') {
      forceOffline();
    }
  }, 220);
}, { passive: true });

// freeze (Page Lifecycle API)
window.addEventListener('freeze', () => {
  forceOffline();
}, { passive: true });

//----------------------------------------------------------------------------------------------------------------------------------------------------



let __isPlayingFlag = false; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ


function markPlaying() {
const pid = window.playerId || getOrCreatePlayerId();
const name = window.playerName || "";


// Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù…Ú©Ø±Ø± Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ÙˆØ¶Ø¹ÛŒØª ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯Ù‡
if (__isPlayingFlag) return;
__isPlayingFlag = true;


const params = new URLSearchParams();
params.append('action', 'playing');
params.append('playerId', pid);
params.append('name', name);
params.append('t', Date.now()); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ø´Ø¯Ù†


fetch(SHEET_WEBAPP, {
method: 'POST',
headers: { "Content-Type": "application/x-www-form-urlencoded" },
body: params.toString(),
keepalive: true
}).catch(() => {});
}


function stopPlaying() {
const pid = window.playerId || getOrCreatePlayerId();
const name = window.playerName || "";


// ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ playing ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù‡
if (!__isPlayingFlag) return;
__isPlayingFlag = false;


const params = new URLSearchParams();
params.append('action', 'stopPlaying');
params.append('playerId', pid);
params.append('name', name);
params.append('t', Date.now());


fetch(SHEET_WEBAPP, {
method: 'POST',
headers: { "Content-Type": "application/x-www-form-urlencoded" },
body: params.toString(),
keepalive: true
}).catch(() => {});
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… (ÙØ±Ù…-Ø§Ù†Ú©Ø¯)
// Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„ ÛŒÚ© helper Ø¨Ø±Ø§ÛŒ uuid (Ø§Ú¯Ø± crypto.randomUUID Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨Ø§Ø´Ù‡ Ø§Ø²Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†)
function makeUUID() {
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random()*16|0, v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ sendChatMessage:
async function sendChatMessage(message, opts = {}) {
  if (!window.chatSenderId || !window.chatReceiverId) return;
  if (!message || !message.trim()) return;

  const msgId = opts.msgId || makeUUID();

  const body = new URLSearchParams();
  body.append('action','chat');
  body.append('fromId', window.chatSenderId);
  body.append('fromName', window.chatSenderName || "");
  body.append('toId', window.chatReceiverId);
  body.append('toName', window.chatReceiverName || "");
  body.append('message', message.trim());
  body.append('msgId', msgId);

  const res = await fetch(SHEET_WEBAPP, { method: 'POST', body });
  const json = await res.json().catch(()=>null);
  // Ø³Ø±ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± Ù¾Ø§Ø³Ø® ts Ùˆ msgId Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ø› Ø§Ú¯Ø± Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¢Ù† Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ
  return Object.assign(json||{}, { msgId });
}







// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… (ÙØ±Ù…-Ø§Ù†Ú©Ø¯)
// Ø­Ø°Ù ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù† Ù‡Ø± setInterval Ù‚Ø¯ÛŒÙ…ÛŒ Ú©Ù‡ innerHTML Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒØ³Ø§Ø®Øª.
// Ø§Ø² Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†:

/* ----------------- Chat rendering (replacement) ----------------- */


function renderChatMessage(msgObj) {
  // msgObj: { fromId, fromName, message, ts }
  const meId = window.chatSenderId || window.playerId;
  const isMe = String(msgObj.fromId || '') === String(meId);

  const row = document.createElement('div');
  row.className = 'chat-row ' + (isMe ? 'me' : 'other');

  // meta (optional) - Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
  if (!isMe) {
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = msgObj.fromName || 'Ù†Ø§Ø´Ù†Ø§Ø³';
    // Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ø±Ùˆ ÙØ¹Ø§Ù„ ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒ:
    // row.appendChild(meta);
  }

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  const text = document.createElement('div');
  text.className = 'text';
  text.innerHTML = escapeHtml(String(msgObj.message || ''));

  const time = document.createElement('div');
  time.className = 'time';
  try {
    const t = msgObj.ts ? new Date(Number(msgObj.ts)) : new Date();
    time.textContent = formatTime(t);
  } catch(e) {
    time.textContent = '';
  }

  bubble.appendChild(text);
  bubble.appendChild(time);
  row.appendChild(bubble);

  const chatList = document.getElementById('chatList');
  if (!chatList) return;

  chatList.appendChild(row);
  // Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
  chatList.scrollTop = chatList.scrollHeight;
}

/** Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡: fetch Ø³Ø§Ø¯Ù‡ Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ø¨Ø§ caching Ø³Ø§Ø¯Ù‡) */
async function fetchChatMessagesAndRender() {
  if (!window.chatSenderId || !window.chatReceiverId) return;
  window.chatState = window.chatState || {};
  const key = `${window.chatSenderId}_${window.chatReceiverId}`;
  if (!window.chatState[key]) {
   //window.chatState[key] = { lastTs: 0, seenIds: new Set(), fetching: false };

  }
  const state = window.chatState[key];
  if (state.fetching) return;
  state.fetching = true;

  try {
    const body = new URLSearchParams();
    body.append('action', 'fetchchat');
    body.append('playerId', window.chatSenderId);
    body.append('peerId', window.chatReceiverId);
    body.append('lastTs', String(state.lastTs || 0));

    const res = await fetch(SHEET_WEBAPP, { method: 'POST', body });
    const data = await res.json().catch(()=>null);
    const msgs = Array.isArray(data) ? data : (data.messages || []);

    if (!Array.isArray(msgs) || msgs.length === 0) {
      state.fetching = false;
      // Ø§Ø¯Ø§Ù…Ù‡ polling Ø³Ø¨Ú©
      setTimeout(fetchChatMessagesAndRender, 500);
      return;
    }

    let added = 0;
    for (const m of msgs) {
      const tsNum = Number(m.ts) || Date.now();
      // ÛŒÚ© id ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù¾ÛŒØ§Ù… (Ø³Ø±ÙˆØ± Ù…Ù…Ú©Ù† Ø§Ø³Øª msgId ÛŒØ§ ts Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
      const idKey = (m.msgId ? m.msgId : `${m.fromId}_${tsNum}_${String(m.message||'').slice(0,30)}`);

      if (state.seenIds.has(idKey)) continue;
      state.seenIds.add(idKey);
      

      // render
      renderChatMessage({
        fromId: m.fromId,
        fromName: m.fromName || m.from || '',
        message: m.message || '',
        ts: tsNum
      });

      state.lastTs = Math.max(state.lastTs || 0, tsNum);
      added++;
    }

    // Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù† (renderChatMessage Ø®ÙˆØ¯Ø´ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒÚ©Ù†Ù‡)
    state.fetching = false;
    setTimeout(fetchChatMessagesAndRender, 600);
  } catch (err) {
    console.error('fetchChatMessagesAndRender error', err);
    state.fetching = false;
    setTimeout(fetchChatMessagesAndRender, 1200);
  }
}

/* Send button handler (Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² sendChatMessage Ù…ÙˆØ¬ÙˆØ¯) */
const chatSendBtn = document.getElementById('chatSendBtn');
const chatInput = document.getElementById('chatInput');

if (chatSendBtn && chatInput) {

  chatSendBtn.addEventListener('click', async () => {
    const txt = (chatInput.value || '').trim();
    if (!txt) return;

    // â— Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯ÛŒÙ… (Ø§ÛŒÙ† Ø®Ø· Ø¯ÛŒÚ¯Ø± Ù†Ø¨Ø§ÛŒØ¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯)
    // renderChatMessage(...)

    chatInput.value = '';

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø³Ø±ÙˆØ± ÙÙ‚Ø· Ù‡Ù…ÛŒÙ†!
    try {
      await sendChatMessage(txt, { msgId: makeUUID() });
      // Ù¾ÛŒØ§Ù… Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ polling Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯
    } catch (e) {
      console.error('sendChatMessage failed', e);
    }
  });

  // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      chatSendBtn.click();
    }
  });
}


/* Ø¨Ø§Ø²/Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª */
const closeChatBtn = document.getElementById('closeChatBtn');
if (closeChatBtn) {
  closeChatBtn.addEventListener('click', () => {
    document.getElementById('chatOverlay').style.display = 'none';
  });
}


// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª
async function openChatWindow() {
    document.getElementById('chatOverlay').style.display = 'flex';
    document.getElementById('chatComposer').style.display = 'flex'; 
    const title = document.getElementById('chatTitle');

    if (window.chatReceiverName) {
        title.innerText = `Chat with ${window.chatReceiverName}`;
    }

    document.getElementById('chatInput').focus();

    if (window.playerId && window.chatReceiverId) {
        await markMessagesAsRead(window.playerId, window.chatReceiverId);
    }
}


// Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter
document.getElementById('chatInput').addEventListener('keydown', (e) => {
 if (e.key === 'Enter') {
        e.preventDefault();               // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØªÙ† Ú©Ø±Ø³Ø± Ø¨Ù‡ Ø®Ø· Ø¨Ø¹Ø¯
        document.getElementById('chatSendBtn').click(); // Ù‡Ù…Ø§Ù† Ú©Ø¯ Ú©Ù„ÛŒÚ© Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
}
});




function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}




let fuelAlarm = new Audio("sounds/gasAlert.mp3");
fuelAlarm.loop = true;     // ØµØ¯Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø± ØªÚ©Ø±Ø§Ø± Ø´ÙˆØ¯ ØªØ§ ÙˆÙ‚ØªÛŒ Ø³ÙˆØ®Øª Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³Øª
fuelAlarm.volume = 0.50;    // Ø´Ø¯Øª ØµØ¯Ø§
let fuelAlarmActive = false; // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø®Ø´ Ø¯ÙˆØ¨Ø§Ø±Ù‡


// ğŸ”Š Ø¢Ø±Ø§ÛŒÙ‡ ØµØ¯Ø§Ù‡Ø§ÛŒ Ø§Ù†ÙØ¬Ø§Ø±
let explosionSounds = [];
// ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµØ¯Ø§Ù‡Ø§
function loadExplosionSounds() {
  for (let i = 1; i <= 6; i++) {
    const sound = new Audio(`sounds/explosion/explosion${i}.wav`);
    sound.volume = 1; // Ø­Ø¬Ù… ØµØ¯Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨
    explosionSounds.push(sound);
  }
}




let animationId = null;  // Ø´Ù†Ø§Ø³Ù‡ Ø­Ù„Ù‚Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
let airplane = { x: canvas.width / 2, y: canvas.height - 200, w: 50, h: 50 };
let selectedPlaneImg =""; // ØªØµÙˆÛŒØ± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
let selectedPlane = null;
let lastMissileBonusLevel = 0;
document.querySelectorAll('.plane').forEach(plane => {
  plane.addEventListener('click', () => {
    // Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
    document.querySelectorAll('.plane').forEach(p => p.classList.remove('selected'));
    
    // Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ø¯ÛŒØ¯
    plane.classList.add('selected');
    selectedPlane = plane.dataset.plane;

   

    // Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ØŒ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    startBtn.style.display = "block";
    scoreBtn.style.display = "block";
    exitBtn.style.display = "block";
  });
});

let meteorExplosions = []; // Ø°Ø±Ø§Øª ÙØ¹Ø§Ù„ Ø§Ù†ÙØ¬Ø§Ø± Ø´Ù‡Ø§Ø¨â€ŒØ³Ù†Ú¯
let meteors = [];
let lastMeteorSpawn = performance.now();
const meteorImages = [];
const meteorCount = 4;
for (let i = 1; i <= meteorCount; i++) {
  const img = new Image();
  img.src = `sang${i}.png`;
  meteorImages.push(img);
}


function spawnMeteor() {
  // Ù‡Ø± 15 Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ© Ø´Ù‡Ø§Ø¨ Ø³Ù†Ú¯
  if (performance.now() - lastMeteorSpawn < 20000) return;
  lastMeteorSpawn = performance.now();

  const img = meteorImages[Math.floor(Math.random() * meteorImages.length)];
  const size = Math.random() * 60 + 50; // Ø³Ø§ÛŒØ² Ø¨ÛŒÙ† 70 ØªØ§ 120
  const direction = Math.random() < 0.5 ? "right" : "left";
  const rotationSpeed = (Math.random() * 5 + 1) * (Math.random() < 0.5 ? -1 : 1); // Ø³Ø±Ø¹Øª Ú†Ø±Ø®Ø´ ØªØµØ§Ø¯ÙÛŒ

  let startX, startY, vx, vy;
  startY = -size; // Ø´Ø±ÙˆØ¹ Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡

  if (direction === "right") {
    startX = -size;
    vx = Math.random() * 1.2 + .6; // Ø§Ø² Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª
  } else {
    startX = canvas.width + size;
    vx = -(Math.random() * 1.2 + .6); // Ø§Ø² Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾
  }

  vy = Math.random() * 1.2 + .6; // Ø­Ø±Ú©Øª Ø±Ùˆ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†

  meteors.push({
    x: startX,
    y: startY,
    w: size,
    h: size,
    vx,
    vy,
    rotation: Math.random() * 360,
    rotationSpeed,
    img
  });
}


function showHelpImages() {
    const gameContainer = document.getElementById("game-container") || document.body;

    const images = [
        { src: "help.png", duration: 3000, bottom: "110px", right: "70px" }, // ØªØµÙˆÛŒØ± Ø§ÙˆÙ„
        { src: "help2.png", duration: 3000, bottom: "110px", left: "60px" }  // ØªØµÙˆÛŒØ± Ø¯ÙˆÙ…
    ];

    let delay = 0;

    images.forEach(imgData => {
        setTimeout(() => {
            const img = document.createElement("img");
            img.src = imgData.src;
            img.style.position = "absolute";
            img.style.bottom = imgData.bottom;
            img.style.right = imgData.right;
            img.style.left = imgData.left;
            img.style.width = "150px";
            img.style.height = "auto";
            img.style.zIndex = "1500";
            img.classList.add("help-img"); // Ø¨Ø±Ø§ÛŒ Ú†Ø´Ù…Ú© Ø²Ø¯Ù†
            gameContainer.appendChild(img);
            
            setTimeout(() => {
                img.style.transition = "opacity 0.6s ease";
                img.style.opacity = "0";
                setTimeout(() => img.remove(), 500);
            }, imgData.duration);
        }, delay);

        delay += imgData.duration + 500; 

    });
}








function addScore(points, enemyCount = 1) {
  // Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø´Ù…Ù†
  score += points * enemyCount;
   window.score = score;

  // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·Ø­ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø¯Ø§Ø´ Ù…ÙˆØ´Ú©
  let newLevel = Math.floor(score / 50);
  if (newLevel > lastMissileBonusLevel) {
    missiles += (newLevel - lastMissileBonusLevel);
    lastMissileBonusLevel = newLevel;
  }

  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
  document.getElementById("scoreValue").textContent = score;
  updateMissileBtn();
}


// ===== Ø§Ù†ÙØ¬Ø§Ø± Ø°Ø±Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ù„Ø±Ø²Ø´ Ùˆ Ù†ÙˆØ± =====
function createMeteorExplosion(x, y, power = 1) {
  const colors = [
    "#3a2e1e", "#5b3c1a", "#8B4513", "#d2691e", 
    "#ff6600", "#ff9933", "#ffd580", "#b0b0b0"
  ];
  const num = Math.floor(14 + 12 * Math.min(3, Math.max(0.5, power)));
  const particles = [];

  // ğŸ”¶ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†ÙˆØ± Ø§Ù†ÙØ¬Ø§Ø± Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ
  explosionFlashes.push({
    x, y,
    radius: 50 + power * 40,
    alpha: 0.6,
    decay: 0.09
  });

  // ğŸ”¶ Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡
  startScreenShake(10, 600);

  for (let i = 0; i < num; i++) {
    const angle = Math.random() * Math.PI * 2;
    const baseSpeed = (1 + Math.random() * 6) * (0.6 + 0.6 * power);
    const vx = Math.cos(angle) * baseSpeed * (0.6 + Math.random() * 0.9);
    const vy = Math.sin(angle) * baseSpeed * (0.6 + Math.random() * 0.9) - (0.8 + Math.random() * 1.8) * power;

    // Ø´Ú©Ù„â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…Ù†Ø¸Ù…
    const verts = [];
    const vertCount = 3 + Math.floor(Math.random() * 3);
    for (let v = 0; v < vertCount; v++) {
      const r = 0.3 + Math.random() * 1;
      const a = (v / vertCount) * Math.PI * 2 + (Math.random() - 0.5) * 0.6;
      verts.push({ x: Math.cos(a) * r, y: Math.sin(a) * r });
    }

    particles.push({
      x: x + (Math.random() - 0.5) * 10 * power,
      y: y + (Math.random() - 0.5) * 10 * power,
      vx, vy,
      size: 3 + Math.random() * 5 * (0.6 + 0.4 * power),
      color: colors[Math.floor(Math.random() * colors.length)],
      life: 1 + Math.random() * 0.7,
      decay: 0.025 + Math.random() * 0.05,
      drag: 0.91 + Math.random() * 0.06,
      gravity: 0.04 + Math.random() * 0.1,
      rotation: Math.random() * 360,
      angularVelocity: (Math.random() - 0.5) * 4,
      shape: Math.random() < 0.6 ? "shard" : (Math.random() < 0.5 ? "ember" : "chunk"),
      verts,
      flickerSeed: Math.random() * 10,
      wobble: Math.random() * 0.5
    });
  }

  meteorExplosions.push({ particles, created: performance.now() });
  if (navigator.vibrate) navigator.vibrate(50);

}


// ===== Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ùˆ Ø±Ø³Ù… Ø§Ù†ÙØ¬Ø§Ø± =====
function updateMeteorExplosions() {
  const now = performance.now();
  const last = updateMeteorExplosions._last || now;
  const dtSec = Math.min(0.06, (now - last) / 1000);
  updateMeteorExplosions._last = now;
  const step = dtSec * 60;

  for (let i = meteorExplosions.length - 1; i >= 0; i--) {
    const group = meteorExplosions[i];
    const particles = group.particles;
    let alive = false;

    for (let j = particles.length - 1; j >= 0; j--) {
      const p = particles[j];
      p.vy += p.gravity * step;
      p.vx *= Math.pow(p.drag, step);
      p.vy *= Math.pow(p.drag, step);
      p.x += p.vx * step;
      p.y += p.vy * step;
      p.rotation += p.angularVelocity * step;
      p.life -= p.decay * step;
      if (p.life < 0) p.life = 0;
      p.size *= Math.pow(0.996, step);

      if (p.y > canvas.height - 2) {
        p.y = canvas.height - 2;
        p.vy *= -0.35;
        p.vx *= 0.6;
        p.life -= 0.03 * step;
      }

      const flick = 0.8 + 0.3 * Math.sin((now / 1000) * (1 + p.flickerSeed));
      const wob = Math.sin((now / 300) * (1 + p.wobble)) * (p.size * 0.02);

      ctx.save();
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life * flick));
      ctx.translate(p.x + wob, p.y);

      if (p.shape === "shard") {
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.beginPath();
        for (let k = 0; k < p.verts.length; k++) {
          const v = p.verts[k];
          const vx = v.x * p.size * 0.45;
          const vy = v.y * p.size * 0.45;
          if (k === 0) ctx.moveTo(vx, vy);
          else ctx.lineTo(vx, vy);
        }
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      } else if (p.shape === "ember") {
        const r = Math.max(0.5, p.size / 2);
        const g = ctx.createRadialGradient(0,0,0,0,0,r);
        g.addColorStop(0, p.color);
        g.addColorStop(0.4, "rgba(255,180,80,0.6)");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(0,0,r,0,Math.PI*2);
        ctx.fill();
      } else {
        ctx.rotate(p.rotation * Math.PI / 180);
        ctx.fillStyle = p.color;
        ctx.fillRect(-p.size/2, -p.size/3, p.size, p.size*0.66);
      }

      ctx.restore();
      if (p.life > 0.03 && p.size > 0.5) alive = true;
      if (p.life <= 0.03 || p.size < 0.5) particles.splice(j, 1);
    }

    if (!alive) meteorExplosions.splice(i, 1);
  }

  ctx.globalAlpha = 1;
}


// ===== Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡ =====
let screenShake = { strength: 0, duration: 0, start: 0 };
function startScreenShake(strength, duration) {
  screenShake = { strength, duration, start: performance.now() };
}

function applyScreenShake() {
  if (!screenShake.duration) return;
  const elapsed = performance.now() - screenShake.start;
  if (elapsed > screenShake.duration) {
    screenShake.strength = 0;
    screenShake.duration = 0;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    return;
  }
  const intensity = screenShake.strength * (1 - elapsed / screenShake.duration);
  const dx = (Math.random() - 0.5) * intensity;
  const dy = (Math.random() - 0.5) * intensity;
  ctx.setTransform(1, 0, 0, 1, dx, dy);
}


// ===== Ù†ÙˆØ± Ø§Ù†ÙØ¬Ø§Ø± =====
let explosionFlashes = [];
function updateExplosionFlashes() {
  for (let i = explosionFlashes.length - 1; i >= 0; i--) {
    const f = explosionFlashes[i];
    const g = ctx.createRadialGradient(f.x, f.y, 0, f.x, f.y, f.radius);
    g.addColorStop(0, `rgba(255,180,80,${f.alpha})`);
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(f.x - f.radius, f.y - f.radius, f.radius * 2, f.radius * 2);
    f.alpha -= f.decay;
    if (f.alpha <= 0) explosionFlashes.splice(i, 1);
  }
}




let bullets = [];

let invincible = false; // Ù…ØµÙˆÙ† Ø¨ÙˆØ¯Ù† Ù…ÙˆÙ‚Øª
let respawnTime = 0;    // Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ù…ØµÙˆÙ†ÛŒØª  
let lastBulletTime = 0;
const bulletInterval = 200; // ÙØ§ØµÙ„Ù‡ Ø´Ù„ÛŒÚ© Ø¨Ø± Ø­Ø³Ø¨ Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡


let backgroundAnimation=null;
function animateGameOverBackground() {
  drawBackground(); // ÙÙ‚Ø· Ø¢Ø³Ù…Ø§Ù† Ø´Ø¨ Ùˆ Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§
  backgroundAnimation = requestAnimationFrame(animateGameOverBackground);
ctx.save();
const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
gradient.addColorStop(0, "#ff0000");
gradient.addColorStop(0.5, "#ff4d4d");
gradient.addColorStop(1, "#ff0000");
ctx.fillStyle = gradient;
ctx.shadowColor = "red";
ctx.shadowBlur = 30;
ctx.font = "bold 50px Arial Black";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2.6);
ctx.shadowColor = "white";
ctx.shadowBlur = 10;
ctx.fillStyle = "white";
ctx.font = "bold 32px Arial";
ctx.fillText("Your Score : " + score, canvas.width * 0.5, canvas.height * 0.47);
ctx.restore();

}

let lastDifficultyIncrease = performance.now();
let speedMultiplier = 1; // Ø¶Ø±ÛŒØ¨ Ø³Ø±Ø¹Øª Ú©Ù„ Ø¯Ø´Ù…Ù†Ø§Ù†
let enemies = [];
let playerName = "";
let score = 0;
let gameRunning = false;
const pauseBtn = document.getElementById("pauseBtn");
let paused = false;
let pauseTime = 0;
pauseBtn.addEventListener("click", () => {
  if (!paused) {
    // â¸ ÙˆÙ‚ØªÛŒ Ø¨Ø§Ø²ÛŒ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯
    paused = true;
    pauseTime = performance.now();
    pauseBtn.innerHTML = "â–¶"; // Ø¹Ù„Ø§Ù…Øª Play Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Pause
    // ğŸ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙˆÛŒ Pause
    continueBtn.style.display = "block";
    startBtn.style.display = "block";
    exitBtn.style.display = "block";

    // Ø¬Ø§ÛŒÚ¯Ø°Ø§Ø±ÛŒ Ø²ÛŒØ¨Ø§ ÙˆØ³Ø· ØµÙØ­Ù‡
    continueBtn.style.position = "absolute";
    continueBtn.style.top = "45%";
    continueBtn.style.left = "50%";
    continueBtn.style.transform = "translate(-50%, -50%)";

    startBtn.style.position = "absolute";
    startBtn.style.top = "55%";
    startBtn.style.left = "50%";
    startBtn.style.transform = "translate(-50%, -50%)";

    exitBtn.style.position = "absolute";
    exitBtn.style.top = "65%";
    exitBtn.style.left = "50%";
    exitBtn.style.transform = "translate(-50%, -50%)";

  } else {
    // â–¶ ÙˆÙ‚ØªÛŒ Ø¨Ø§Ø²ÛŒ Ø§Ø² Pause Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    paused = false;
    const now = performance.now();
    lastTime += (now - pauseTime);
    pauseBtn.innerHTML = "â¸"; // Ø¹Ù„Ø§Ù…Øª Pause Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡

    // ğŸ”¹ Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§Ø²ÛŒ
    continueBtn.style.display = "none";
    startBtn.style.display = "none";
    exitBtn.style.display = "none";

 
cancelAnimationFrame(animationId); 
animationId = null;
animationId = requestAnimationFrame(gameLoop);
  }
});


let fuelLabels = []; // Ø¢Ø±Ø§ÛŒÙ‡ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§
let gameOverBackground = false;
let lives = 3;
let dx = 0, dy = 0; 
let explosionRunning = false;
let fuel = 100; 
let lastFuelSpawn = performance.now();
let fuels = [];
let lastShotTime = 0;
const shootDelay = 70; // Ù‡Ø± 80 Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ ÛŒÚ© Ú¯Ù„ÙˆÙ„Ù‡
let explosions = []; // Ø§Ù†ÙØ¬Ø§Ø±Ù‡Ø§
let lastTime = performance.now();
// Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ ÙØ§ÛŒÙ„
let refueling = false; // Ø¢ÛŒØ§ Ø³ÙˆØ®ØªÚ¯ÛŒØ±ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³ØªØŸ
let refuelRate = 0.4; // Ù…ÛŒØ²Ø§Ù† Ø³ÙˆØ®Øª Ø¯Ø± Ù‡Ø± ÙØ±ÛŒÙ… Ù‡Ù†Ú¯Ø§Ù… Ø³ÙˆØ®ØªÚ¯ÛŒØ±ÛŒ


// ===== Ù„ÙˆØ¯ 9 ÙØ±ÛŒÙ… Ø§Ù†ÙØ¬Ø§Ø± =====
const explosionFrames = [];
for (let i = 1; i <= 9; i++) {
  const img = new Image();
  img.src = `ex/ex${i}.png`;
  explosionFrames.push(img);
}


const fuelImg = new Image();
fuelImg.src = "fuel.png"; // Ù…Ø³ÛŒØ± ØªØµÙˆÛŒØ± Ù¾Ù…Ù¾ Ø¨Ù†Ø²ÛŒÙ†Øª
  
let enemyBullets = [];

// ØªØ¹ÛŒÛŒÙ† Ú¯Ø±ÛŒØ¯ Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø²
let bulletGrade = 1; // Ù¾ÛŒØ´ÙØ±Ø¶
let bulletSpeed = 10; // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡
function updateBulletGrade(score) {
  if (score >= 2000) bulletGrade = 3;
  else if (score >= 1000) bulletGrade = 2;
  else bulletGrade = 1;
}



  let displayedFuel = 100; 
  const noFlyZoneHeight = 100; 
  



   const missileImages = [
  "mooshak.png",
  "mooshak2.png",
  ].map(src => {
  const img = new Image();
  img.src = src;
  return img;
  });



window.imageSources = window.imageSources || [];   // Ø¢Ø±Ø§ÛŒÙ‡ Ù…Ø³ÛŒØ±Ù‡Ø§ (Ù…Ù…Ú©Ù†Ù‡ Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ)
window.loadedImages = window.loadedImages || {};   // Ù…Ø­Ù„ Ø°Ø®ÛŒØ±Ù‡ ØªØµØ§ÙˆÛŒØ± Ù„ÙˆØ¯Ø´Ø¯Ù‡
let missiles = 0; // ØªØ¹Ø¯Ø§Ø¯ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§
let activeMissiles = []; // Ù„ÛŒØ³Øª Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø±Ú©Øª
let missileBtn = document.getElementById("missileBtn");
// âœ… Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… ØªØµØ§ÙˆÛŒØ±
  
window.imageSources = [
  "airplane.png",
  "fuel.png",
  "mooshak.png", 
  "mooshak2.png", 
  "plane1.png", "plane2.png", "plane3.png", "plane4.png",
  "plane6.png", "plane8.png", "plane10.png", "plane12.png",
  "plane30.png","plane31.png","plane32.png","plane33.png","plane34.png",
  "sang1.png","sang2.png","sang3.png","sang4.png",
  "cloud1.png", "cloud2.png", "cloud3.png",
  "Startbackground/a.png","Startbackground/b.png","Startbackground/c.png",
  "Startbackground/d.png","Startbackground/e.png"
];


let loadedCount = 0;
const totalImages = window.imageSources.length;
const loadingText = document.getElementById("loadingText");
const progressFill = document.getElementById("progressFill");
const loadingScreen = document.getElementById("loadingScreen");



  let keys = {
  left: false,
  right: false,
  up: false,
  down: false,
  space: false
  };


const airplaneImg = new Image();
airplaneImg.src = "airplane.png";
// âœˆï¸ ØªØµØ§ÙˆÛŒØ± Ø¯Ø´Ù…Ù†â€ŒÙ‡Ø§
const enemyImages = [
  "plane1.png",
  "plane2.png",
  "plane3.png",
  "plane4.png",
  "plane6.png",
  "plane8.png",
  "plane10.png",
  "plane12.png",
  ].map(src => {
  const img = new Image();
  img.src = src;
  return img;
  });



let shootInterval = null;
const shootBtn = document.getElementById("shoot");















  // ğŸ¨ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…ØªØ­Ø±Ú© Ø¢Ø³Ù…Ø§Ù†
  let clouds = [];
  const cloudImages = ["cloud1.png", "cloud2.png", "cloud3.png"].map(src => {
  const img = new Image();
  img.src = src;
  return img;
  });

// Ø³Ø§Ø®Øª Ú†Ù†Ø¯ Ø§Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØµØ§Ø¯ÙÛŒ
    for (let i = 0; i < 6; i++) {
    clouds.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    speed: 0.2 + Math.random() * 0.3,
    img: cloudImages[Math.floor(Math.random() * cloudImages.length)],
    size: 70 + Math.random() * 70
  });
}







function preloadImages(callback) {
  // Ø§ÛŒÙ…Ù†â€ŒØ³Ø§Ø²ÛŒ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ UI Ú©Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  const scoreContainerEl = document.getElementById("scoreContainer");
  const progressFillEl = typeof progressFill !== 'undefined' ? progressFill : document.querySelector('.progress-fill');
  const loadingTextEl = typeof loadingText !== 'undefined' ? loadingText : document.querySelector('.loading-text');


  // Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø±Ø¯Ù† ÙØ±ÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø§Ù†ÙØ¬Ø§Ø± Ø§Ù…Ø§ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
  for (let i = 1; i <= 9; i++) {
    const path = `ex/ex${i}.png`;
    if (!window.imageSources.includes(path)) window.imageSources.push(path);
  }

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† 5 Ø¨Ú©â€ŒÚ¯Ø±Ø§Ù†Ø¯ Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ (Ø§Ø³Ø§Ù…ÛŒ Ø«Ø§Ø¨Øª Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯)
  const bgPaths = [
    "Startbackground/a.png",
    "Startbackground/b.png",
    "Startbackground/c.png",
    "Startbackground/d.png",
    "Startbackground/e.png"
  ];
  bgPaths.forEach(p => { if (!window.imageSources.includes(p)) window.imageSources.push(p); });

  const totalImages = window.imageSources.length;
  if (totalImages === 0) {
    // Ù‡ÛŒÚ† ØªØµÙˆÛŒØ±ÛŒ Ù†ÛŒØ³Øª â€” Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
    return Promise.resolve().then(() => callback && callback());
  }

  let loadedCount = 0;
  let finished = false; // Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ú©Ù‡ Ø¨Ù„ÙˆÚ© Ù¾Ø§ÛŒØ§Ù† ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯

  function markOne(src, img) {
     window.loadedImages[src] = img;
     loadedCount++;
     console.log(` Loaded: ${src}  |  Size: ${img.width}x${img.height}`);
    // Ø¢Ù¾Ø¯ÛŒØª UI Ù¾Ø±Ø§Ú¯Ø±Ø³ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª
    if (progressFillEl) {
      const percent = Math.floor((loadedCount / totalImages) * 100);
      progressFillEl.style.width = percent + "%";
      if (loadingTextEl) loadingTextEl.innerText = `Loading ${percent}% - ${src}`;
    }

    if (loadedCount >= totalImages && !finished) {
  console.log("âœ… ALL IMAGES LOADED:", Object.keys(loadedImages));
      finished = true;
      // Ø³Ø§Ø®Øª explosionFrames Ø§ÛŒÙ…Ù† (ÙÙ‚Ø· Ù…ÙˆØ§Ø±Ø¯ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†)
      window.explosionFrames = [];
      for (let i = 1; i <= 9; i++) {
        const p = `ex/ex${i}.png`;
        if (window.loadedImages[p]) window.explosionFrames.push(window.loadedImages[p]);
      }

      // Ø­Ø§Ù„Ø§ ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡â€ŒÛŒ Ø´Ø±ÙˆØ¹ Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø§ÛŒÙ…Ù† Ø¨Ø¯Ù‡ÛŒÙ…
      // Ø§Ú¯Ø± getOrCreatePlayerId sync ÛŒØ§ async Ø¨Ø§Ø´Ø¯ØŒ Promise.resolve Ú©Ø§Ø± Ù‡Ø± Ø¯Ùˆ Ø±Ø§ Ù¾ÙˆØ´Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
      Promise.resolve().then(() => {
        return Promise.resolve(getOrCreatePlayerId && getOrCreatePlayerId());
      }).then(() => {
        // initPlayer Ù…Ù…Ú©Ù† Ø§Ø³Øª async Ø¨Ø§Ø´Ø¯ ÛŒØ§ callback Ú¯ÙˆÙ†Ù‡Ø› Ù…Ø§ Ø¢Ù† Ø±Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Promise Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±ÛŒÙ…
        return new Promise((resInit) => {
          try {
            // Ø§Ú¯Ø± initPlayer ÙˆØ±ÙˆØ¯ÛŒ callback Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ø¯ Ùˆ Ù‡Ù…Ø§Ù† Ø±ÙØªØ§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
            initPlayer && initPlayer(async () => {
              try {
                startPresence && startPresence();
                window.chatSenderId = window.playerId;
                window.chatSenderName = window.playerName;

                // Ø§Ú¯Ø± loadAndShowUnread Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø¯Ø§Ø±Ø¯ Ø§Ø² window.playerId Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                if (typeof loadAndShowUnread === 'function') {
                  await loadAndShowUnread(window.playerId);
                }

                // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù† (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
                const nameEl = document.getElementById("playernameDisplay");
                if (nameEl) nameEl.innerText = 'Player : ' + (window.playerName || '');

                // Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ (Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª)
                if (typeof checkUnreadMessages === 'function') {
                  const unread = await checkUnreadMessages(window.playerId);
                  if (unread > 0) {
                    // optional alert or handling
                  }
                }
              } finally {
                resInit();
              }
            });
          } catch (err) {
            // Ø§Ú¯Ø± initPlayer Ø¨Ù‡ ØµÙˆØ±Øª sync Ø§Ø³Øª ÛŒØ§ Ø®Ø·Ø§ Ø¯Ø§Ø¯ØŒ ÙÙ‚Ø· resolve Ú©Ù†
            console.warn('initPlayer wrapper warning', err);
            resInit();
          }
        });
      }).then(() => {
        // Ù‡Ù…Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯ â€” ØµØ¯Ø§ Ø²Ø¯Ù† callback Ø§ØµÙ„ÛŒ (safe)
        if (typeof callback === 'function') callback();
      }).catch(err => {
        console.error('Error during preload finalization', err);
        if (typeof callback === 'function') callback();
      });
    }
  }

  // Ø´Ø±ÙˆØ¹ Ù„ÙˆØ¯ Ù‡Ù…Ù‡Ù” ØªØµØ§ÙˆÛŒØ±
  window.imageSources.forEach(src => {
    // Ø§Ú¯Ø± ØªØµÙˆÛŒØ± Ù‚Ø¨Ù„Ø§ Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ùˆ Ú©Ø§Ù…Ù„ Ø§Ø³ØªØŒ Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if (window.loadedImages[src] && window.loadedImages[src] instanceof HTMLImageElement && window.loadedImages[src].complete) {
      markOne(src, window.loadedImages[src]);
      return;
    }

    const img = new Image();
    img.onload = () => markOne(src, img);
    img.onerror = (err) => {
      console.warn("âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±:", src, err);
      // Ù‡Ù†ÙˆØ² ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª image Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ú©Ù„ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ (even if broken)
      window.loadedImages[src] = img;
      markOne(src, img);
    };
    img.src = src;
  });
}



// âœ… ÙˆÙ‚ØªÛŒ Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ± Ù„ÙˆØ¯ Ø´Ø¯Ù†:
preloadImages(() => {
  progressFill.style.width = "100%";

  setTimeout(() => {
    loadingScreen.style.opacity = 0;
    loadingScreen.style.transition = "opacity 0.8s ease";
    loadingScreen.remove();

    startBtn.style.display = "block";
    scoreBtn.style.display = "block";
    exitBtn.style.display = "block";
    document.getElementById("gameTitle").style.display = "block";
(function(){
    const bgPaths = [
        "Startbackground/a.png",
        "Startbackground/b.png",
        "Startbackground/c.png",
        "Startbackground/d.png",
       "Startbackground/e.png"
    ];

    const chosen = bgPaths[Math.floor(Math.random() * bgPaths.length)];

    const bgEl = document.getElementById('gameBackground');
    bgEl.style.backgroundImage = `url("${chosen}")`;

    // Ø¸Ø§Ù‡Ø± Ø´Ø¯Ù† Ø¨Ø§ fade
    requestAnimationFrame(() => {
        bgEl.style.opacity = "1";
    });

    // Ù…Ø­Ùˆ Ø´Ø¯Ù† Ù‡Ù†Ú¯Ø§Ù… Ø²Ø¯Ù† Start
    startBtn.addEventListener('click', () => {
        bgEl.classList.add('fadeOutBg');
    });
})();
    
  // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§
 

(function setupArc() {
  const arcContainer = document.getElementById('airplaneArcContainer');
  const arc = document.getElementById('airplaneArc');
  if (!arcContainer || !arc) return;

  arcContainer.style.display = 'block';

  const planes = Array.from(arc.querySelectorAll('.plane'));
  if (!planes.length) return;

  const planeWidth = 80; // Ø¹Ø±Ø¶ Ù‡Ø± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§
  let scrollOffset = 0;
  let currentCenterIndex = -1;
  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø·ÙˆÙ„ Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ø¨ÛŒØ¶ÛŒ
  function computeAxes() {
    const a = window.innerWidth * 2;     // Ø·ÙˆÙ„ Ø¨ÛŒØ¶ÛŒ: Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ø¹Ø±Ø¶ ØµÙØ­Ù‡
    const b = window.innerHeight / 4;    // Ø§Ø±ØªÙØ§Ø¹ Ø¨ÛŒØ¶ÛŒ: ÛŒÚ© Ú†Ù‡Ø§Ø±Ù… Ø§Ø±ØªÙØ§Ø¹ ØµÙØ­Ù‡
    return { a, b };
  }

  function updateArc() {
    const { a, b } = computeAxes();
    const rect = arcContainer.getBoundingClientRect();
    const centerX = rect.width / 2;
    const arcTop = 0;        // Ø¨Ø§Ù„Ø§ÛŒ Ú©Ø§Ù†ØªÛŒÙ†Ø±
    const arcBottom = 160; // Ù¾Ø§ÛŒÛŒÙ† Ú©Ø§Ù†ØªÛŒÙ†Ø±

    const totalPlanes = planes.length;
    const angularStep = planeWidth / a * Math.PI; // ÙØ§ØµÙ„Ù‡ ÛŒÚ© Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§

    planes.forEach((el, i) => {
      // Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ†Ù‡Ø§ÛŒØª
      const theta = ((i - scrollOffset + totalPlanes) % totalPlanes) / totalPlanes * Math.PI * 2;
      const angle = theta % Math.PI; // Ø¨ÛŒÙ† 0..PI

      const x = Math.cos(angle) * a / 2;
      const y = Math.sin(angle) * b;

      const midAngle = Math.PI / 2;
      const distToCenter = Math.abs(angle - midAngle);
      const scale = 1 + Math.max(0, (Math.PI / 2 - distToCenter) / (Math.PI / 2)) * 0.5;

      el.style.transform = `translateX(${centerX + x - planeWidth/2}px) translateY(${arcBottom - y - planeWidth}px) scale(${scale})`;
      el.style.zIndex = Math.round(2000 - distToCenter*1000);

      if (distToCenter < angularStep/2) el.classList.add('center');
      else el.classList.remove('center');

      el.style.display = 'block';
    });

       const centerPlane = planes.find(p => p.classList.contains('center'));
    if (centerPlane) {
      const idx = planes.indexOf(centerPlane);

      // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ ÙˆØ³Ø· ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù† â€” ØªØ§ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø±Ø® Ù†Ø¯Ù‡Ø¯
      if (idx !== currentCenterIndex) {
        currentCenterIndex = idx;

        // Ù‡Ù…Ø§Ù† Ú©Ø§Ø±ÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´Ø¯: Ø§Ù†ØªØ®Ø§Ø¨ Ø¸Ø§Ù‡Ø±ÛŒ
        planes.forEach(x => x.classList.remove('selected'));
        centerPlane.classList.add('selected');

        // Ø¨Ù‡ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯)
        selectedPlane = centerPlane.dataset.plane;
        const imgEl = centerPlane.querySelector('img');
        if (typeof selectedPlaneImg !== 'undefined') {
          selectedPlaneImg = imgEl ? (imgEl.src || selectedPlaneImg) : selectedPlaneImg;
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… (Ø§ÛŒÙ…Ù†â€ŒØ³Ø§Ø²ÛŒ: Ø§Ú¯Ø± Ø§Ù„Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª Ø®Ø·Ø§ Ù†Ø¯Ù‡)
        const alt = imgEl?.alt || '';
        const nameEl = document.getElementById('planeName') || document.getElementById('planeSelectTitle');
        if (nameEl) nameEl.innerText = alt;

        // Ù†Ù…Ø§ÛŒØ´ startBtn (Ù‡Ù…Ø§Ù† Ø±ÙØªØ§Ø± Ù‚Ø¨Ù„ÛŒ)
        const sb = document.getElementById('startBtn');
        if (sb) sb.style.display = 'block';
      }
    }

  }

  // Ù„Ù…Ø³ÛŒ / Ù…Ø§ÙˆØ³ Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ù¾ÛŒÚ©Ø³Ù„ Ø¨Ù‡ Ù¾ÛŒÚ©Ø³Ù„
  let startX = null;
  arcContainer.addEventListener('touchstart', e => startX = e.touches[0].clientX, {passive:true});
  arcContainer.addEventListener('touchmove', e => {
    if (startX === null) return;
    const delta =  e.touches[0].clientX - startX;
    scrollOffset -= delta / planeWidth;
    startX = e.touches[0].clientX;
    updateArc();
  }, {passive:true});
  arcContainer.addEventListener('touchend', () => startX = null);

  let mouseDownX = null;
  arcContainer.addEventListener('mousedown', e => mouseDownX = e.clientX);
  window.addEventListener('mousemove', e => {
    if (mouseDownX === null) return;
    const delta =  e.clientX - mouseDownX;
    scrollOffset -= delta / planeWidth;
    mouseDownX = e.clientX;
    updateArc();
  });
  window.addEventListener('mouseup', () => mouseDownX = null);

  // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§
  planes.forEach(p => {
  p.addEventListener('click', () => {
 
  
  const idx = planes.indexOf(p);
  
  // Ø­Ø±Ú©Øª Ù†Ø±Ù… scrollOffset Ø¨Ù‡ idx
  const startOffset = scrollOffset;
  const endOffset = idx;
  const duration = 200; // 0.2 Ø«Ø§Ù†ÛŒÙ‡
  const startTime = performance.now();

  function animate(time) {
    const t = Math.min(1, (time - startTime)/duration);
    //scrollOffset = startOffset + (endOffset - startOffset) * t;
    updateArc();
    if (t < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
});

  });

  window.addEventListener('resize', updateArc);

  updateArc();
})();



const airplaneContainer = document.getElementById("airplaneArcContainer") || document.getElementById("airplaneSelectContainer");
if (airplaneContainer) {
  airplaneContainer.style.display = "block";
} else {
  console.warn("airplane container not found in DOM");
}


    document.getElementById("joystick").style.display = "none";
    document.getElementById("shoot").style.display = "none";
    document.getElementById("missileBtn").style.display = "none";
    loadExplosionSounds();
 
    const planes = document.querySelectorAll(".plane");
    planes.forEach(p => {
        p.addEventListener("click", () => {
        planes.forEach(pl => pl.classList.remove("selected")); // Ø­Ø°Ù Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø¨Ù„ÛŒ
        p.classList.add("selected"); // Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ù„ÛŒ
        selectedPlaneImg = p.querySelector("img").getAttribute("src");
        startBtn.style.display = "block";
        scoreBtn.style.display = "block";
        exitBtn.style.display = "block";
      });
    });

  }, 700);
});

  startBtn.onclick = () => {
  startBtn.style.display = "none";
  startGame();
  
};

 continueBtn.onclick = () => {
    paused = false;
    const now = performance.now();
    lastTime += (now - pauseTime);
    pauseBtn.innerHTML = "â¸"; // Ø¹Ù„Ø§Ù…Øª Pause Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡
    continueBtn.style.display = "none";
    startBtn.style.display = "none";
    exitBtn.style.display = "none";

   cancelAnimationFrame(animationId); // animationId Ø¨Ø§ÛŒØ¯ Ù…ØªØºÛŒØ± Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø§Ø´Ø¯
   animationId = null;
   animationId = requestAnimationFrame(gameLoop);
};

  


  
 exitBtn.onclick = () => {
    stopPlaying();
    stopPresence();
   
    
  
    if (typeof Android !== "undefined" && Android.finish) {
        Android.finish();  // Ø§ÛŒÙ† Ø®Ø· Ø¨Ø§Ø¹Ø« Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø§Ù¾ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    } else {
        alert("Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø´Ù…Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø³Øª Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯.");
    }
};



function drawLives() {
 if (!gameRunning) return;
 const size = 22; // ğŸ”¹ Ú©ÙˆÚ†Ú©ØªØ± Ø§Ø² Ù‚Ø¨Ù„ (35 â†’ 22)
  const padding = 8; // ÙØ§ØµÙ„Ù‡ Ú©Ù…ÛŒ Ú©Ù…ØªØ± Ø¨Ø±Ø§ÛŒ ØªÙ†Ø§Ø³Ø¨ Ø¨Ù‡ØªØ±

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØªÙ† Ø¯Ø± ÙˆØ³Ø· ØµÙØ­Ù‡
  const totalWidth = lives * size + (lives - 1) * padding;
  const startX = (canvas.width - totalWidth) / 2;
  const y = canvas.height - 118; // Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù„Ø¨Ù‡

  for (let i = 0; i < lives; i++) {
    ctx.drawImage(airplaneImg, startX + i * (size + padding), y, size, size);
  }
}



async function showTopPlayerName() {
    try {
        const response = await fetch(SHEET_WEBAPP);
        const data = await response.json();
        data.sort((a, b) => b.score - a.score); // Ø§Ø² Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…ØªØ±ÛŒÙ†
        const topPlayer = data[0]?.name || "---";

        const div = document.getElementById("bestPlayer");
        div.innerHTML = `Best Player : ${topPlayer}`;
        div.style.display = "block";
    } catch (err) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ù†ÙØ± Ø§ÙˆÙ„:", err);
    }
}




// === day/night config (Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‚ÛŒÙ‡Ù” ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ù„ÙˆØ¨Ø§Ù„) ===
const dayNight = {
  halfCycle: 50 * 1000, 
  start: performance.now()
};

// Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø±ÙˆØ²/Ø´Ø¨
const dayColors = { top: '#4da6ff', bottom: '#003366' };
const nightColors = { top: '#000040', bottom: '#000000' };

// Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ (ÛŒÚ©â€ŒØ¨Ø§Ø± Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)
const stars = [];
function createStars(count = 100) {
  if (stars.length) return; // ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¨Ø³Ø§Ø²
  for (let i = 0; i < count; i++) {
    stars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height * 0.65, // Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ù†ÛŒÙ…Ù‡Ù” Ø¨Ø§Ù„Ø§ÛŒÛŒ
      r: Math.random() * 1.4 + 0.4,
      baseAlpha: Math.random() * 0.7 + 0.3,
      twinkleSpeed: Math.random() * 0.02 + 0.005,
      phase: Math.random() * Math.PI * 2
    });
  }
}

// --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø±Ù†Ú¯ Ùˆ lerp ---
function hexToRgb(hex) {
  const h = hex.replace('#','');
  return [parseInt(h.slice(0,2),16), parseInt(h.slice(2,4),16), parseInt(h.slice(4,6),16)];
}
function rgbToCss([r,g,b]) { return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`; }
function lerp(a,b,t){ return a + (b-a) * t; }
function lerpColor(c1, c2, t){
  const a = hexToRgb(c1), b = hexToRgb(c2);
  return rgbToCss([ lerp(a[0],b[0],t), lerp(a[1],b[1],t), lerp(a[2],b[2],t) ]);
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” nightFactor Ø¨ÛŒÙ† 0..1 (0 = Ø±ÙˆØ² Ú©Ø§Ù…Ù„, 1 = Ø´Ø¨ Ú©Ø§Ù…Ù„)
// Ù†ÙˆØ³Ø§Ù† Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø«Ù„Ø«ÛŒ (ping-pong) Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
function getNightFactor() {
  // Ø§Ú¯Ø± Ø¨Ø§Ø²ÛŒ game over Ø§Ø³Øª Ùˆ Ù…ØªØºÛŒØ± gameOverBackground Ù‚Ø¨Ù„Ø§Ù‹ true Ø´Ø¯Ù‡ØŒ
  // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¯Ø± game over Ø­ØªÙ…Ø§Ù‹ Ø´Ø¨ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´Ø¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø´Ø±Ø·ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒ.
  // Ø§Ù…Ø§ Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³Øª ØªÙˆ Ù…Ø§ Ø­Ø§Ù„Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
  const now = performance.now();
  const period = dayNight.halfCycle * 2; // full cycle
  const t = ((now - dayNight.start) % period) / dayNight.halfCycle; // 0..2
  if (t <= 1) return t;         // 0 -> 1 (Ø±ÙˆØ² -> Ø´Ø¨)
  return 2 - t;                 // 1 -> 0 (Ø´Ø¨ -> Ø±ÙˆØ²)
}




function drawBackground() {

  const now = performance.now();
  const last = drawBackground._lastTime || now;
  const dt = Math.min(0.06, (now - last) / 1000); 
  drawBackground._lastTime = now;

  // nightFactor
  const nf = getNightFactor();

  const topColor = lerpColor(dayColors.top, nightColors.top, nf);
  const bottomColor = lerpColor(dayColors.bottom, nightColors.bottom, nf);

  const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  grad.addColorStop(0, topColor);
  grad.addColorStop(1, bottomColor);
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ (ØªØ¯Ø±ÛŒØ¬ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ nf)
  // Ø³ØªØ§Ø±Ù‡â€ŒÙ‡Ø§ (ØªØ¯Ø±ÛŒØ¬ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ nf)
const starAppear = Math.max(0, (nf - 0.15) / (1 - 0.15)); 
if (starAppear > 0.001) {
  createStars(120); // ÛŒÚ©â€ŒØ¨Ø§Ø± ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
  ctx.save();
  for (let s of stars) {
    // Ú†Ø´Ù…Ú© Ø²Ø¯Ù†
    s.phase += (s.twinkleSpeed || 0.01) * (0.6 + 0.4 * nf);
    const tw = 0.6 + 0.4 * Math.sin(s.phase);
    const alpha = (s.baseAlpha || 0.5) * tw * starAppear * (1 + 0.6 * nf);
    if (alpha <= 0.002) continue;
    ctx.globalAlpha = Math.min(1, alpha);
    ctx.fillStyle = `rgba(255,255,230,${alpha})`;

    // Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ù¾Ø§ÛŒÛŒÙ†
    s.y += (s.vy || 10) * dt;  // Ø³Ø±Ø¹Øª Ø³ØªØ§Ø±Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ 5 ØªØ§ 20 ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒ
    if (s.y > canvas.height) s.y = 0; // Ø§Ú¯Ø± Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø®Ø§Ø±Ø¬ Ø´Ø¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ø¨Ø§Ù„Ø§

    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();
  ctx.globalAlpha = 1;
}


  // Ø§Ø¨Ø±Ù‡Ø§: Ø´ÙØ§ÙÛŒØª ÙˆØ§Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø±ÙˆØ²/Ø´Ø¨
  const cloudDayAlpha = 0.85;
  const cloudNightAlpha = 0.65;
  const cloudAlpha = lerp(cloudDayAlpha, cloudNightAlpha, nf);
  ctx.save();
  ctx.globalAlpha = cloudAlpha;

  if (!clouds || !clouds.length) {
    if (typeof initClouds === 'function') initClouds(8);
  }

  for (let c of (clouds || [])) {
 
    const vy = (typeof c.vy === 'number') ? c.vy : (typeof c.vy === 'number' ? c.vy : 30);
    const vx = (typeof c.vx === 'number') ? c.vx : 0;

    c.y += vy * dt;   // Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ù¾Ø§ÛŒÛŒÙ†
  //  c.x += vx * dt;

    // Ø§Ú¯Ø± Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ø®Ø§Ø±Ø¬ Ø´Ø¯ -> Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø§Ø² Ø¨Ø§Ù„Ø§ Ø¨Ø§ Ù…Ø´Ø®ØµØ§Øª Ø±Ù†Ø¯ÙˆÙ…
    if (c.y > canvas.height + 200) {
      c.y = - (50 + Math.random() * 200);
      c.x = Math.random() * canvas.width;
      c.size = 60 + Math.random() * 160;
      c.vy = 20 + Math.random() * 120;
      c.vx = (Math.random() - 0.5) * 30;
      c.img = cloudImages && cloudImages.length ? cloudImages[Math.floor(Math.random() * cloudImages.length)] : c.img;
    }

    // Ø±Ø³Ù… Ø§Ø¨Ø±
    if (c.img && c.img.complete) {
      ctx.drawImage(c.img, c.x, c.y, c.size, c.size * 0.6);
    } else {
      ctx.beginPath();
      ctx.ellipse(c.x + (c.size||80)*0.4, c.y + (c.size||80)*0.25, (c.size||80)*0.6, (c.size||80)*0.3, 0, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fill();
    }
  }

  ctx.restore();
}



document.addEventListener("keydown", (e) => {
  if (!gameRunning) return;
  switch (e.code) {
    case "ArrowLeft": keys.left = true; break;
    case "ArrowRight": keys.right = true; break;
    case "ArrowUp": keys.up = true; break;
    case "ArrowDown": keys.down = true; break;
    case "Space": keys.space = true; break;
  }
});

document.addEventListener("keyup", (e) => {
  switch (e.code) {
    case "ArrowLeft": keys.left = false; break;
    case "ArrowRight": keys.right = false; break;
    case "ArrowUp": keys.up = false; break;
    case "ArrowDown": keys.down = false; break;
    case "Space": keys.space = false; break;
  }
});




async function sendScore() {
  try {

console.log('sendScore called', {
  alreadySentScore: window.alreadySentScore,
  windowPlayerId: window.playerId,
  localPlayerId: localStorage.getItem('bermooda_playerId'),
  windowPlayerName: window.playerName,
  localPlayerName: localStorage.getItem('bermooda_playerName'),
  windowScore: window.score,
  scoreValueEl: document.getElementById('scoreValue')?.innerText
});


    if (window.alreadySentScore) return;

    const finalScore = Number(window.score || document.getElementById('scoreValue').innerText) || 0;
    if (finalScore <= 0) return;

    const id = window.playerId || getOrCreatePlayerId();
    const name = window.playerName || (localStorage.getItem('bermooda_playerName') || 'Ù†Ø§Ø´Ù†Ø§Ø³');

    const body = new URLSearchParams();
    body.append('action', 'upsert');
    body.append('playerId', id);
    body.append('name', name);
    body.append('score', String(finalScore));
    body.append('device', getDeviceInfo());

    const res = await fetch(SHEET_WEBAPP, { method: 'POST', body });
    const json = await res.json().catch(()=>null);

    window.alreadySentScore = true;

    const scoreDiv = document.getElementById('finalScore');
    if (scoreDiv) {
    
    }


  } catch(err) {
    console.error("sendScore error:", err);
  }
}

function getDeviceInfo() {
  const ua = navigator.userAgent;

  let brand = "Unknown";
  let model = "Unknown";
  let os = "Unknown";
  let browser = "Unknown";

  // --- iPhone ---
  // Example: iPhone; CPU iPhone OS 18_6 like Mac OS X
  if (/iPhone/i.test(ua)) {
    brand = "Apple";
    os = ua.match(/iPhone OS ([\d_]+)/i)?.[1].replace(/_/g, ".") || "iOS";
    model = "iPhone"; // Ø¯Ø± iOS Ù…Ø¯Ù„ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± User-Agent ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯! (Ø§Ø² 2021 Ø­Ø°Ù Ø´Ø¯Ù‡)
    browser = /Version\/([\d\.]+)/i.test(ua) ? "Safari" : "Safari (Unknown)";
  }

  // --- Android ---
  if (/Android/i.test(ua)) {
    os = ua.match(/Android\s([\d\.]+)/i)?.[1] || "Android";

    // Samsung Detection
    if (/Samsung|SM-|SAMSUNG/i.test(ua)) {
      brand = "Samsung";
      model =
        ua.match(/SM-[A-Z0-9]+/i)?.[0] ||    // Ù…Ø«Ù„ SM-A515F â†’ A51
        ua.match(/Samsung ([A-Za-z0-9\-]+)/i)?.[1] ||
        "Samsung";
      
      // Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ù„ Samsung
      if (model.startsWith("SM-")) {
        const c = model.split("-")[1]; // Ù…Ø«Ù„Ø§ A515F
        if (/^[A-Z][0-9]+/i.test(c)) {
          const prefix = c.match(/^[A-Z]/i)[0];
          const num = c.match(/[0-9]+/)[0].substring(0, 2);
          model = prefix + num; // A51
        }
      }
    } 
    
    // Xiaomi
    else if (/Mi\s?|Redmi|M2010|M210/i.test(ua)) {
      brand = "Xiaomi";
      model =
        ua.match(/Mi\s?[A-Za-z0-9]+/i)?.[0] ||
        ua.match(/Redmi\s?[A-Za-z0-9]+/i)?.[0] ||
        "Xiaomi";
    }

    // Huawei
    else if (/Huawei|HUAWEI/i.test(ua)) {
      brand = "Huawei";
      model =
        ua.match(/HUAWEI\s?[A-Za-z0-9\-]+/i)?.[0] ||
        "Huawei";
    }

    // Samsung Browser
    if (/SamsungBrowser/i.test(ua)) browser = "Samsung Browser";
    else if (/Chrome/i.test(ua)) browser = "Chrome";
  }

  return `${brand} ${model} / ${os} / ${browser}`;
}



function drawFuelGaugeAnimated() {
  if (!gameRunning) return;

  const centerX = canvas.width / 2;
  const centerY = canvas.height - 20;
  const radius = 60;

  // ğŸ§ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙˆØ®Øª Ùˆ Ù¾Ø®Ø´ Ø¢Ù„Ø§Ø±Ù…
  try {
    if (fuel <= 20 && !fuelAlarmActive) {
      fuelAlarm.currentTime = 0;
      fuelAlarm.play().catch(() => {});
      fuelAlarmActive = true;
    } 
    else if (fuel > 20 && fuelAlarmActive) {
      fuelAlarm.pause();
      fuelAlarm.currentTime = 0;
      fuelAlarmActive = false;
    }
  } catch (e) {
    console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ Ø¢Ù„Ø§Ø±Ù… Ø³ÙˆØ®Øª:", e);
  }

  // ğŸ”¹ Ø±Ø³Ù… Ù†ÛŒÙ…â€ŒØ¯Ø§ÛŒØ±Ù‡ Ù¾Ø§ÛŒÙ‡
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
  ctx.lineWidth = 20;
  ctx.strokeStyle = "#333";
  ctx.stroke();

// ğŸ”¹ Ø§ÙÚ©Øª Ú†Ø´Ù…Ú©â€ŒØ²Ù† Ù‚Ø±Ù…Ø² ÙˆÙ‚ØªÛŒ Ø³ÙˆØ®Øª â‰¤ 20Ùª
if (fuel <= 20) {
  const fade = 0.3 + 0.7 * Math.abs(Math.sin(performance.now() / 300)); // 0.3 ØªØ§ 1
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius - 10, Math.PI, 2 * Math.PI);
  ctx.lineWidth = 16;
  ctx.strokeStyle = `rgba(255,0,0,${fade})`;
  ctx.stroke();

  // Ù„Ø±Ø²Ø´ ØµÙØ­Ù‡ ÙˆÙ‚ØªÛŒ Ø³ÙˆØ®Øª â‰¤ 20Ùª
  startScreenShake(5, 30000); // Ù„Ø±Ø²Ø´ ØªØ§ ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ø¨Ù†Ø²ÛŒÙ† Ø²ÛŒØ± 20Ùª Ø§Ø³Øª
} else {
  // ÙˆÙ‚ØªÛŒ Ø³ÙˆØ®Øª > 20Ùª Ù„Ø±Ø²Ø´ Ù…ØªÙˆÙ‚Ù Ø´ÙˆØ¯
  screenShake.strength = 0;
  screenShake.duration = 0;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
}

  // ğŸ”¹ Ø®Ø·ÙˆØ· Ø¯Ø±Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
  const totalTicks = 100;
  for (let i = 0; i <= totalTicks; i++) {
    const angle = Math.PI + (i / totalTicks) * Math.PI;
    const outerRadius = radius - 2;
    const innerRadius = (i % 10 === 0) ? outerRadius - 10 : outerRadius - 5;
    const x1 = centerX + innerRadius * Math.cos(angle);
    const y1 = centerY + innerRadius * Math.sin(angle);
    const x2 = centerX + outerRadius * Math.cos(angle);
    const y2 = centerY + outerRadius * Math.sin(angle);

    ctx.strokeStyle = (i % 10 === 0) ? "#00ffff" : "rgba(0,255,255,0.3)";
    ctx.lineWidth = (i % 10 === 0) ? 2 : 1;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  // ğŸ”¹ Ù…ØªÙ† E Ùˆ F
  ctx.font = "18px Arial Black";
  ctx.fillStyle = "#00ffff";
  ctx.textAlign = "center";
  ctx.fillText("E", centerX - radius - 7, centerY + 10);
  ctx.fillText("F", centerX + radius + 7, centerY + 10);

  // ğŸ”¹ Ø¯Ø±ØµØ¯ Ø³ÙˆØ®Øª
  ctx.font = "12px Arial";
  ctx.fillStyle = (fuel <= 20) ? "red" : "#00ffff";
  ctx.fillText(Math.round(fuel) + "%", centerX, centerY - 10);

  // ğŸ”¹ Smooth animation Ø¹Ù‚Ø±Ø¨Ù‡
  const speed = 0.025;
  displayedFuel += (fuel - displayedFuel) * speed;
  const needleAngle = Math.PI + (displayedFuel / 100) * Math.PI;
  const needleLength = radius - 10;
  const needleX = centerX + needleLength * Math.cos(needleAngle);
  const needleY = centerY + needleLength * Math.sin(needleAngle);

  // ğŸ”¹ Ø¹Ù‚Ø±Ø¨Ù‡
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.lineTo(needleX, needleY);
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#ff0000";
  ctx.stroke();

  // ğŸ”¹ Ø¯Ø§ÛŒØ±Ù‡ Ù…Ø±Ú©Ø² Ø¹Ù‚Ø±Ø¨Ù‡
  ctx.beginPath();
  ctx.arc(centerX, centerY, 6, 0, 2 * Math.PI);
  ctx.fillStyle = "#ff0000";
  ctx.fill();
}













/* ===========================================================
   Ø³ÛŒØ³ØªÙ… Ù…Ø³ØªÙ‚Ù„ Ø¯Ø´Ù…Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ú©Ø¯ Ø§ØµÙ„ÛŒ)
   ØªÙ…Ø§Ù… Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø´Ø§Ù…Ù„ hoosh Ù‡Ø³ØªÙ†Ø¯
   =========================================================== */

/* ------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ ------- */
const hooshSettings = {
    spawnInterval: 30000,   // Ù‡Ø± 80 Ø«Ø§Ù†ÛŒÙ‡
    lifeTime: 10000,        // Ø¹Ù…Ø± Ù‡Ø± Ø¯Ø´Ù…Ù†
    shotRate: 1,            // ÛŒÚ© ØªÛŒØ± Ø¯Ø± Ø«Ø§Ù†ÛŒÙ‡
    evadeLookAhead: 1000,    // Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ 1000Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡â€ŒØ§ÛŒ
    evadeRadius: 100,       // Ø´Ø¹Ø§Ø¹ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ØªÛŒØ±
    maxSpeedX: 1,
    evadeForce: 0.10,
    imgList: [ "hooshmandP.png", "hooshmandP2.png" ],
    scoreOnKill: 500
};

/* ------- Ø³Ø§Ø®Øª Ú©Ø§Ù†ØªÛŒÙ†Ø± Ù…Ø³ØªÙ‚Ù„ ------- */
const hooshEnemies = [];
const hooshBullets = [];

/* ------- Ú©Ø´ÛŒØ¯Ù† ØªØµÙˆÛŒØ± ------- */
function hooshCreateImg(src){
    let im = new Image();
    im.src = src;
    return im;
}

/* ------- Ø§Ø¨Ø²Ø§Ø± ÙØ§ØµÙ„Ù‡ ------- */
function hooshDist(a,b){
    let dx = a.x - b.x;
    let dy = a.y - b.y;
    return Math.sqrt(dx*dx + dy*dy);
}

/* ===========================================================
   1) Ø³Ø§Ø®Øª Ø¯Ø´Ù…Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯
   =========================================================== */
// helper: Ú†Ø±Ø®Ø§Ù†Ø¯Ù† Ù†Ù‚Ø·Ù‡ (px,py) Ø­ÙˆÙ„ Ù…Ø¨Ø¯Ø§ Ø¨Ø§ Ø²Ø§ÙˆÛŒÙ‡ angle
function hooshRotatePoint(px, py, angle){
    const c = Math.cos(angle);
    const s = Math.sin(angle);
    return {
        x: px * c - py * s,
        y: px * s + py * c
    };
}

/* ---- Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø§Ø³Ù¾Ø§ÙˆÙ†: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† gunOffsets Ùˆ gunIndex Ùˆ gunRotationOffset ---- */
function hooshSpawnEnemy(canvas){
    let imgSrc = hooshSettings.imgList[
        Math.floor(Math.random()*hooshSettings.imgList.length)
    ];
    let im = hooshCreateImg(imgSrc);

    let now = performance.now();
    let w = 55, h = 41;

    let e = {
        x: Math.random()*(canvas.width - w) + w/2,
        y: -h - 20,
        w, h,
        img: im,
        vx: 0,
        vy: 1 + Math.random()*0.6,
        spawnTime: now,
        state: "active",
        lastShot: now,
        shotDelay: 1000/hooshSettings.shotRate,
        evadeBias: (Math.random() - 0.5)*0.2,
        angle: 0,
        targetAngle: 0,
        // Ù†Ù‚Ø§Ø· Ø®Ø±ÙˆØ¬ Ú¯Ù„ÙˆÙ„Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø®ØªØµØ§Øª Ù…Ø­Ù„ÛŒ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù…Ø±Ú©Ø² Ø§Ø³Ù¾Ø±ÛŒØª
       
       gunOffsets: [{x: w/2, y: 0}],             
        // {x: w*0.25, y: -h*0.3}, {x: w*0.25, y: h*0.3}
        gunIndex: 0,
        gunRotationOffset: 0
    };

    hooshEnemies.push(e);
}

/* ---- Ø´Ù„ÛŒÚ©: ØªÙˆÙ„ÛŒØ¯ Ú¯Ù„ÙˆÙ„Ù‡ Ø§Ø² Ù†Ù‚Ø·Ù‡Ù” Ú†Ø±Ø®ÛŒØ¯Ù‡ Ø´Ø¯Ù‡ Ø±ÙˆÛŒ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ ---- */
function hooshEnemyShoot(e, player){
    let now = performance.now();
    if(now - e.lastShot < e.shotDelay) return;
    e.lastShot = now;

    // Ø§Ù†ØªØ®Ø§Ø¨ gun offset (Ù…Ø«Ø§Ù„: Ú¯Ø±Ø¯Ø´ÛŒ)
    const g = e.gunOffsets[e.gunIndex % e.gunOffsets.length];
    e.gunIndex++;

    // Ø²Ø§ÙˆÛŒÙ‡â€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú†Ø±Ø®Ø´Ù Ù†Ù‚Ø·Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
    const totalAngle = (e.angle || 0) + (e.gunRotationOffset || 0);

    // Ù…Ø®ØªØµØ§Øª Ù…Ø­Ù„ÛŒÙ Ù†Ù‚Ø·Ù‡ Ø±Ø§ Ø¨Ú†Ø±Ø®Ø§Ù† Ùˆ Ø¨Ù‡ Ù…Ø®ØªØµØ§Øª Ø¬Ù‡Ø§Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    const rp = hooshRotatePoint(g.x, g.y, totalAngle);
    const spawnX = e.x + rp.x;
    const spawnY = e.y + rp.y;

    // Ù‡Ø¯Ù: Ù…Ø±Ú©Ø² Ø¨Ø§Ø²ÛŒÚ©Ù† (Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„)
    let tx = player.x + player.w/2;
    let ty = player.y + player.h/2;

    let dx = tx - spawnX;
    let dy = ty - spawnY;
    let len = Math.sqrt(dx*dx + dy*dy) || 1;

    const speed = 2; // ÛŒØ§ hooshSettings.bulletSpeed Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ
    hooshBullets.push({
        x: spawnX,
        y: spawnY,
        vx: (dx/len)*speed,
        vy: (dy/len)*speed,
        angle: Math.atan2(dy, dx) // Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù…Ù Ú¯Ù„ÙˆÙ„Ù‡ Ø¬Ù‡Øªâ€ŒØ¯Ø§Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    });

    // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø²Ø§ÙˆÛŒÙ‡Ù” Ù‡Ø¯Ù Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ù†ÛŒØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ† Ø´Ù„ÛŒÚ© ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯:
    e.targetAngle = Math.atan2(dy, dx) + (e.gunRotationOffset || 0);
}



/* ===========================================================
   3) Ø³ÛŒØ³ØªÙ… ÙØ±Ø§Ø± Ø¯Ø´Ù…Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯
   =========================================================== */
function hooshEvade(e, playerBullets, delta){
    let threat = null;
    let bestScore = -99999;

    for(let b of playerBullets){
        let predX = b.x + (b.vx||0)*(hooshSettings.evadeLookAhead/16);
        let predY = b.y + (b.vy||-6)*(hooshSettings.evadeLookAhead/16);

        let d = hooshDist({x:predX, y:predY}, e);
        if(d < hooshSettings.evadeRadius){
            let score = (1000/(1+d))*(Math.abs(b.x - e.x) < 40 ? 1.5 : 1);
            if(score > bestScore){
                bestScore = score;
                threat = {predX, predY};
            }
        }
    }

    if(threat){
        let dir = threat.predX >= e.x ? -1 : 1;
        e.vx += dir * hooshSettings.evadeForce * delta + e.evadeBias*0.04;
        if(e.vx > hooshSettings.maxSpeedX) e.vx = hooshSettings.maxSpeedX;
        if(e.vx < -hooshSettings.maxSpeedX) e.vx = -hooshSettings.maxSpeedX;
    } else {
        e.vx *= 0.98;
    }
}

/* ===========================================================
   4) Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø´Ù…Ù†â€ŒÙ‡Ø§
   =========================================================== */
/* ---- Ø¯Ø± Ø¢Ù¾Ø¯ÛŒØªØŒ Ø²Ø§ÙˆÛŒÙ‡ Ø±Ø§ Ø¨Ù‡ Ø³Ù…Øª targetAngle Ù†Ø±Ù… Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡ ---- */
function hooshUpdateEnemies(delta, canvas, player, playerBullets, onKill){
    let now = performance.now();

    for(let i = hooshEnemies.length - 1; i >= 0; i--){
        let e = hooshEnemies[i];

        // Ø¹Ù…Ø± ØªÙ…Ø§Ù… Ø´Ø¯ â†’ Ø®Ø±ÙˆØ¬
        if(now - e.spawnTime > hooshSettings.lifeTime){
            e.state = "exiting";
        }

        // Ø®Ø±ÙˆØ¬ Ø§Ø² ØµØ­Ù†Ù‡
        if(e.state === "exiting"){
            e.y -= 3*delta;
            if(e.y < -100){ hooshEnemies.splice(i,1); }
            continue;
        }

        // Ù‡ÙˆØ´ ÙØ±Ø§Ø±
        hooshEvade(e, playerBullets, delta);

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­Ø±Ú©Øª Ù¾Ø§ÛŒÙ‡
        e.x += e.vx*delta*2;
        e.y += e.vy*delta*2;

        // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ù‡Ù…ÙˆØ§Ø±Ø³Ø§Ø²ÛŒ Ø²Ø§ÙˆÛŒÙ‡ (lerp Ø³Ø§Ø¯Ù‡)
        // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒØŒ Ø§Ø®ØªÙ„Ø§Ù Ø²Ø§ÙˆÛŒÙ‡ Ø±Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÛŒ -PI..PI Ù†Ø±Ù…Ø§Ù„ Ú©Ù†
        let a = e.angle;
        let ta = e.targetAngle || a;
        // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø®ØªÙ„Ø§Ù
        let diff = ta - a;
        while(diff > Math.PI) diff -= 2*Math.PI;
        while(diff < -Math.PI) diff += 2*Math.PI;
        // Ù‡Ù…ÙˆØ§Ø±Ø³Ø§Ø²ÛŒ: Ø¶Ø±ÛŒØ¨ 0.12 Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ø§Ø³Øª (Ø¨Ø²Ø±Ú¯â€ŒØªØ± -> Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…ÛŒâ€ŒÚ†Ø±Ø®Ø¯)
        e.angle = a + diff * 0.10;

        // ØªÛŒØ±Ø§Ù†Ø¯Ø§Ø²ÛŒ
        hooshEnemyShoot(e, player);

        // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ ØªÛŒØ±Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†
        for(let j = playerBullets.length - 1; j >= 0; j--){
            let b = playerBullets[j];
            if(
                b.x > e.x - e.w/2 &&
                b.x < e.x + e.w/2 &&
                b.y > e.y - e.h/2 &&
                b.y < e.y + e.h/2
            ){
                playerBullets.splice(j,1);
                hooshEnemies.splice(i,1);


            if (typeof createExplosion === "function") {
              createExplosion(e.x, e.y); 
             }

                if(onKill) onKill(hooshSettings.scoreOnKill);
                break;
            }
        }
    }
}

/* ===========================================================
   5) Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø´Ù…Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯
   =========================================================== */
function hooshUpdateBullets(delta, canvas, player, onHit){
    for(let i = hooshBullets.length - 1; i >= 0; i--){
        let b = hooshBullets[i];

        b.x += b.vx*delta*3;
        b.y += b.vy*delta*3;

        // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø¨Ø§Ø²ÛŒâ€ŒÚ©Ù†
        if(
            player.x < b.x &&
            player.x + player.w > b.x &&
            player.y < b.y &&
            player.y + player.h > b.y
        ){
            hooshBullets.splice(i,1);
            if(onHit) onHit();
            continue;
        }

        // Ø®Ø±ÙˆØ¬ Ø§Ø² ØµØ­Ù†Ù‡
        if(
            b.x < -50 || b.x > canvas.width+50 ||
            b.y < -50 || b.y > canvas.height+50
        ){
            hooshBullets.splice(i,1);
        }
    }
}

/* ===========================================================
   6) Ø§Ø³Ù¾Ø§ÙˆÙ† Ø®ÙˆØ¯Ú©Ø§Ø±
   =========================================================== */
let hooshLastSpawn = performance.now() - hooshSettings.spawnInterval;

function hooshTickSpawner(canvas){
    let now = performance.now();
    if(now - hooshLastSpawn >= hooshSettings.spawnInterval){
        hooshLastSpawn = now;
        hooshSpawnEnemy(canvas);
    }
}

/* ===========================================================
   7) Ø±Ø³Ù… Ø¯Ø´Ù…Ù†â€ŒÙ‡Ø§ Ùˆ Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
   =========================================================== */
/* ---- Ø±Ø³Ù… Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø²Ø§ÙˆÛŒÙ‡ (Ø¯ÙˆØ± Ù…Ø±Ú©Ø² Ù…ÛŒâ€ŒÚ†Ø±Ø®Ø¯) ---- */
function hooshRender(ctx){
    hooshEnemies.forEach(e=>{
        ctx.save();
        // translate Ø¨Ù‡ Ù…Ø±Ú©Ø² ØªØµÙˆÛŒØ±
        ctx.translate(e.x, e.y);
        // rotate ØªÙˆØ³Ø· e.angle
        ctx.rotate(e.angle);
        // ØªØµÙˆÛŒØ± Ø±Ø§ Ø·ÙˆØ±ÛŒ Ø¨Ú©Ø´ Ú©Ù‡ Ù…Ø±Ú©Ø² ØªØµÙˆÛŒØ± Ø¯Ø± Ù…Ø¨Ø¯Ø£ Ù‚Ø±Ø§Ø± Ú¯ÛŒØ±Ø¯
        ctx.drawImage(e.img, -e.w/2, -e.h/2, e.w, e.h);
        ctx.restore();
    });

  hooshBullets.forEach(b => {
    ctx.save();
    ctx.translate(b.x, b.y);
    ctx.rotate(b.angle);
    ctx.fillStyle = "orange";
    ctx.fillRect(-2, -4, 7, 3); // Ø·ÙˆÙ„ 8ØŒ Ø¹Ø±Ø¶ 4ØŒ Ø­ÙˆÙ„ Ù…Ø±Ú©Ø²
    ctx.restore();
});
}







  
// === Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ ===
function gameLoop() {
  if (!gameRunning || paused) return;

  const now = performance.now();
  const delta = (now - lastTime) / 16.67; 
  lastTime = now;
 ctx.clearRect(0, 0, canvas.width, canvas.height);
applyScreenShake();      // Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± Ø±Ø³Ù…
drawBackground();
updateExplosionFlashes(); // Ù†ÙˆØ± Ø§Ù†ÙØ¬Ø§Ø±





hooshTickSpawner(canvas);
hooshUpdateEnemies(delta, canvas, airplane, bullets, (score)=>addScore(score));
hooshUpdateBullets(delta, canvas, airplane, ()=>explodeAirplane());
hooshRender(ctx);


updateHeartDrops();
drawHeartDrops(ctx);











fuels.forEach((f, i) => {
  // Ø­Ø±Ú©Øª Ù¾Ù…Ù¾ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
  f.y += 0.45;

  // Ø±Ø³Ù… Ù¾Ù…Ù¾
  ctx.drawImage(fuelImg, f.x, f.y, f.w, f.h);

  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ø¨Ø§ Ù¾Ù…Ù¾ (x Ùˆ y)
  const inContact =
    airplane.x < f.x + f.w &&
    airplane.x + airplane.w > f.x &&
    airplane.y < f.y + f.h &&
    airplane.y + airplane.h > f.y;

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÛŒØ§ Ø³Ø§Ø®Øª Ù„ÛŒØ¨Ù„ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ù¾Ù…Ù¾
  let lbl = fuelLabels.find(l => l.pump === f);
if (inContact) {
  if (!lbl) {
    lbl = {
      pump: f,
      value: 0,
      text: "+0%",
      alpha: 1,
      lastUpdate: performance.now(),
      lastContact: performance.now()
    };
    fuelLabels.push(lbl);
  } else {
    lbl.lastContact = performance.now();
  }

  const now = performance.now();
  if (now - lbl.lastUpdate >= 20) {
    if (fuel < 100) {
      // Ø­Ø¯Ø§Ú©Ø«Ø± Ø§ÙØ²Ø§ÛŒØ´ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯
      const increment = Math.min(0.4, 100 - fuel);
      fuel += increment;
      lbl.value += increment;
      lbl.text = `+${Math.floor(lbl.value)}%`;
    }
    lbl.lastUpdate = now;
  }

  // Ù„ÛŒØ¨Ù„ Ù‡Ù…ÛŒØ´Ù‡ Ø±ÙˆÛŒ Ù„Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒÛŒ Ù¾Ù…Ù¾ Ø¨Ø§Ø´Ø¯
  lbl.y = f.y - 10;
}


  // Ø±Ø³Ù… Ùˆ fade out Ù„ÛŒØ¨Ù„
  if (lbl) {
    ctx.globalAlpha = lbl.alpha;
    ctx.fillStyle = "lime";
    ctx.font = "14px Arial";
    ctx.textAlign = "center";
    
    // Ù…ÙˆÙ‚Ø¹ÛŒØª y Ù„ÛŒØ¨Ù„ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ø§Ù„Ø§ÛŒ Ù¾Ù…Ù¾
    const labelY = f.y - 5; // 5 Ù¾ÛŒÚ©Ø³Ù„ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø¨Ø§Ù„Ø§ÛŒ Ù¾Ù…Ù¾
    ctx.fillText(lbl.text, f.x + f.w/2, labelY);

    // Ø­Ø±Ú©Øª Ù„ÛŒØ¨Ù„ Ø¨Ù‡ Ø¢Ø±Ø§Ù…ÛŒ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙÚ©Øª
    lbl.alpha -= (performance.now() - lbl.lastContact > 2000) ? 0.02 : 0;
    
    if (lbl.alpha <= 0) {
      fuelLabels = fuelLabels.filter(l => l !== lbl);
    }
  }
});

ctx.globalAlpha = 1; // Ø±ÛŒØ³Øª alpha


// Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù¾Ù…Ù¾â€ŒÙ‡Ø§
fuels.forEach((f, i) => {
  bullets.forEach((b, j) => {
    if (b.x > f.x && b.x < f.x + f.w &&
      b.y > f.y && b.y < f.y + f.h) {
      createExplosion(b.x, b.y, (f.w*2.5)/1.5, (f.h/1.5), 1); // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙØ¬Ø§Ø± Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡
      fuels.splice(i, 1);
      bullets.splice(j, 1);
      addScore(20);
    }
  });
});

// 4ï¸âƒ£ Ø­Ø°Ù Ù¾Ù…Ù¾â€ŒÙ‡Ø§ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡
fuels.forEach((f, i) => {
  if (f.y > canvas.height) fuels.splice(i, 1);
});



fuel -= 0.02; // Ú©Ø§Ù‡Ø´ ØªØ¯Ø±ÛŒØ¬ÛŒ Ø³ÙˆØ®Øª
if (!paused) {
  if (fuel < 0) {
    fuel = 0;
    explodeAirplane();
  }
}



  airplane.x += dx * 4;
  airplane.y += dy * 4;
// ØªØ¹ÛŒÛŒÙ† Ø¬Ù‡Øª Ù…Ø§ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ø§ Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ©
if (dx < -0.2) {
  airplane.direction = -1; // Ú†Ù¾
} else if (dx > 0.2) {
  airplane.direction = -1; // Ø±Ø§Ø³Øª
} else {
  airplane.direction = 0; // ØµØ§Ù
}

  airplane.x = Math.max(0, Math.min(canvas.width - airplane.w, airplane.x));
  airplane.y = Math.max(0, Math.min(canvas.height - airplane.h, airplane.y));

// ğŸŒŸ Ø­Ø§Ù„Øª Ù…ØªÙ…Ø§ÛŒÙ„ Ø´Ø¯Ù†: -1: Ú†Ù¾ØŒ 0: ØµØ§ÙØŒ 1: Ø±Ø§Ø³Øª
if (!airplane.direction) airplane.direction = 0;
if (!airplane.tiltProgress) airplane.tiltProgress = 0;

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ tiltProgress Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ù†Ø±Ù…
airplane.tiltProgress += (airplane.direction - airplane.tiltProgress) * 0.3; // 0.3 Ø³Ø±Ø¹Øª Ù…ØªÙ…Ø§ÛŒÙ„ Ø´Ø¯Ù†

if (!airplane.hidden) {
  ctx.save();

//  Ø­Ø§Ù„Øª Ú†Ø´Ù…Ú©â€ŒØ²Ù† Ø¯Ø± Ø²Ù…Ø§Ù† Ù…ØµÙˆÙ†ÛŒØª
  if (invincible) {
    const elapsed = performance.now() - respawnTime;
    const blink = Math.floor(elapsed / 40) % 2; // Ù‡Ø± 150ms ÛŒÚ© Ø¨Ø§Ø± Ú†Ø´Ù…Ú©
    ctx.globalAlpha = blink === 0 ? 0.3 : 1;
  } else {
    ctx.globalAlpha = 1;
  }


  const tiltFactor = 1 + 0.3 * airplane.tiltProgress; // 0.3 Ù…Ù‚Ø¯Ø§Ø± Ú©Ø´Ø´ Ø§ÙÙ‚ÛŒ
  const w = airplane.w * tiltFactor;
  const h = airplane.h;
  const x = airplane.x - (w - airplane.w)/2; // Ù…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† ØªØµÙˆÛŒØ±
  ctx.drawImage(airplaneImg, x, airplane.y, w, h);
  ctx.restore();
}

// ğŸ”« Ø±Ø³Ù… Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ú¯Ø±ÛŒØ¯
bullets.forEach((b,i) => {
  b.y += b.vy;
  b.x += b.vx;
  ctx.fillStyle = b.color;
  ctx.fillRect(b.x - b.w/2, b.y, b.w, b.h);
  if (b.y < 0) bullets.splice(i,1);
});


if (heat >= 80 || overheated) {
  document.getElementById("heatBarContainer").classList.add("heatShake");
} else {
  document.getElementById("heatBarContainer").classList.remove("heatShake");
}



for (let i = activeMissiles.length - 1; i >= 0; i--) {
  let m = activeMissiles[i];

  // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ø§ÙˆÛŒÙ‡
  m.prevX = m.x;
  m.prevY = m.y;

  // Ø­Ø±Ú©Øª Ø¹Ù…ÙˆØ¯ÛŒ Ùˆ Ø³ÛŒÙ†ÙˆØ³ÛŒ
  m.y -= m.speed;
  m.angle += 0.05;
  m.x = m.baseX + Math.sin(m.angle) * m.amplitude; 

  // Ø²Ø§ÙˆÛŒÙ‡ Ù…ÙˆØ´Ú© Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø­Ø±Ú©Øª
  let dx = m.x - m.prevX;
  let dy = m.y - m.prevY;
  let rotation = Math.atan2(dy, dx) - Math.PI/2;

  // Ø±Ø³Ù… Ù…ÙˆØ´Ú© Ø¨Ø§ Ú†Ø±Ø®Ø´
  ctx.save();
  ctx.translate(m.x + m.w/2, m.y + m.h/2);
  ctx.rotate(rotation);
  ctx.drawImage(m.img, -m.w/2, -m.h/2, m.w, m.h);
  ctx.restore();

  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ù…ÙˆØ´Ú© Ø¨Ø§ ØªÙ…Ø§Ù… Ø¯Ø´Ù…Ù†Ø§Ù†
  for (let j = enemies.length - 1; j >= 0; j--) {
    let e = enemies[j];
    if (
      m.x + m.w/2 > e.x - e.w/2 &&
      m.x - m.w/2 < e.x + e.w/2 &&
      m.y + m.h/2 > e.y - e.h/2 &&
      m.y - m.h/2 < e.y + e.h/2
    ) {
      createExplosion(m.x + m.w/2, m.y + m.h/2, m.w, m.h);
      createExplosion(e.x, e.y, e.w, e.h);

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø´Ù…Ù†
      addScore(10);

      // Ø­Ø°Ù Ø¯Ø´Ù…Ù† Ùˆ Ù…ÙˆØ´Ú©
      enemies.splice(j, 1);
      activeMissiles.splice(i, 1);

      //enemyBullets = [];
      break; // Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø¯Ø´Ù…Ù†Ø§Ù†
    }
  }

  // Ø§Ú¯Ø± Ù…ÙˆØ´Ú© Ù†Ø²Ø¯ÛŒÚ© Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø´Ø¯
  if (m.y + m.h < 200) {
    createExplosion(m.x + m.w/2, m.y + m.h/2, 200, 200);

    enemies.forEach(e => createExplosion(e.x, e.y, e.w, e.h));

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¯Ø´Ù…Ù†Ø§Ù† Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡
   addScore(10, enemies.length);

    enemies = [];
    //enemyBullets = [];
    activeMissiles.splice(i, 1);
  }
}




if (keys.left) {
  airplane.x -= 5;
  airplane.direction = -1; // Ù…ØªÙ…Ø§ÛŒÙ„ Ø¨Ù‡ Ú†Ù¾
} else if (keys.right) {
  airplane.x += 5;
  airplane.direction = -1; // Ù…ØªÙ…Ø§ÛŒÙ„ Ø¨Ù‡ Ø±Ø§Ø³Øª
} else {
  airplane.direction = 0; // ØµØ§Ù
}
if (keys.up) airplane.y -= 5;
if (keys.down) airplane.y += 5;

// Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø­Ø±Ú©Øª
if (airplane.x < 0) airplane.x = 0;
if (airplane.x + airplane.w > canvas.width)
  airplane.x = canvas.width - airplane.w;
if (airplane.y < 0) airplane.y = 0;
if (airplane.y + airplane.h > canvas.height-noFlyZoneHeight)
  airplane.y = canvas.height - airplane.h-noFlyZoneHeight;




// Ø¨Ø®Ø´ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø´Ù…Ù† Ø¬Ø¯ÛŒØ¯
if (Math.random() < 0.005) {
  const padding = 30;

  const time = performance.now();
  if (time - lastDifficultyIncrease >= 500) { 
    speedMultiplier *= 1.01; // Ø§ÙØ²Ø§ÛŒØ´ ØªØ¯Ø±ÛŒØ¬ÛŒ Ø³Ø®ØªÛŒ Ø¨Ø§Ø²ÛŒ
    lastDifficultyIncrease = time;
  }

  // Ø§Ù†ØªØ®Ø§Ø¨ ØªÛŒÙ¾ Ø³Ø±Ø¹Øª Ø¨Ù‡ ØµÙˆØ±Øª ØªØµØ§Ø¯ÙÛŒ
  const speedTypes = {
    slow: 0.8,
    normal: 1.0,
    fast: 1.2
  };
  const typesArray = ["slow","normal","fast"];
  const chosenType = typesArray[Math.floor(Math.random()*typesArray.length)];
  const baseSpeed = speedTypes[chosenType];

  const enemy = {
    x: Math.random() * (canvas.width - 2 * padding) + padding,
    y: -60,
    w: 42,
    h: 42,
    img: enemyImages[Math.floor(Math.random() * enemyImages.length)],
    canShoot: Math.random() < 0.18,
    lastShotTime: 0,
    shotCount: 0,
    spiral: Math.random() < 0.3,
    angle: 0,
    amplitude: 60,
    speedType: chosenType,         // Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÙ¾
    speed: baseSpeed * speedMultiplier // Ø³Ø±Ø¹Øª ÙˆØ§Ù‚Ø¹ÛŒ
  };

  enemies.push(enemy);
}





// ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ®Øª Ù‡Ø± 15 Ø«Ø§Ù†ÛŒÙ‡
if (performance.now() - lastFuelSpawn > 18000) {
  fuels.push({
    x: Math.random() * (canvas.width - 80) + 40,
    y: -50,
    w: 25,
    h: 60
  });
  lastFuelSpawn = performance.now();
}



enemies.forEach((e, i) => {
   ctx.drawImage(e.img, e.x - e.w / 2, e.y - e.h / 2, e.w, e.h);
   if (e.spiral) {
  e.y += e.speed * delta;
  e.angle += 0.05 * delta; // Ø³Ø±Ø¹Øª Ú†Ø±Ø®Ø´ Ù…ÙˆØ¬
  e.x += e.baseX + Math.sin(e.angle) * 3 * delta;
} else {
  e.y += e.speed * delta;
}
// ğŸ”¹ Ø­Ø°Ù Ø¯Ø´Ù…Ù† ÙˆÙ‚ØªÛŒ 100 Ù¾ÛŒÚ©Ø³Ù„ ØªØ§ Ù¾Ø§ÛŒÛŒÙ† ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø±Ø¯
  if (e.y > canvas.height - noFlyZoneHeight) {
    enemies.splice(i, 1);
  }

// Ø´Ù„ÛŒÚ© Ø¯Ø´Ù…Ù†
if (e.canShoot) {
  const now = performance.now();
  
  // Ù‡Ø± 0.7 Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ© ØªÛŒØ±ØŒ Ø­Ø¯Ø§Ú©Ø«Ø± 4 ØªÛŒØ±
  if (now - e.lastShotTime > 700 && e.shotCount < 4) {
    enemyShoot(e);
    e.lastShotTime = now;
    e.shotCount++;
  }

  // Ø¨Ø¹Ø¯ Ø§Ø² 4 ØªÛŒØ±ØŒ ÙÙ‚Ø· 1.5 Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†
  if (e.shotCount >= 4 && now - e.lastShotTime > 1500) {
    e.shotCount = 0;
  }
}


// ğŸ¯ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø±Ø³Ù… ØªÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø´Ù…Ù† â€” Ø¨ÛŒØ±ÙˆÙ† Ø§Ø² enemies.forEach
for (let i = enemyBullets.length - 1; i >= 0; i--) {
  const b = enemyBullets[i];

  // Ø­Ø±Ú©Øª Ú¯Ù„ÙˆÙ„Ù‡ (Ø³Ø±Ø¹Øª Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ delta)
  b.y += b.vy * delta * 3;

  // Ø±Ø³Ù… Ú¯Ù„ÙˆÙ„Ù‡
  ctx.fillStyle = "white";
  ctx.fillRect(b.x - 2, b.y, 1.8, 4.2);

  // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†
  if (
    airplane.x < b.x &&
    airplane.x + airplane.w > b.x &&
    airplane.y < b.y &&
    airplane.y + airplane.h > b.y
  ) {
    explodeAirplane();
    enemyBullets.splice(i, 1);
    continue;
  }

  // Ø­Ø°Ù ØªÛŒØ± Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø±ÙˆØ¬ Ú©Ø§Ù…Ù„ Ø§Ø² ØµÙØ­Ù‡
  if (b.y > canvas.height + 50) {
    enemyBullets.splice(i, 1);
  }
}





  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ø¯Ø´Ù…Ù†
  bullets.forEach((b, j) => {
    if (
      b.x > e.x - e.w/2 &&
      b.x < e.x + e.w/2 &&
      b.y > e.y - e.h/2 &&
      b.y < e.y + e.h/2
    ) {
      createExplosion(e.x, e.y, e.w, e.h); // Ø§Ù†ÙØ¬Ø§Ø± ØªØ±Ú©ÛŒØ¨ÛŒ
      trySpawnHeartDrop(e.x, e.y);

      enemies.splice(i, 1);
      bullets.splice(j, 1);
   addScore(10, enemies.length);

    }
  });

  // âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ø¨Ø§ Ø¯Ø´Ù…Ù†
  if (
    airplane.x < e.x + e.w / 2 &&
    airplane.x + airplane.w > e.x - e.w / 2 &&
    airplane.y < e.y + e.h / 2 &&
    airplane.y + airplane.h > e.y - e.h / 2
  ) {
 // Ø§Ù†ÙØ¬Ø§Ø± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø¯Ø´Ù…Ù†
  createExplosion(e.x, e.y, e.w, e.h);
    explodeAirplane();
    enemies.splice(i, 1);
   
  }
});







// ğŸ”« Ú©Ù†ØªØ±Ù„ Ø´Ù„ÛŒÚ© Space Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ø¨Ø§Ø²ÛŒ
if (keys.space) {
  const now = performance.now();
  if (now - lastShotTime > shootDelay) {
 updateBulletGrade(score);
shootBullets();
updateAndDrawBullets();
    lastShotTime = now;
  }
}
  

  updateExplosions(delta);
  drawFuelGaugeAnimated();
  drawLives();





// ğŸ”¹ Ù‡Ø± 20 Ø«Ø§Ù†ÛŒÙ‡ ÛŒÚ© Ø´Ù‡Ø§Ø¨â€ŒØ³Ù†Ú¯ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
spawnMeteor();

for (let i = meteors.length - 1; i >= 0; i--) {
  const m = meteors[i];
  m.x += m.vx;
  m.y += m.vy;
  m.rotation += m.rotationSpeed;

  // Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± hp ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø¯Ù‡
  if (m.hp === undefined) m.hp = 10;

  // Ø±Ø³Ù… Ø´Ù‡Ø§Ø¨ Ø³Ù†Ú¯ Ø¨Ø§ Ú†Ø±Ø®Ø´
  ctx.save();
  ctx.translate(m.x + m.w / 2, m.y + m.h / 2);
  ctx.rotate((m.rotation * Math.PI) / 180);
  ctx.drawImage(m.img, -m.w / 2, -m.h / 2, m.w, m.h);
  ctx.restore();

  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú¯Ù„ÙˆÙ„Ù‡ Ø¨Ø§ Ø´Ù‡Ø§Ø¨ Ø³Ù†Ú¯
  for (let j = bullets.length - 1; j >= 0; j--) {
    const b = bullets[j];
    if (
      b.x < m.x + m.w &&
      b.x + 5 > m.x &&
      b.y < m.y + m.h &&
      b.y + 10 > m.y
    ) {
      bullets.splice(j, 1);
      m.hp--;

if (m.hp <= 0) {
  createMeteorExplosion(m.x + m.w/2, m.y + m.h/2); 
  meteors.splice(i, 1);
  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ØªØ±Ú©Ø§Ù†Ø¯Ù† Ø´Ù‡Ø§Ø¨ Ø³Ù†Ú¯
      addScore(100);
  break;
}

    }
  }

  // Ø­Ø°Ù Ø§Ú¯Ø± Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ø¯
  if (m.y > canvas.height + 100) {
    meteors.splice(i, 1);
    continue;
  }

  // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†
  if (
    airplane &&
    airplane.x < m.x + m.w &&
    airplane.x + airplane.w > m.x &&
    airplane.y < m.y + m.h &&
    airplane.y + airplane.h > m.y
  ) {
    explodeAirplane();
    meteors.splice(i, 1);
  }
}

updateMeteorExplosions(); // Ø±Ø³Ù… Ø°Ø±Ø§Øª Ø§Ù†ÙØ¬Ø§Ø± Ø´Ù‡Ø§Ø¨â€ŒØ³Ù†Ú¯
ctx.setTransform(1, 0, 0, 1, 0, 0);
cancelAnimationFrame(animationId); // animationId Ø¨Ø§ÛŒØ¯ Ù…ØªØºÛŒØ± Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø§Ø´Ø¯
animationId = null;
animationId = requestAnimationFrame(gameLoop);
} 


// ğŸ¨ ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ú¯Ø±Ù…Ø§
function updateHeatBar() {
  heatBar.style.width = `${heat}%`;

  // Ø±Ù†Ú¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ (Ø§ÙØ²ÙˆØ¯Ù†ÛŒ)
  const color = `linear-gradient(90deg,
    hsl(${120 - (heat * 1.2)}, 100%, 50%),
    hsl(${60 - (heat * 0.6)}, 100%, 50%),
    hsl(${0 + (heat * 0.1)}, 100%, 50%)
  )`;
  heatBar.style.background = color;
}

// â™»ï¸ Ø®Ù†Ú© Ø´Ø¯Ù† ØªØ¯Ø±ÛŒØ¬ÛŒ â€” Ø¯Ø± Ø­Ù„Ù‚Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ ÛŒØ§ Ø¨Ø§ setInterval
setInterval(() => {
  if (!overheated && heat > 0 && !paused) {
    heat -= heatCoolRate;
    if (heat < 0) heat = 0;
    updateHeatBar();
  }
}, 50);








// === Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ ===
// ğŸ”« Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒØ±Ù‡Ø§
function shootBullets() {
  if (airplane.hidden) return;
 if (overheated) return;

  // Ø§ÙØ²Ø§ÛŒØ´ Ú¯Ø±Ù…Ø§
  heat += heatFillRate;
  if (heat > 100) heat = 100;




  updateHeatBar();

  // Ø§Ú¯Ø± Ø¨Ù‡ Ø­Ø¯Ø§Ú©Ø«Ø± Ø±Ø³ÛŒØ¯ØŒ Ù‚ÙÙ„ Ø´Ù„ÛŒÚ© Ø¨Ù‡ Ù…Ø¯Øª Ûµ Ø«Ø§Ù†ÛŒÙ‡
  if (heat >= 100) {
    overheated = true;
    lastOverheatTime = Date.now();
    setTimeout(() => {
      overheated = false;
      heat = 0;
      updateHeatBar();
    }, overheatDuration);
    return; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ù„ÛŒÚ©
  }



// ğŸ§ Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø´Ù„ÛŒÚ©
  try {
    //const sfx = shootSound.cloneNode(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„ Ø´Ù„ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†
    sfx.volume = 0.1;
    sfx.play().catch(() => {}); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª mute
  } catch (e) {
    console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø´Ù„ÛŒÚ©:", e);
  }



  if (bulletGrade === 1) {
    bullets.push({
      x: airplane.x + airplane.w / 2,
      y: airplane.y - airplane.h / 2,
      w: 2,
      h: 6,
      color: "#FFFF00", // Ø²Ø±Ø¯ Ø·Ù„Ø§ÛŒÛŒ
      vx: 0,
      vy: -bulletSpeed,
      glow: 10
    });
  }
  else if (bulletGrade === 2) {
    // Ø¯Ùˆ ØªÛŒØ± Ø§Ø² Ø¯Ùˆ Ø¨Ø§Ù„
    bullets.push({
      x: airplane.x + 5,
      y: airplane.y -3,
      w: 2,
      h: 6,
      color: "#00FFFF", // Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù†
      vx: 0,
      vy: -bulletSpeed,
      glow: 10
    });
    bullets.push({
      x: airplane.x + airplane.w - 5,
      y: airplane.y -3,
      w: 2,
      h: 6,
      color: "#00FFFF",
      vx: 0,
      vy: -bulletSpeed,
      glow: 6
    });
  }
  else if (bulletGrade === 3) {
    // Ø³Ù‡ ØªÛŒØ±: Ù†ÙˆÚ© Ùˆ Ø¯Ùˆ Ø¨Ø§Ù„ Ø¨Ø§ Ú©Ù…ÛŒ Ø²Ø§ÙˆÛŒÙ‡
    bullets.push({
      x: airplane.x + airplane.w / 2,
      y: airplane.y,
      w: 4,
      h: 8,
      color: "#00FF00", // Ø³Ø¨Ø² Ù†Ø¦ÙˆÙ†ÛŒ
      vx: 0,
      vy: -bulletSpeed,
      glow: 10
    });
    bullets.push({
      x: airplane.x + 5,
      y: airplane.y,
      w: 3,
      h: 7,
      color: "#FF66FF", // Ø¨Ù†ÙØ´ Ù†Ø¦ÙˆÙ†ÛŒ
      vx: -0.5,
      vy: -bulletSpeed,
      glow: 8
    });
    bullets.push({
      x: airplane.x + airplane.w - 5,
      y: airplane.y,
      w: 3,
      h: 7,
      color: "#FF66FF",
      vx: 0.5,
      vy: -bulletSpeed,
      glow: 8
    });
  }
}

// ğŸ”« Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ùˆ Ø±Ø³Ù… ØªÛŒØ±Ù‡Ø§
function updateAndDrawBullets() {
  bullets.forEach((b, i) => {
    b.x += b.vx || 0;
    b.y += b.vy || -bulletSpeed;

    // Glow Ø³Ø§Ø¯Ù‡
    ctx.shadowColor = b.color;
    ctx.shadowBlur = b.glow || 0;

    // Ø±Ø³Ù… ØªÛŒØ±
    ctx.fillStyle = b.color;
    ctx.fillRect(b.x - b.w / 2, b.y, b.w, b.h);

    // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† glow Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ø§Ø´ÛŒØ§
    ctx.shadowBlur = 0;

    // Ø­Ø°Ù ØªÛŒØ± Ø®Ø§Ø±Ø¬ Ø§Ø² ØµÙØ­Ù‡
    if (b.y < -10 || b.x < -10 || b.x > canvas.width + 10) bullets.splice(i, 1);
  });
}


function enemyShoot(enemy) {
  enemyBullets.push({
    x: enemy.x,
    y: enemy.y + enemy.h / 2,
    vx: 0,
    vy: 1
  });
}

function updateMissileBtn() {
  missileBtn.innerText = `ğŸš€ ${missiles}`;
  missileBtn.disabled = missiles <= 0;
}

function launchMissile() {
  if (missiles <= 0 || !gameRunning || airplane.hidden) return;
  missiles--;
  updateMissileBtn();
  //enemyBullets = [];

  // ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ ØªØµØ§Ø¯ÙÛŒ Ø¨ÛŒÙ† Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ù…ÙˆØ´Ú©
  const missileImage = missileImages[Math.floor(Math.random() * missileImages.length)];

  // âœ¨ ØªØ¹ÛŒÛŒÙ† Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ ØªØµÙˆÛŒØ±
  let missileW = 15;
  let missileH = 30;

  if (missileImage.src.includes("mooshak.png")) {
    missileW = 20;
    missileH = 20;
  } else if (missileImage.src.includes("mooshak2.png")) {
    missileW = 14;
    missileH = 27;
  }

  // ğŸš€ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ÙˆØ´Ú© Ø¨Ù‡ Ù„ÛŒØ³Øª ÙØ¹Ø§Ù„â€ŒÙ‡Ø§
  activeMissiles.push({
    x: airplane.x + airplane.w / 2 - missileW / 2,
    y: airplane.y - missileH,
    w: missileW,
    h: missileH,
    speed: 3,
    angle: 0,
    amplitude: 50,
    prevX: airplane.x + airplane.w / 2 - missileW / 2,
    prevY: airplane.y - missileH,
    baseX: airplane.x + airplane.w / 2 - missileW / 2,
    img: missileImage // âœ… ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡
  });
}



function startGame() {
 if (explosionRunning) return; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø§Ù†ÙØ¬
  startPresence();
  window.alreadySentScore = false;
  showTopPlayerName();
  showHelpImages();
  markPlaying(); 
  lastFuelSpawn = 0; // Ø±ÛŒØ³Øª Ø²Ù…Ø§Ù† Ø³ÙˆØ®Øª

 // ğŸ”¹ Ù‡Ø± Ø¨Ø§Ø± Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÛŒØ¯ØŒ Ú†Ø±Ø®Ù‡â€ŒÛŒ Ø±ÙˆØ²/Ø´Ø¨ Ø§Ø² "Ø±ÙˆØ² Ú©Ø§Ù…Ù„" Ø¢ØºØ§Ø² Ø´ÙˆØ¯
  if (typeof dayNight !== 'undefined') {
    dayNight.start = performance.now(); // Ø§Ø² Ù‡Ù…ÛŒÙ† Ù„Ø­Ø¸Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù† â†’ Ø±ÙˆØ² Ú©Ø§Ù…Ù„
  }

  // ğŸ”¹ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙØ±ÛŒÙ… Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø±Ø§ Ù‡Ù… Ø±ÛŒØ³Øª Ú©Ù† ØªØ§ Ø­Ø±Ú©Øª Ø§Ø¨Ø±Ù‡Ø§ Ù†Ø±Ù… Ø¨Ù…Ø§Ù†Ø¯
  if (typeof drawBackground !== 'undefined') {
    drawBackground._lastTime = performance.now();
  }



  document.getElementById("finalScore").style.display = "none";
  document.getElementById("playernameDisplay").style.display = "block";
  document.getElementById("bestPlayer").style.display = "block";


  document.getElementById("heatBarContainer").style.display = "block";


  document.getElementById("airplaneArcContainer").style.display = "none";
  document.getElementById("scoreContainer").style.display = "block";
  const controlPanel = document.getElementById('controlPanel');
  controlPanel.style.display = 'block'; 
  gameOverBackground = false;
  cancelAnimationFrame(backgroundAnimation); // Ù…ØªÙˆÙ‚Ù Ú©Ù†
  airplane.hidden = false;
  pauseBtn.innerHTML = "â¸";
  lives = 3;
  difficultyMultiplier = 1;      // Ø¶Ø±ÛŒØ¨ Ø³Ø±Ø¹Øª Ø¯Ø´Ù…Ù†Ø§Ù†
  lastDifficultyIncrease = performance.now(); // Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø®ØªÛŒ


heat = 0;
overheated = false;
updateHeatBar();


  score = 0;
  document.getElementById("scoreValue").textContent = score;
  fuel = 100;
  paused = false;
  bulletSpeed = 10;
  airplane.x = canvas.width / 2 - (airplane.w)/2;
  airplane.y = canvas.height - 200;
 // âœ… Ø§ÛŒÙ†Ø¬Ø§ ØªØµÙˆÛŒØ± Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯
  airplaneImg.src = selectedPlaneImg || "plane30.png";
  enemies = [];
  bullets = [];
  fuels = []; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³ÙˆØ®Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
  enemyBullets = []; // âœ… Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø´Ù…Ù†
  lastFuelSpawn = performance.now(); // Ø±ÛŒØ³Øª ØªØ§ÛŒÙ…Ø± ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ®Øª
  missiles = 0;              // â† ØªØ¹Ø¯Ø§Ø¯ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§ ØµÙØ±
  lastMissileBonusLevel = 0; //  Ø±ÛŒØ³Øª Ø³Ø·Ø­ Ù¾Ø§Ø¯Ø§Ø´ Ù…ÙˆØ´Ú©â€ŒÙ‡Ø§
  updateMissileBtn();        // â† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡
  gameRunning = true;
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("continueBtn").style.display = "none";
  document.getElementById("exitBtn").style.display = "none";
  document.getElementById("scoreBtn").style.display = "none";
  document.getElementById("joystick").style.display = "block";
  document.getElementById("shoot").style.display = "block";
  document.getElementById("gameTitle").style.display = "none";
  document.getElementById("missileBtn").style.display = "block";
  pauseBtn.style.display = "block";
  


// ğŸ® Ø´Ø±ÙˆØ¹ Ø¢Ù‡Ù†Ú¯ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ fade-in Ù†Ø±Ù…
try {
  // ğŸ”¸ ØªÙˆÙ‚Ù Ù†Ø±Ù… Ø¢Ù‡Ù†Ú¯ Game Over Ø¯Ø± ØµÙˆØ±Øª Ù¾Ø®Ø´
  if (gameOverMusic && !gameOverMusic.paused) {
    clearInterval(fadeGameOverMusic);
    fadeGameOverMusic = setInterval(() => {
      if (gameOverMusic.volume > 0.05) {
        gameOverMusic.volume = Math.max(0, gameOverMusic.volume - 0.05);
      } else {
        gameOverMusic.pause();
        gameOverMusic.currentTime = 0;
        clearInterval(fadeGameOverMusic);
      }
    }, 150);
  }

  // ğŸ”¸ Ø´Ø±ÙˆØ¹ ÛŒØ§ Ø§Ø¯Ø§Ù…Ù‡ Ø¢Ù‡Ù†Ú¯ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ fade-in
  if (gameMusic) {
    gameMusic.currentTime = 0;
    gameMusic.play();

    clearInterval(fadeGameMusic);
    fadeGameMusic = setInterval(() => {
      if (gameMusic.volume < 0.70) {
        gameMusic.volume = Math.min(0.70, gameMusic.volume + 0.05);
      } else {
        clearInterval(fadeGameMusic);
      }
    }, 150);
  }
} catch (e) {
  console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯ Ø¨Ø§Ø²ÛŒ:", e);
}





 // Ø§Ú¯Ø± Ø­Ù„Ù‚Ù‡â€ŒÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡â€ŒÛŒ game over ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ù…ØªÙˆÙ‚ÙØ´ Ú©Ù†
  if (typeof backgroundAnimation !== 'undefined' && backgroundAnimation) {
    cancelAnimationFrame(backgroundAnimation);
    backgroundAnimation = null;
  }



  cancelAnimationFrame(animationId); // animationId Ø¨Ø§ÛŒØ¯ Ù…ØªØºÛŒØ± Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø§Ø´Ø¯
  animationId = null;
  animationId = requestAnimationFrame(gameLoop);
}


  function endGame() {
   sendScore();
    gameRunning = false;
    document.getElementById("playernameDisplay").style.display = "none";
    document.getElementById("bestPlayer").style.display = "none";
    enemies = [];
    bullets = [];
    fuels = [];
    enemyBullets = [];
    activeMissiles = [];
    explosions = [];
    gameOverBackground = true;
    animateGameOverBackground();
    stopPlaying();
  
  // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†
  //ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.getElementById("scoreContainer").style.display = "none";
  controlPanel.style.display = 'none'; 
  pauseBtn.style.display = "none";
  explosionRunning = false;
  const startBtn = document.getElementById("startBtn");
  const continueBtn = document.getElementById("continueBtn");
  const exitBtn = document.getElementById("exitBtn");
  const scoreBtn = document.getElementById("scoreBtn");
  startBtn.style.display = "block";
  exitBtn.style.display = "block";
  scoreBtn.style.display = "block";
  document.getElementById("joystick").style.display = "none";
  document.getElementById("shoot").style.display = "none";
  document.getElementById("missileBtn").style.display = "none";
  document.getElementById("heatBarContainer").style.display = "none";
  showFinalScore();
  
  


  fuelAlarmActive = false;

// ğŸ’€ Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ Ø¨Ø§ fade
try {
  // ğŸ”¸ Ù‚Ø·Ø¹ Ù†Ø±Ù… Ø¢Ù‡Ù†Ú¯ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
  if (gameMusic && !gameMusic.paused) {
    clearInterval(fadeGameMusic);
    fadeGameMusic = setInterval(() => {
      if (gameMusic.volume > 0.05) {
        gameMusic.volume = Math.max(0, gameMusic.volume - 0.05);
      } else {
        gameMusic.pause();
        gameMusic.currentTime = 0;
        clearInterval(fadeGameMusic);
      }
    }, 150);
  }

  // ğŸ”¸ Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù…ÛŒ ØªØ£Ø®ÛŒØ± Ø¢Ù‡Ù†Ú¯ Game Over Ù¾Ø®Ø´ Ø´ÙˆØ¯
  setTimeout(() => {
    if (gameOverMusic) {
      gameOverMusic.currentTime = 0;
      gameOverMusic.play();

      clearInterval(fadeGameOverMusic);
      fadeGameOverMusic = setInterval(() => {
        if (gameOverMusic.volume < 0.70) {
          gameOverMusic.volume = Math.min(0.70, gameOverMusic.volume + 0.05);
        } else {
          clearInterval(fadeGameOverMusic);
        }
      }, 150);
    }
  }, 700);
} catch (e) {
  console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯ Game Over:", e);
}


}


// ===== Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† createExplosion =====
function createExplosion(x, y, w = 50, h = 50, power = 1) {
  const particles = [];
  const numParticles = Math.min(40, Math.floor(18 + 12 * Math.min(3, Math.max(0.5, power))));
  const colors = ["#000000", "#004500", "#FFD700", "#006347", "#00B0B0", "#660000"];

  for (let i = 0; i < numParticles; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = (0.8 + Math.random() * 6) * (0.6 + 0.8 * power);

    const vx = Math.cos(angle) * speed * (0.6 + Math.random() * 0.9);
    const vy = Math.sin(angle) * speed * (0.6 + Math.random() * 0.9) - (1.5 + Math.random() * 2.5) * power;

    particles.push({
      x: x + (Math.random() - 0.5) * w * 0.5,
      y: y + (Math.random() - 0.5) * h * 0.5,
      vx,
      vy,
      w: (Math.random() * 3 + 3) * (0.6 + Math.random() * 1.2) * (0.6 + 0.2 * power),
      h: (Math.random() * 3 + 4) * (0.6 + Math.random() * 1.2) * (0.6 + 0.2 * power),
      color: colors[Math.floor(Math.random() * colors.length)],
      life: 1,
      decay: 0.015 + Math.random() * 0.03,
      drag: 0.985 - Math.random() * 0.02,
      gravity: 0.20 * (0.9 + Math.random() * 0.4) * power,
      rotation: Math.random() * 360,
      angularVelocity: (Math.random() - 0.5) * 1.2
    });
  }

  const baseImgScale = 1.9 + 0.35 * Math.min(2, power);

explosions.push({
  x: x - w / 2,
  y: y - h / 2,
  w, h,
  particles,
  fadeRate: 0.01 + Math.random() * 0.01,
  imgAlpha: 1,
  imgFadeStep: 1 / 20,
  frame: 0,           // âœ… ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ
  frameTimer: 0,      // âœ… Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ¹ÙˆÛŒØ¶ ÙØ±ÛŒÙ…
  frameDelay: 3,      // âœ… Ù‡Ø± Ú†Ù†Ø¯ ÙØ±ÛŒÙ… ÛŒÚ©â€ŒØ¨Ø§Ø± ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
  callback: null
});

// ğŸ§ Ù¾Ø®Ø´ ØªØµØ§Ø¯ÙÛŒ ØµØ¯Ø§ÛŒ Ø§Ù†ÙØ¬Ø§Ø±
  if (explosionSounds.length > 0) {
    const randomIndex = Math.floor(Math.random() * explosionSounds.length);
    const explosionSound = explosionSounds[randomIndex].cloneNode(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„ Ù¾Ø®Ø´â€ŒÙ‡Ø§
    explosionSound.volume = Math.min(1, 0.5 + power * 0.2); // Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ø¯Øª Ø§Ù†ÙØ¬Ø§Ø±
    explosionSound.play().catch(() => {}); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±
  }



  if (navigator.vibrate) navigator.vibrate(50);

}


// ===== Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† updateExplosions(delta) =====
function updateExplosions(delta) {
  for (let i = explosions.length - 1; i >= 0; i--) {
    const ex = explosions[i];


    const n = ex.particles.length;
    let avgLife = 0;
    if (n > 0) {
      let s = 0;
      for (let k = 0; k < n; k++) s += (ex.particles[k].life || 0);
      avgLife = s / n;
    }


   // ===== Ø±Ø³Ù… ØªØµÙˆÛŒØ± Ø§Ù†ÙØ¬Ø§Ø± (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² explosionImg ÛŒØ§ explosionFrames) =====
if (
  (typeof explosionImg !== "undefined" && explosionImg.complete) ||
  (typeof explosionFrames !== "undefined" && explosionFrames.length > 0)
) {
  if (typeof ex.imgAlpha === "undefined") ex.imgAlpha = 1;
  if (typeof ex.imgFadeStep === "undefined") ex.imgFadeStep = 1 / 20;

  // Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ø§ÛŒÙ† Ø§Ù†ÙØ¬Ø§Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙØ±ÛŒÙ… Ø±Ùˆ Ø¯Ø§Ø±Ù‡ (Ø¨Ø±Ø§ÛŒ Ø§Ù†ÙØ¬Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯)
  if (typeof ex.frame === "undefined") ex.frame = 0;
  if (typeof ex.frameTimer === "undefined") ex.frameTimer = 0;
  if (typeof ex.frameDelay === "undefined") ex.frameDelay = 3;

  const dynamicScale = ex.imgScale ? ex.imgScale * 1.9 : 1.9;
  const cx = ex.x + ex.w / 2;
  const cy = ex.y + ex.h / 2;
  const drawW = ex.w * dynamicScale;
  const drawH = ex.h * dynamicScale;
  const drawX = cx - drawW / 2;
  const drawY = cy - drawH / 2;

  ctx.globalAlpha = ex.imgAlpha;
  ctx.shadowColor = "rgba(255,180,100,0.9)";
  ctx.shadowBlur = 30 * ex.imgAlpha;

  // Ø§Ú¯Ø± ÙØ±ÛŒÙ…â€ŒÙ‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ù†Ø¯ØŒ ÙØ±ÛŒÙ… ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ú©Ø´
  if (typeof explosionFrames !== "undefined" && explosionFrames.length > 0) {
    const currentFrame = Math.min(explosionFrames.length - 1, Math.floor(ex.frame));
    const img = explosionFrames[currentFrame];
    if (img && img.complete) {
      ctx.drawImage(img, drawX, drawY, drawW, drawH);
    }

    // Ø§ÙØ²Ø§ÛŒØ´ ÙØ±ÛŒÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ timer
    ex.frameTimer++;
    if (ex.frameTimer >= ex.frameDelay) {
      ex.frame++;
      ex.frameTimer = 0;
    }
    // Ø§Ú¯Ø± Ø§Ø² Ø¢Ø®Ø± Ú¯Ø°Ø´ØªØŒ Ø¯Ø± Ø¢Ø®Ø±ÛŒÙ† ÙØ±ÛŒÙ… Ø¨Ù…Ø§Ù†Ø¯
    if (ex.frame >= explosionFrames.length) ex.frame = explosionFrames.length - 1;
  } else if (typeof explosionImg !== "undefined" && explosionImg.complete) {
    // Ø­Ø§Ù„Øª ØªØµÙˆÛŒØ± Ù…Ù†ÙØ±Ø¯ (fallback)
    ctx.drawImage(explosionImg, drawX, drawY, drawW, drawH);
  }

  ctx.shadowBlur = 0;

  // Ú©Ø§Ù‡Ø´ Ø¢Ù„ÙØ§ Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„
  ex.imgAlpha -= ex.imgFadeStep;
  if (ex.imgAlpha < 0) ex.imgAlpha = 0;
}

    // ----- Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ø±Ø³Ù… Ø°Ø±Ø§Øª Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø´Ú©Ù„ Ù‚Ø¨Ù„ÛŒ -----
    for (let j = ex.particles.length - 1; j >= 0; j--) {
      const p = ex.particles[j];

      // ÙÛŒØ²ÛŒÚ© (Ù…Ù‚ÛŒØ§Ø³â€ŒØ´Ø¯Ù‡ Ø¨Ø§ delta)
      p.vy += (p.gravity || 0.12) * delta;
      p.vx *= Math.pow(p.drag || 0.985, delta);
      p.vy *= Math.pow(p.drag || 0.985, delta);

      // Ø­Ø±Ú©Øª
      p.x += p.vx * delta;
      p.y += p.vy * delta;

      // Ú†Ø±Ø®Ø´
      p.rotation += (p.angularVelocity || 0) * delta;

      // Ú©Ø§Ù‡Ø´ Ø¹Ù…Ø±
      p.life -= (p.decay || 0.02) * delta;
      if (p.life < 0) p.life = 0;

      // Ú©Ù…ÛŒ Ú©ÙˆÚ†Ú©â€ŒØ´Ø¯Ù† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÙ‡Ù” Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ
      p.w *= Math.pow(0.999, delta);
      p.h *= Math.pow(0.999, delta);

      // Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ "Ø²Ù…ÛŒÙ†" (Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡)
      if (p.y > canvas.height - 2) {
        p.y = canvas.height - 2;
        p.vy *= -0.35;
        p.vx *= 0.6;
        p.life -= 0.02 * delta; // Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…Ø­Ùˆ Ø´ÙˆØ¯ Ù¾Ø³ Ø§Ø² Ù†Ø´Ø³Øª
      }

      // Ø±Ø³Ù… Ø°Ø±Ù‡ Ø¨Ø§ alpha Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± life
      ctx.save();
      ctx.globalAlpha = Math.max(0, Math.min(1, p.life));
      ctx.translate(p.x, p.y);
      ctx.rotate((p.rotation || 0) * Math.PI / 180);
      ctx.fillStyle = p.color || "#FFA500";
      ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      ctx.restore();

      // Ø­Ø°Ù Ø°Ø±Ù‡ Ø§Ú¯Ø± Ø¹Ù…Ø± ØªÙ…Ø§Ù… Ø´Ø¯ ÛŒØ§ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© Ø´Ø¯
      if (p.life <= 0.03 || p.w < 0.25 || p.h < 0.25) {
      ex.particles.splice(j, 1);
      continue;
      }
    }

    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø¬Ù…ÙˆØ¹Ù‡ ÙˆÙ‚ØªÛŒ Ø®Ø§Ù„ÛŒ Ø´Ø¯
    if (ex.particles.length === 0) {
      if (ex.callback) {
        try { ex.callback(); } catch (e) {}
      }
      explosions.splice(i, 1);
    }
  }

  ctx.globalAlpha = 1;
}


function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas(); // Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§

function explodeAirplane() {
  if (invincible) return; // Ø§Ú¯Ø± Ù…ØµÙˆÙ† Ø§Ø³ØªØŒ Ø¨ÛŒâ€ŒØªØ£Ø«ÛŒØ±
  if (paused || !gameRunning || explosionRunning) return; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ÙØ¬Ø§Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡
  explosionRunning = true;

  if (navigator.vibrate) navigator.vibrate(200);


  const x = airplane.x + airplane.w / 2;
  const y = airplane.y + airplane.h / 2;
  const w = airplane.w;
  const h = airplane.h;

  // ğŸ”¥ ØªÙˆÙ„ÛŒØ¯ Ø°Ø±Ø§Øª Ø§Ù†ÙØ¬Ø§Ø±
  const particles = [];
  const numParticles = 60;
  for (let i = 0; i < numParticles; i++) {
    particles.push({
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * 12,
      vy: (Math.random() - 0.5) * 12,
      w: Math.random() * 8 + 2,
      h: Math.random() * 8 + 2,
      color: ["orange", "red", "yellow", "gray"][Math.floor(Math.random() * 4)]
    });
  }

  explosions.push({
  x: x - w / 2,
  y: y - h / 2,
  w, h,
  alpha: 1,
  fadeRate: 0.03,
  particles: particles,
});
  // ğŸ”¹ Ú©Ù… Ú©Ø±Ø¯Ù† ÛŒÚ© Ø¬Ø§Ù†
  lives--;

// ğŸ’¥ Ú©Ø§Ù‡Ø´ Ú¯Ø±ÛŒØ¯ ØªÛŒØ± Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯Ù† Ø¬Ø§Ù†
if (typeof bulletGrade !== "undefined") {
  bulletGrade = Math.max(1, bulletGrade - 1);
}

  // ğŸ”¹ Ù†Ø§Ù¾Ø¯ÛŒØ¯ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Øª Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ø¨Ø±Ø§ÛŒ Û² Ø«Ø§Ù†ÛŒÙ‡
  airplane.hidden = true;

  // Ø§Ú¯Ø± Ù‡Ù…Ù‡â€ŒÛŒ Ø¬Ø§Ù†â€ŒÙ‡Ø§ ØªÙ…Ø§Ù… Ø´Ø¯
  if (lives <= 0) {
    setTimeout(() => {
      endGame();
    }, 2000);
  } else {
    // âœ³ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ù¾Ø³ Ø§Ø² Û² Ø«Ø§Ù†ÛŒÙ‡
    setTimeout(() => {
      airplane.x = canvas.width / 2 - 40;
      airplane.y = canvas.height - 200;
      airplane.hidden = false;
      explosionRunning = false;
      fuel = 100;

      // âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…ØµÙˆÙ†ÛŒØª Ùˆ Ú†Ø´Ù…Ú©â€ŒØ²Ù† Ø´Ø¯Ù†
      invincible = true;
      respawnTime = performance.now();

      // â— Ù¾Ø³ Ø§Ø² Û³ Ø«Ø§Ù†ÛŒÙ‡ Ù…ØµÙˆÙ†ÛŒØª ØªÙ…Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
      setTimeout(() => {
        invincible = false;
      }, 3000);
    }, 2000);
  }
}







// === Ø¬ÙˆÛŒâ€ŒØ§Ø³ØªÛŒÚ© Ù„Ù…Ø³ÛŒ ===
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let touchId = null;

joystick.addEventListener("touchstart", e=>{
  if(touchId!==null) return;
  const touch=[...e.touches].find(t=>{
    const rect=joystick.getBoundingClientRect();
    return t.clientX>=rect.left && t.clientX<=rect.right &&
           t.clientY>=rect.top && t.clientY<=rect.bottom;
  });
  if(touch) touchId=touch.identifier;
});

joystick.addEventListener("touchmove", e=>{
  if(touchId===null) return;
  let touch=[...e.touches].find(t=>t.identifier===touchId);
  if(!touch) return;
  let rect=joystick.getBoundingClientRect();
  let centerX=rect.left+rect.width/2;
  let centerY=rect.top+rect.height/2;
  let tx=touch.clientX-centerX;
  let ty=touch.clientY-centerY;
  const maxDist=40;
  const distance=Math.sqrt(tx*tx+ty*ty);
  if(distance>maxDist){
    tx=tx*maxDist/distance;
    ty=ty*maxDist/distance;
  }
  stick.style.transform=`translate(${tx}px,${ty}px)`;
  dx=tx/maxDist;
  dy=ty/maxDist;
});

joystick.addEventListener("touchend", e=>{
  const remaining=[...e.touches];
  if(!remaining.find(t=>t.identifier===touchId)){
    stick.style.transform="translate(0,0)";
    dx=0; dy=0; touchId=null;
  }
});

// === Ø´Ù„ÛŒÚ© Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† ===
shootBtn.addEventListener("touchstart", e => {
  e.preventDefault();
  if (!gameRunning) return;
 shootBtn.classList.add("recoil");
 setTimeout(() => {
        shootBtn.classList.remove("recoil");
    }, 150);
  clearInterval(shootInterval);
  updateBulletGrade(score);
  shootBullets(); // Ø´Ù„ÛŒÚ© ÙÙˆØ±ÛŒ

  //Ø´Ù„ÛŒÚ© Ù…Ø¯Ø§ÙˆÙ…
  shootInterval = setInterval(() => {
  updateBulletGrade(score); 
  shootBullets();
  }, 110);
});

shootBtn.addEventListener("touchend", e => {
  clearInterval(shootInterval);
});

shootBtn.addEventListener("touchcancel", e => {
  clearInterval(shootInterval);
});

// --- Ú©Ù„ÛŒÚ© (Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±)
shootBtn.addEventListener("mousedown", e => {
  if (!gameRunning) return;

 clearInterval(shootInterval);
 updateBulletGrade(score);
  shootBullets(); // Ø´Ù„ÛŒÚ© ÙÙˆØ±ÛŒ
 
  shootInterval = setInterval(() => {
  updateBulletGrade(score);
    shootBullets();
  }, 110);
});

shootBtn.addEventListener("mouseup", e => {
  clearInterval(shootInterval);
});

shootBtn.addEventListener("mouseleave", e => {
  clearInterval(shootInterval);
});


// === Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ===
function addTouchAndClick(id, handler){
  const el=document.getElementById(id);
  el.addEventListener("click",handler);
  el.addEventListener("touchstart",e=>{e.preventDefault(); handler();});
}

startBtn.addEventListener('click', () => { 
  startGame();
});



function updateScores(data) {
    const scoreList = document.getElementById("scoreList");
    const tbody = scoreList.querySelector('tbody');
    const wrapper = scoreList.querySelector('.table-wrap');
    const countLabel = scoreList.querySelector('.score-count');

    if (!tbody || !wrapper || !countLabel) return;

    // --- Ù†Ø±Ù…Ø§Ù„Ø§ÛŒØ² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---
    const normalized = data.map(item => ({
        playerId: item.playerId || "",
        name: item.name || "Ù†Ø§Ø´Ù†Ø§Ø³",
        score: Number(item.score || 0),
        online: Number(item.online || 0),
        status: item.status || ""
    }));

    // --- Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø§Ø² Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…ØªØ±ÛŒÙ† ---
    normalized.sort((a, b) => b.score - a.score);

    const onlineCount = normalized.filter(r => r.online === 1).length;
    countLabel.innerText = `ØªØ¹Ø¯Ø§Ø¯ Ù†ÙØ±Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ†: ${onlineCount}`;

    // Ø­ÙØ¸ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù¾Ø¯ÛŒØª
    const prevScrollTop = wrapper.scrollTop;

    // --- Ø³Ø§Ø®Øª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ ---
    let rowsHtml = '';
    normalized.forEach((row, idx) => {

        const color =
            idx === 0 ? "#FFD700" :
            idx === 1 ? "#C0C0C0" :
            idx === 2 ? "#CD7F32" : "#FFF";

        const dotColor = row.online ? "#00c853" : "#111";

        rowsHtml += `
        <tr style="background:rgba(255,255,255,0.03);">
            <td style="color:${color};font-weight:bold;">${idx + 1}</td>

            <!-- Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†: Ø´Ø§Ù…Ù„ playerId Ø¨Ø±Ø§ÛŒ Ú†Øª -->
            <td class="score-name"
                data-playerid="${row.playerId}"
                data-playername="${escapeHtml(row.name)}"
                style="color:${color}; cursor:pointer;">
                ${escapeHtml(row.name)}
            </td>

            <td style="color:${color};">${row.score}</td>

            <td style="color:${color};">
                <span class="score-dot"
                      style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${dotColor};margin-right:8px;">
                </span>
                ${escapeHtml(row.status)}
            </td>
        </tr>`;
    });

    tbody.innerHTML = rowsHtml;

    // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„
    requestAnimationFrame(() => {
        wrapper.scrollTop = prevScrollTop;
    });

    // ===============================
    //   Ø§ØªØµØ§Ù„ Ú©Ù„ÛŒÚ© Ø¨Ù‡ Ù†Ø§Ù… Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
    // ===============================
const nameCells = scoreList.querySelectorAll('.score-name');

nameCells.forEach(cell => {

  if (!cell.dataset.listenerAdded) {
    cell.addEventListener('click', () => {

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡
        window.chatReceiverId = cell.getAttribute('data-playerid');
        window.chatReceiverName = cell.getAttribute('data-playername');

        // chatKey Ù…Ø®ØµÙˆØµ Ø§ÛŒÙ† Ù…Ú©Ø§Ù„Ù…Ù‡
        const chatKey = `${window.chatSenderId}_${window.chatReceiverId}`;
        if (!window.chatState) window.chatState = {};
        if (!window.chatState[chatKey]) {
            // Ø§ÛŒØ¬Ø§Ø¯ state Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú†Øª (Ø¯Ø± Ù¾ÙˆÚ†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡)
           window.chatState[chatKey] = { lastTs: 0, seenIds: new Set(), messages: [], fetching: false };

        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† DOM Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø± Ú©Ø´ (ØªØ§ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†ÙØ± Ù‚Ø¨Ù„ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´ÙˆØ¯)
       // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† DOM Ù‚Ø¨Ù„ Ø§Ø² Ø±Ù†Ø¯Ø± Ú©Ø´ (ØªØ§ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†ÙØ± Ù‚Ø¨Ù„ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´ÙˆØ¯)
const chatListEl = document.getElementById('chatList');
if (chatListEl) chatListEl.innerHTML = '';

// Ø§Ú¯Ø± cache Ø¯Ø§Ø´ØªÛŒÙ…ØŒ Ø¢Ù† Ø±Ø§ Ø±Ù†Ø¯Ø± Ú©Ù† (Ù†Ù…Ø§ÛŒØ´ ÙÙˆØ±ÛŒ)
if (window.chatState && window.chatState[chatKey] && Array.isArray(window.chatState[chatKey].messages) && window.chatState[chatKey].messages.length > 0) {
    
} else {
    window.chatState = window.chatState || {};
    window.chatState[chatKey] = window.chatState[chatKey] || { lastTs: 0, seenIds: new Set(), messages: [], fetching: false };
    window.chatState[chatKey].lastTs = 0;
}

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª
document.getElementById('chatOverlay').style.display = 'flex';
document.getElementById('chatComposer').style.display = 'flex';

// ===== Ù…Ù‡Ù…: Ø´Ù†Ø§Ø³Ù‡ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ Ø§Ø² Ø³Ù„ÙˆÙ„ Ø¨Ú¯ÛŒØ±ØŒ **Ù‡Ø±Ú¯Ø²** Ø¢Ù† Ø±Ø§ Ø¨Ø§ playerId Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ù†Ú©Ù†
window.chatReceiverId = cell.getAttribute('data-playerid');
window.chatReceiverName = cell.getAttribute('data-playername');

// Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± (polling Ø§Ù…Ù†)
fetchChatMessagesAndRender();



    });

    cell.dataset.listenerAdded = "true";
}
});
}


//---------------------------------------------------------------------------------------------------------------------------------------


window.chatCurrentReceiver = null; // { id, name }
window.playerId = window.playerId || localStorage.getItem('bermooda_playerId') || null;
window.playerName = window.playerName || (localStorage.getItem('bermooda_playerName') || 'Ù†Ø§Ø´Ù†Ø§Ø³');

// ensureMyPlayerId: uses existing getOrCreatePlayerId() if available, otherwise fallback
function ensureMyPlayerId() {
  return new Promise((resolve) => {
    if (window.playerId) return resolve(window.playerId);
    try {
      if (typeof getOrCreatePlayerId === 'function') {
        const id = getOrCreatePlayerId();
        window.playerId = id;
        return resolve(id);
      }
    } catch(e) {}
    // fallback: try localStorage
    const stored = localStorage.getItem('bermooda_playerId');
    if (stored) { window.playerId = stored; return resolve(stored); }
    // last fallback: generate simple id
    const newId = 'p_' + Date.now();
    try { localStorage.setItem('bermooda_playerId', newId); } catch(e){}
    window.playerId = newId;
    resolve(newId);
  });
}

//---------------------------------------------------------------------------------------------------------------------------------------




let scoreInterval = null;

function fetchScores(showLoading = false) {
  const scoreList = document.getElementById("scoreList");

  // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
  if (showLoading) {
    scoreList.innerHTML = "<div style='font-size:20px;color:#00FF00;'>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>";
  }

  // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ÙˆØ¨ Ø§Ù¾ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª
  fetch(SHEET_WEBAPP)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        if (data.players && Array.isArray(data.players)) {
          data = data.players;
        } else {
          return; // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø´ØªØ¨Ø§Ù‡ Ù‡Ø³ØªÙ†Ø¯
        }
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³Ú©Ù„Øª Ø¬Ø¯ÙˆÙ„ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
      if (!scoreList.querySelector('table')) {
        scoreList.innerHTML = `
          <div class="score-count" style="color:#00FF00;font-weight:bold;margin-bottom:8px;text-align:center;">
            ØªØ¹Ø¯Ø§Ø¯ Ù†ÙØ±Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ†: 0
          </div>
          <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
            <table style="width:100%;border-collapse:collapse;table-layout:fixed;text-align:center;">
              <thead style="background:#111;color:#00FF00;position:sticky;top:0;z-index:2;">
                <tr>
                  <th style="width:15%;">Ø±ØªØ¨Ù‡</th>
                  <th style="width:40%;">Ù†Ø§Ù…</th>
                  <th style="width:20%;">Ø§Ù…ØªÛŒØ§Ø²</th>
                  <th style="width:25%;">ÙˆØ¶Ø¹ÛŒØª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        `;
      }

      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ù†ÙØ±Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ†
      const onlinePlayers = data.filter(player => player.online === 1).length;
      const scoreCount = scoreList.querySelector('.score-count');
      scoreCount.textContent = `ØªØ¹Ø¯Ø§Ø¯ Ù†ÙØ±Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ†: ${onlinePlayers}`;

      // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„
      updateScores(data);

    })
    .catch(err => {
      console.error(err);
      scoreList.innerHTML = "<div style='color:red;'>âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>";
    });
}





// Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª
document.getElementById("scoreBtn").addEventListener("click", () => {
  stopPlaying();
  document.getElementById("scoreOverlay").style.display = "flex";
  fetchScores(true); // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÙ‚Ø· Ø¨Ø§Ø± Ø§ÙˆÙ„
  scoreInterval = setInterval(() => fetchScores(false), 500); 
});

// Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡
document.getElementById("closeScoreBtn").addEventListener("click", () => {
  document.getElementById("scoreOverlay").style.display = "none";
  if (scoreInterval) {
    clearInterval(scoreInterval);
    scoreInterval = null;
  }
});

// escape helper
function escapeHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}



addTouchAndClick("shoot",shootBullets)
addTouchAndClick("missileBtn", launchMissile);
window.addEventListener("resize",()=>{
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
});


// Ø¨Ø³ØªÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¨Ú©â€ŒØ¯Ø±Ø§Ù¾
(function(){
  try {
    const bd = document.getElementById('chatBackdrop');
    if (bd) {
      bd.addEventListener('click', function(){ 
        const ov = document.getElementById('chatOverlay');
        if (ov) ov.style.display = 'none';
      }, {passive:true});
    }
  } catch(e){}
})();


</script>
</body>
</html>




